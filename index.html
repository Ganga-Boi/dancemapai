<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DanceMap</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; color: #fff; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    header { text-align: center; padding: 30px 0; }
    header h1 { font-size: 2rem; margin-bottom: 8px; background: linear-gradient(90deg, #e94560, #ff6b6b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    header p { color: #8892b0; }
    .status-bar { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; font-size: 0.8rem; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ff4444; display: inline-block; margin-right: 5px; }
    .status-dot.connected { background: #44ff44; }
    .quick-actions { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; justify-content: center; }
    .quick-btn { padding: 10px 16px; border: none; border-radius: 20px; background: rgba(255,255,255,0.1); color: #fff; cursor: pointer; }
    .quick-btn:hover { background: rgba(233,69,96,0.6); }
    .quick-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .chat-container { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; min-height: 400px; max-height: 500px; overflow-y: auto; margin-bottom: 20px; }
    .message { margin-bottom: 16px; padding: 12px 16px; border-radius: 12px; line-height: 1.5; }
    .user-message { background: linear-gradient(135deg, #e94560, #ff6b6b); margin-left: 40px; text-align: right; }
    .bot-message { background: rgba(255,255,255,0.1); margin-right: 40px; }
    .bot-message.error { background: rgba(255,68,68,0.2); border: 1px solid rgba(255,68,68,0.4); }
    .bot-message.welcome { background: rgba(68,255,68,0.1); border: 1px solid rgba(68,255,68,0.2); }
    .bot-message.empty { background: rgba(255,193,7,0.1); border: 1px solid rgba(255,193,7,0.2); }
    .input-container { display: flex; gap: 10px; }
    #message-input { flex: 1; padding: 14px 18px; border: none; border-radius: 25px; background: rgba(255,255,255,0.1); color: #fff; font-size: 1rem; outline: none; }
    #message-input::placeholder { color: rgba(255,255,255,0.5); }
    #send-btn { padding: 14px 24px; border: none; border-radius: 25px; background: linear-gradient(135deg, #e94560, #ff6b6b); color: #fff; cursor: pointer; font-weight: 600; }
    #send-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    #load-more-btn { display: block; margin: 10px auto; padding: 10px 20px; border: 1px solid rgba(255,255,255,0.3); border-radius: 20px; background: transparent; color: #fff; cursor: pointer; }
    .hidden { display: none !important; }
    .config-error { background: rgba(255,68,68,0.2); border: 2px solid #ff4444; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px; }
    .feed-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
    .feed-toggle { width: 100%; padding: 12px; border: 1px dashed rgba(255,255,255,0.3); border-radius: 12px; background: transparent; color: #fff; cursor: pointer; }
    .feed-form { margin-top: 15px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 12px; }
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; margin-bottom: 5px; font-size: 0.85rem; color: #8892b0; }
    .form-group input { width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(0,0,0,0.2); color: #fff; }
    .form-row { display: flex; gap: 10px; }
    .form-row .form-group { flex: 1; }
    .feed-submit { width: 100%; padding: 12px; border: none; border-radius: 8px; background: linear-gradient(135deg, #e94560, #ff6b6b); color: #fff; font-weight: 600; cursor: pointer; }
    #feed-result { margin-top: 10px; padding: 10px; border-radius: 8px; text-align: center; }
    #feed-result.success { background: rgba(68,255,68,0.1); color: #44ff44; }
    #feed-result.error { background: rgba(255,68,68,0.1); color: #ff4444; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ’ƒ DanceMap</h1>
      <p>Find danseevents i KÃ¸benhavn</p>
    </header>
    <div class="status-bar">
      <span><span class="status-dot" id="status-dot"></span><span id="status-text">Forbinder...</span></span>
    </div>
    <div id="config-error" class="config-error hidden"></div>
    <div class="quick-actions">
      <button class="quick-btn" data-action="all">Alle events</button>
      <button class="quick-btn" data-action="salsa">Salsa</button>
      <button class="quick-btn" data-action="bachata">Bachata</button>
      <button class="quick-btn" data-action="kizomba">Kizomba</button>
      <button class="quick-btn" data-action="today">I dag</button>
      <button class="quick-btn" data-action="weekend">Weekend</button>
    </div>
    <div class="chat-container" id="chat-container"></div>
    <button id="load-more-btn" class="hidden">Vis flere</button>
    <div class="input-container">
      <input type="text" id="message-input" placeholder="SÃ¸g efter events...">
      <button id="send-btn">SÃ¸g</button>
    </div>
    <div class="feed-section">
      <button class="feed-toggle" id="feed-toggle">âœ¨ TilfÃ¸j nyt event</button>
      <form class="feed-form hidden" id="feed-form">
        <h3 style="margin-bottom:15px;">Indsend event</h3>
        <div class="form-row">
          <div class="form-group"><label>Dato *</label><input type="date" name="dato" required></div>
          <div class="form-group"><label>Tid *</label><input type="time" name="starttid" value="20:00" required></div>
        </div>
        <div class="form-group"><label>Dansetype *</label><input type="text" name="dansetype" required></div>
        <div class="form-group"><label>Sted *</label><input type="text" name="sted" required></div>
        <div class="form-group"><label>Adresse</label><input type="text" name="adresse"></div>
        <div class="form-row">
          <div class="form-group"><label>By</label><input type="text" name="by" value="KÃ¸benhavn"></div>
          <div class="form-group"><label>Pris</label><input type="text" name="pris"></div>
        </div>
        <button type="submit" class="feed-submit">Send</button>
        <div id="feed-result" class="hidden"></div>
      </form>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- KONFIGURATION: INDSÃ†T DIN APPS SCRIPT URL HER                   -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <script>
    window.WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwl9mCXSa7dLqnGCgPM_4Mytz0Ru0zzDTKVXgwBp7lDTLSoTfY0w9J_d8J9SOwShLwy/exec';
  </script>
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

  <script src="dancemap-client.js"></script>
  <script>
    (function() {
      const chat = document.getElementById('chat-container');
      const input = document.getElementById('message-input');
      const sendBtn = document.getElementById('send-btn');
      const loadMoreBtn = document.getElementById('load-more-btn');
      const statusDot = document.getElementById('status-dot');
      const statusText = document.getElementById('status-text');
      const configError = document.getElementById('config-error');
      const feedToggle = document.getElementById('feed-toggle');
      const feedForm = document.getElementById('feed-form');
      const feedResult = document.getElementById('feed-result');

      function showError(msg) {
        configError.textContent = msg;
        configError.classList.remove('hidden');
        sendBtn.disabled = true;
        input.disabled = true;
        document.querySelectorAll('.quick-btn').forEach(b => b.disabled = true);
      }

      function setStatus(ok) {
        statusDot.classList.toggle('connected', ok);
        statusText.textContent = ok ? 'Forbundet' : 'Ikke forbundet';
      }

      function addMsg(text, cls) {
        if (!text) return;
        const d = document.createElement('div');
        d.className = 'message ' + cls;
        d.innerHTML = text.replace(/\n/g, '<br>');
        chat.appendChild(d);
        chat.scrollTop = chat.scrollHeight;
      }

      function clearChat() {
        chat.innerHTML = '';
        loadMoreBtn.classList.add('hidden');
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // INIT - DENNE BLOK KÃ˜RER FÃ˜R NOGET ANDET
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      if (typeof window.WEB_APP_URL === 'undefined' || !window.WEB_APP_URL) {
        showError('FEJL: WEB_APP_URL er ikke defineret.');
        return;
      }

      try {
        DanceMapClient.init(window.WEB_APP_URL, {
          callbacks: {
            onWelcome: r => { clearChat(); addMsg(r.text, 'bot-message welcome'); },
            onSearch: r => { clearChat(); addMsg(r.text, 'bot-message'); loadMoreBtn.classList.toggle('hidden', !r.hasMore); },
            onEmpty: r => { addMsg(r.text, 'bot-message empty'); loadMoreBtn.classList.add('hidden'); },
            onPagination: r => { addMsg(r.text, 'bot-message'); loadMoreBtn.classList.toggle('hidden', !r.hasMore); },
            onFeed: r => { feedResult.className = r.success ? 'success' : 'error'; feedResult.textContent = r.text; feedResult.classList.remove('hidden'); if(r.success) feedForm.reset(); },
            onError: r => { addMsg(r.text, 'bot-message error'); setStatus(false); }
          }
        });
      } catch (e) {
        showError('Init fejl: ' + e.message);
        return;
      }

      // Test forbindelse
      DanceMapClient.ping().then(r => {
        setStatus(r.success);
        if (r.success) DanceMapClient.loadInitial();
        else showError('Kunne ikke forbinde til backend.');
      });

      // Event handlers
      sendBtn.onclick = async () => {
        const msg = input.value.trim();
        if (!msg) return;
        input.value = '';
        addMsg(msg, 'user-message');
        await DanceMapClient.sendMessage(msg);
      };

      input.onkeypress = e => { if (e.key === 'Enter') sendBtn.click(); };

      document.querySelectorAll('.quick-btn').forEach(btn => {
        btn.onclick = async () => { clearChat(); await DanceMapClient.quickAction(btn.dataset.action); };
      });

      loadMoreBtn.onclick = async () => { loadMoreBtn.classList.add('hidden'); await DanceMapClient.loadMore(); };

      feedToggle.onclick = () => feedForm.classList.toggle('hidden');

      feedForm.onsubmit = async e => {
        e.preventDefault();
        const fd = new FormData(e.target);
        await DanceMapClient.submitEvent(Object.fromEntries(fd));
      };
    })();
  </script>
</body>
</html>
