<!-- index.html — TRIN 8.2 UI v1.0 (Frontend) -->
<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DanceMap</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0f14; color:#e8eef7; }
    .wrap { max-width: 820px; margin: 0 auto; padding: 18px 14px 22px; }
    .title { display:flex; align-items:baseline; justify-content:space-between; gap:12px; margin: 6px 0 14px; }
    .title h1 { margin:0; font-size: 20px; font-weight: 650; letter-spacing: .2px; }
    .title .sub { opacity:.75; font-size: 13px; }
    .card { background:#0f1620; border:1px solid #1a2432; border-radius: 14px; overflow:hidden; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .chat { padding: 14px; height: min(62vh, 540px); overflow:auto; }
    .row { display:flex; margin: 10px 0; }
    .row.user { justify-content:flex-end; }
    .row.bot { justify-content:flex-start; }
    .bubble { max-width: 92%; padding: 10px 12px; border-radius: 14px; line-height: 1.35; white-space: pre-wrap; word-wrap: break-word; border:1px solid transparent; }
    .user .bubble { background:#142235; border-color:#233955; }
    .bot .bubble { background:#0c121a; border-color:#1a2432; }
    .meta { margin-top: 6px; font-size: 12px; opacity:.7; display:flex; gap:10px; align-items:center; }
    .bar { display:flex; gap:10px; padding: 12px; border-top:1px solid #1a2432; background:#0e141d; }
    input[type="text"] { flex:1; border-radius: 12px; border:1px solid #1a2432; background:#0b1017; color:#e8eef7; padding: 12px 12px; outline:none; }
    input[type="text"]:focus { border-color:#2a3b54; }
    button { border-radius: 12px; border:1px solid #1a2432; background:#101a26; color:#e8eef7; padding: 12px 14px; cursor:pointer; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .actions { display:flex; gap:10px; padding: 0 12px 12px; }
    .hint { padding: 10px 12px 12px; font-size: 12px; opacity:.7; }
    .hr { height:1px; background:#1a2432; margin: 10px 0 0; }
    a { color:#9fc5ff; text-decoration:none; }
    a:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <h1>DanceMap</h1>
      <div class="sub">Kun danseevents i København</div>
    </div>

    <div class="card">
      <div id="chat" class="chat" aria-live="polite"></div>

      <div class="actions">
        <button id="moreBtn" type="button" disabled>Vis flere</button>
        <div class="meta">
          <span id="statusText"></span>
        </div>
      </div>

      <div class="bar">
        <input id="q" type="text" placeholder="Skriv fx: salsa i dag" autocomplete="off" />
        <button id="sendBtn" type="button">Send</button>
      </div>

      <div class="hint">
        Gyldige eksempler: “salsa i dag”, “bachata i weekenden”, “events næste uge”.
      </div>
    </div>
  </div>

  <script>
    // TRIN 8.2: Indsæt din Apps Script Web App URL her:
    // Eksempel: https://script.google.com/macros/s/XXXXX/exec
    const API_URL = 'https://script.google.com/macros/s/AKfycbw-zzGb2H_JqfNLQvtzLNm01oJ7KDIP1IigC-PPBGvMwOTMTpXg9YDrS5YPNwCC4v1L/exec';

    const chatEl = document.getElementById('chat');
    const qEl = document.getElementById('q');
    const sendBtn = document.getElementById('sendBtn');
    const moreBtn = document.getElementById('moreBtn');
    const statusText = document.getElementById('statusText');

    let lastQuery = '';
    let currentPage = 0;
    let hasMore = false;
    let isLoading = false;

    function addMessage(role, text) {
      const row = document.createElement('div');
      row.className = 'row ' + role;

      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      bubble.textContent = text;

      row.appendChild(bubble);
      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function setLoading(on, label) {
      isLoading = on;
      sendBtn.disabled = on;
      moreBtn.disabled = on || !hasMore;
      statusText.textContent = label || '';
    }

    async function callApi(query, page) {
      const url = new URL(API_URL);
      url.searchParams.set('query', query);
      url.searchParams.set('page', String(page));

      const res = await fetch(url.toString(), { method: 'GET' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return await res.json();
    }

    async function runQuery(query, page, isMore) {
      const trimmed = (query || '').trim();
      if (!trimmed) return;

      if (!isMore) {
        addMessage('user', trimmed);
        lastQuery = trimmed;
        currentPage = 0;
        hasMore = false;
        moreBtn.disabled = true;
      }

      setLoading(true, 'Henter…');

      try {
        const data = await callApi(trimmed, page);

        // API-kontrakt TRIN 8.1: { success, text, hasMore }
        if (!data || typeof data.success !== 'boolean') {
          addMessage('bot', 'Der opstod en teknisk fejl. Prøv igen senere.');
          hasMore = false;
          return;
        }

        if (!data.success) {
          addMessage('bot', data.text || 'Der opstod en teknisk fejl. Prøv igen senere.');
          hasMore = false;
          return;
        }

        addMessage('bot', data.text || 'Der er ingen danseevents, der matcher din forespørgsel.');
        hasMore = !!data.hasMore;
        moreBtn.disabled = !hasMore;
        if (hasMore) statusText.textContent = 'Der er flere events.';
      } catch (e) {
        addMessage('bot', 'Der opstod en teknisk fejl. Prøv igen senere.');
        hasMore = false;
      } finally {
        setLoading(false, hasMore ? 'Der er flere events.' : '');
      }
    }

    sendBtn.addEventListener('click', () => {
      if (isLoading) return;
      runQuery(qEl.value, 0, false);
      qEl.value = '';
      qEl.focus();
    });

    qEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendBtn.click();
      }
    });

    moreBtn.addEventListener('click', () => {
      if (isLoading || !hasMore) return;
      currentPage += 1;
      runQuery(lastQuery, currentPage, true);
    });

    // Starttekst (ingen smalltalk)
    addMessage('bot', 'Jeg viser kun danseevents i København. Prøv fx "salsa i dag".');
  </script>
</body>
</html>
