<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>DanceMap</title>

  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#6366f1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background:#0d1117;
      color:#e6edf3;
      margin:0;
      display:flex;
      justify-content:center;
      padding:16px;
    }
    .card {
      background:#161b22;
      border-radius:20px;
      max-width:420px;
      width:100%;
      display:flex;
      flex-direction:column;
      max-height:90vh;
    }
    .header {
      padding:20px;
      border-bottom:1px solid #21262d;
    }
    .header h1 { margin:0; font-size:18px; }
    .header .sub { font-size:13px; color:#7d8590; }
    .header .week-count { margin-top:6px; font-size:12px; color:#6366f1; }

    .chat {
      flex:1;
      overflow-y:auto;
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .msg.user { align-self:flex-end; }
    .msg.bot { align-self:flex-start; }

    .bubble {
      background:#21262d;
      padding:12px 16px;
      border-radius:16px;
      font-size:14px;
      max-width:90%;
      line-height:1.5;
    }
    .msg.user .bubble {
      background:#2d333b;
    }

    .input-area {
      border-top:1px solid #21262d;
      padding:16px;
      display:flex;
      gap:12px;
    }
    input {
      flex:1;
      padding:14px;
      border-radius:12px;
      border:1px solid #30363d;
      background:#0d1117;
      color:#e6edf3;
      font-size:14px;
    }
    button {
      background:#6366f1;
      border:none;
      border-radius:12px;
      color:white;
      padding:0 16px;
      cursor:pointer;
    }
  </style>
</head>

<body>
<div class="card">
  <div class="header">
    <h1>DanceMap</h1>
    <div class="sub">Danseevents i København</div>
    <div class="week-count" id="weekCount"></div>
  </div>

  <div id="chat" class="chat"></div>

  <div class="input-area">
    <input id="q" placeholder="Søg efter salsa eller bachata" autocomplete="off" />
    <button id="sendBtn">Søg</button>
  </div>
</div>

<script>
const API = 'https://script.google.com/macros/s/AKfycbxnZiO0bDkCrrwGJXwAvA5mWKPBoQoL-t1smx5m0A5j51gSbTOtF1MLT3qkdwbZkTX_/exec';
const chat = document.getElementById('chat');
const input = document.getElementById('q');
const sendBtn = document.getElementById('sendBtn');

function addMsg(text, isUser) {
  const div = document.createElement('div');
  div.className = 'msg ' + (isUser ? 'user' : 'bot');
  div.innerHTML = `<div class="bubble">${text.replace(/\n/g,'<br>')}</div>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function jsonp(url) {
  return new Promise((resolve, reject) => {
    const cb = 'cb_' + Date.now();
    window[cb] = data => {
      delete window[cb];
      script.remove();
      resolve(data);
    };
    const script = document.createElement('script');
    script.src = url + '&callback=' + cb;
    script.onerror = () => reject();
    document.body.appendChild(script);
  });
}

async function search() {
  const q = input.value.trim();
  if (!q) return;
  addMsg(q, true);
  input.value = '';
  try {
    const data = await jsonp(API + '?query=' + encodeURIComponent(q));
    addMsg(data.text || 'Ingen resultater.', false);
  } catch {
    addMsg('Teknisk fejl. Prøv igen.', false);
  }
}

sendBtn.onclick = search;
input.onkeydown = e => { if (e.key === 'Enter') search(); };

// Intro-besked (RETTET)
addMsg('Søg efter salsa eller bachata', false);

// Weekcount
(async () => {
  try {
    const data = await jsonp(API + '?action=weekcount');
    if (data.success && data.count > 0) {
      document.getElementById('weekCount').textContent =
        data.count + ' events denne uge';
    }
  } catch {}
})();
</script>
</body>
</html>
