<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DanceMap</title>

  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #0b0f14;
      color: #e8eef7;
    }

    .wrap {
      max-width: 480px;
      margin: 0 auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      padding: 14px 16px;
      border-bottom: 1px solid #1a2432;
      background: #0e141d;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .header-text h1 {
      margin: 0 0 2px;
      font-size: 18px;
      font-weight: 600;
    }

    .header-text .sub {
      font-size: 12px;
      opacity: .65;
    }

    .chat {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .row { display: flex; }
    .row.user { justify-content: flex-end; }
    .row.bot { justify-content: flex-start; }

    .bubble {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 16px;
      line-height: 1.4;
      white-space: pre-wrap;
      font-size: 14px;
    }

    .user .bubble {
      background: #1e3a5f;
      border-bottom-right-radius: 4px;
    }

    .bot .bubble {
      background: #1a2432;
      border-bottom-left-radius: 4px;
    }

    .typing .bubble {
      font-style: italic;
      opacity: .6;
    }

    .more-btn {
      align-self: flex-start;
      padding: 8px 14px;
      font-size: 13px;
      background: #0e141d;
      border: 1px solid #2a3b54;
      border-radius: 12px;
      color: #9fc5ff;
      cursor: pointer;
    }

    .bar {
      display: flex;
      gap: 10px;
      padding: 12px 16px;
      border-top: 1px solid #1a2432;
      background: #0e141d;
    }

    .bar input {
      flex: 1;
      padding: 12px 14px;
      border-radius: 20px;
      border: 1px solid #1a2432;
      background: #0b1017;
      color: #e8eef7;
      font-size: 14px;
      outline: none;
    }

    .send-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: #1e3a5f;
      color: #e8eef7;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="header">
    <img class="header-avatar" src="./dancemap-icon.svg" alt="DanceMap" />
    <div class="header-text">
      <h1>DanceMap</h1>
      <div class="sub">Kun danseevents i København</div>
    </div>
  </div>

  <div id="chat" class="chat"></div>

  <div class="bar">
    <input id="q" type="text" placeholder='Skriv fx: "salsa i dag"' autocomplete="off" />
    <button id="sendBtn" class="send-btn">➤</button>
  </div>

</div>

<script>
  const API_URL =
    'https://script.google.com/macros/s/AKfycbxnZiO0bDkCrrwGJXwAvA5mWKPBoQoL-t1smx5m0A5j51gSbTOtF1MLT3qkdwbZkTX_/exec';

  const chatEl = document.getElementById('chat');
  const qEl = document.getElementById('q');
  const sendBtn = document.getElementById('sendBtn');

  let lastQuery = '';
  let page = 0;
  let hasMore = false;
  let loading = false;
  let moreBtn = null;
  let typingRow = null;

  function addRow(type, text) {
    const row = document.createElement('div');
    row.className = 'row ' + type;
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;
    row.appendChild(bubble);
    chatEl.appendChild(row);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function showTyping() {
    hideTyping();
    const row = document.createElement('div');
    row.className = 'row bot typing';
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = 'DanceMap skriver …';
    row.appendChild(bubble);
    chatEl.appendChild(row);
    typingRow = row;
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function hideTyping() {
    if (typingRow) typingRow.remove();
    typingRow = null;
  }

  function addMoreButton() {
    if (moreBtn) moreBtn.remove();
    moreBtn = document.createElement('button');
    moreBtn.className = 'more-btn';
    moreBtn.textContent = 'Vis flere';
    moreBtn.onclick = loadMore;
    chatEl.appendChild(moreBtn);
  }

  async function callApi(q, p) {
    const url = new URL(API_URL);
    url.searchParams.set('query', q);
    url.searchParams.set('page', p);
    const res = await fetch(url.toString());
    return await res.json();
  }

  async function send() {
    if (loading) return;
    const text = qEl.value.trim();
    if (!text) return;

    addRow('user', text);
    qEl.value = '';
    lastQuery = text;
    page = 0;
    hasMore = false;
    loading = true;

    showTyping();

    try {
      const data = await callApi(text, 0);
      hideTyping();

      if (!data || !data.success) {
        addRow('bot', 'Der opstod en teknisk fejl.');
        return;
      }

      addRow('bot', data.text || 'Ingen events fundet.');
      hasMore = !!data.hasMore;
      if (hasMore) addMoreButton();

    } finally {
      loading = false;
    }
  }

  async function loadMore() {
    if (loading || !hasMore) return;
    loading = true;
    page++;
    showTyping();

    try {
      const data = await callApi(lastQuery, page);
      hideTyping();

      if (!data || !data.success) return;

      addRow('bot', data.text);
      hasMore = !!data.hasMore;
      if (!hasMore && moreBtn) moreBtn.remove();

    } finally {
      loading = false;
    }
  }

  sendBtn.onclick = send;
  qEl.addEventListener('keydown', e => {
    if (e.key === 'Enter') send();
  });

  addRow('bot',
    'Jeg viser danseevents i København.\n' +
    'Søg fx: "salsa i dag", "bachata i weekenden".'
  );
</script>
</body>
</html>
