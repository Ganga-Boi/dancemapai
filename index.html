<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>DanceMap</title>
  <style>
    :root { --bg: #0b0f14; --card: #0e141d; --border: #1a2432; --accent: #1e3a5f; --text: #e8eef7; --muted: #8899aa; }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); font-size: 20px; line-height: 1.5; }
    
    .wrap { max-width: 600px; margin: 0 auto; height: 100%; height: 100dvh; display: flex; flex-direction: column; }
    
    .header { padding: 20px 24px; border-bottom: 1px solid var(--border); background: var(--card); display: flex; align-items: center; gap: 16px; }
    .header-avatar { width: 56px; height: 56px; border-radius: 50%; cursor: pointer; }
    .header-text h1 { font-size: 24px; font-weight: 600; }
    .header-text .sub { font-size: 16px; color: var(--muted); }
    
    .chat { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 20px; -webkit-overflow-scrolling: touch; }
    .row { display: flex; }
    .row.user { justify-content: flex-end; }
    .row.bot { justify-content: flex-start; }
    .bubble { max-width: 90%; padding: 18px 22px; border-radius: 24px; font-size: 19px; line-height: 1.7; white-space: pre-wrap; }
    .user .bubble { background: var(--accent); border-bottom-right-radius: 8px; }
    .bot .bubble { background: var(--card); border: 1px solid var(--border); border-bottom-left-radius: 8px; }
    .typing .bubble { color: var(--muted); }
    
    .more-btn { align-self: flex-start; padding: 16px 28px; border-radius: 16px; border: 1px solid var(--border); background: var(--card); color: #9fc5ff; font-size: 18px; font-weight: 500; cursor: pointer; }
    .more-btn:active { background: var(--accent); }
    
    .bar { display: flex; gap: 14px; padding: 20px 24px; border-top: 1px solid var(--border); background: var(--card); }
    .bar input { flex: 1; padding: 20px 24px; border-radius: 28px; border: 2px solid var(--border); background: var(--bg); color: var(--text); font-size: 20px; outline: none; }
    .bar input:focus { border-color: var(--accent); }
    .bar input::placeholder { color: var(--muted); }
    .send-btn { width: 64px; height: 64px; border-radius: 50%; border: none; background: var(--accent); color: var(--text); cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .send-btn:active { transform: scale(0.95); background: #2a4a70; }
    .send-btn svg { width: 28px; height: 28px; }
    
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.85); z-index: 100; align-items: flex-end; justify-content: center; }
    .modal-overlay.open { display: flex; }
    .modal { width: 100%; max-width: 600px; background: var(--card); border-top-left-radius: 28px; border-top-right-radius: 28px; padding: 28px 24px 36px; max-height: 92vh; overflow-y: auto; }
    
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .modal-header h2 { font-size: 24px; font-weight: 600; }
    .modal-close { background: none; border: none; color: #9fc5ff; font-size: 40px; cursor: pointer; padding: 0; line-height: 1; }
    
    .upload-row { margin-bottom: 20px; }
    .upload-btn { width: 100%; padding: 20px; border-radius: 16px; border: 2px dashed var(--border); background: transparent; color: #9fc5ff; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; }
    .upload-btn:active { background: var(--accent); border-color: var(--accent); }
    .upload-btn svg { width: 26px; height: 26px; }
    
    .image-preview { max-width: 100%; max-height: 180px; border-radius: 14px; margin-bottom: 16px; display: none; }
    .ocr-status { font-size: 16px; color: #9fc5ff; text-align: center; padding: 14px; }
    
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-size: 17px; margin-bottom: 10px; color: var(--muted); }
    .form-group textarea { width: 100%; min-height: 200px; padding: 20px; border-radius: 16px; border: 2px solid var(--border); background: var(--bg); color: var(--text); font-size: 18px; outline: none; resize: vertical; line-height: 1.6; }
    .form-group textarea:focus { border-color: var(--accent); }
    
    .checkbox-group { display: flex; align-items: center; gap: 14px; margin-bottom: 24px; padding: 18px 20px; background: var(--bg); border-radius: 14px; }
    .checkbox-group input[type="checkbox"] { width: 28px; height: 28px; accent-color: #1e88e5; flex-shrink: 0; }
    .checkbox-group label { font-size: 18px; cursor: pointer; }
    
    .submit-btn { width: 100%; padding: 22px; border-radius: 16px; border: none; background: var(--accent); color: var(--text); font-size: 20px; font-weight: 600; cursor: pointer; }
    .submit-btn:active { transform: scale(0.98); }
    .submit-btn:disabled { opacity: 0.5; }
    
    .submit-status { text-align: center; padding: 16px; font-size: 18px; margin-top: 16px; border-radius: 14px; }
    .submit-status.success { color: #4ade80; background: rgba(74,222,128,0.15); }
    .submit-status.error { color: #ff6b6b; background: rgba(255,107,107,0.15); }
    
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .loading { animation: pulse 1s ease-in-out infinite; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <img class="header-avatar" src="./dancemap-icon.svg" alt="DanceMap" />
    <div class="header-text">
      <h1>DanceMap</h1>
      <div class="sub">Danseevents i København</div>
    </div>
  </div>

  <div id="chat" class="chat"></div>

  <div class="bar">
    <input id="q" type="text" placeholder="Søg fx: salsa i dag" autocomplete="off" enterkeyhint="search" />
    <button id="sendBtn" class="send-btn" type="button">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
    </button>
  </div>
</div>

<div class="modal-overlay" id="adminModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Tilføj Event</h2>
      <button class="modal-close" id="closeAdmin">&times;</button>
    </div>
    <div class="upload-row">
      <button type="button" class="upload-btn" id="uploadBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
        Upload billede
      </button>
      <input type="file" id="fileInput" accept="image/*" style="display:none" />
    </div>
    <img id="imagePreview" class="image-preview" />
    <div id="ocrStatus" class="ocr-status" style="display:none"></div>
    <div class="form-group">
      <label>Paste tekst eller billede (Ctrl+V)</label>
      <textarea id="adminPayload" placeholder="Paste event-tekst her..."></textarea>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="recurringCheck" />
      <label for="recurringCheck">Gentager ugentligt</label>
    </div>
    <button type="button" class="submit-btn" id="adminSubmitBtn">Tilføj Event</button>
    <div id="adminStatus" class="submit-status" style="display:none"></div>
  </div>
</div>

<script>
const API = 'https://script.google.com/macros/s/AKfycbxnZiO0bDkCrrwGJXwAvA5mWKPBoQoL-t1smx5m0A5j51gSbTOtF1MLT3qkdwbZkTX_/exec';
const $ = id => document.getElementById(id);
const chat = $('chat'), input = $('q'), sendBtn = $('sendBtn');
const modal = $('adminModal'), payload = $('adminPayload'), status = $('adminStatus');
const recurring = $('recurringCheck'), preview = $('imagePreview'), ocrStatus = $('ocrStatus');

let lastQ = '', page = 0, hasMore = false, loading = false, moreBtn = null, typingEl = null;
let tesseractLoaded = false;

function esc(t) { return t.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function addMsg(text, isUser, showMore = false) {
  if (typingEl) { typingEl.remove(); typingEl = null; }
  const row = document.createElement('div');
  row.className = 'row ' + (isUser ? 'user' : 'bot');
  row.innerHTML = '<div class="bubble">' + esc(text) + '</div>';
  chat.appendChild(row);
  if (moreBtn) { moreBtn.remove(); moreBtn = null; }
  if (showMore) {
    moreBtn = document.createElement('button');
    moreBtn.className = 'more-btn';
    moreBtn.textContent = 'Vis flere';
    moreBtn.onclick = loadMore;
    chat.appendChild(moreBtn);
  }
  chat.scrollTop = chat.scrollHeight;
}

function showTyping() {
  if (typingEl) return;
  typingEl = document.createElement('div');
  typingEl.className = 'row bot typing';
  typingEl.innerHTML = '<div class="bubble loading">Søger events...</div>';
  chat.appendChild(typingEl);
  chat.scrollTop = chat.scrollHeight;
}

async function search(q, p) {
  const res = await fetch(API + '?query=' + encodeURIComponent(q) + '&page=' + p + '&_=' + Date.now(), { cache: 'no-store' });
  const txt = await res.text();
  if (txt.startsWith('<')) throw new Error('HTML');
  return JSON.parse(txt);
}

async function doSearch() {
  const q = input.value.trim();
  if (!q || loading) return;
  addMsg(q, true);
  input.value = '';
  lastQ = q; page = 0; hasMore = false;
  loading = true;
  sendBtn.disabled = true;
  showTyping();
  try {
    const data = await search(q, 0);
    hasMore = !!data.hasMore;
    addMsg(data.text || 'Ingen resultater.', false, hasMore);
  } catch (e) {
    addMsg('Fejl. Prøv igen.', false);
  }
  loading = false;
  sendBtn.disabled = false;
}

async function loadMore() {
  if (loading || !hasMore) return;
  page++;
  loading = true;
  if (moreBtn) moreBtn.disabled = true;
  showTyping();
  try {
    const data = await search(lastQ, page);
    hasMore = !!data.hasMore;
    addMsg(data.text, false, hasMore);
  } catch (e) {
    addMsg('Fejl.', false);
    hasMore = false;
  }
  loading = false;
}

sendBtn.onclick = doSearch;
input.onkeydown = e => { if (e.key === 'Enter') { e.preventDefault(); doSearch(); } };

// Admin triple-click
let clicks = 0, clickTimer;
document.querySelector('.header-avatar').onclick = () => {
  clicks++;
  if (clicks === 3) { clicks = 0; clearTimeout(clickTimer); openAdmin(); }
  else { clearTimeout(clickTimer); clickTimer = setTimeout(() => clicks = 0, 500); }
};

function openAdmin() {
  modal.classList.add('open');
  status.style.display = 'none';
  preview.style.display = 'none';
  ocrStatus.style.display = 'none';
  recurring.checked = false;
  payload.value = '';
  payload.focus();
}

$('closeAdmin').onclick = () => modal.classList.remove('open');
modal.onclick = e => { if (e.target === modal) modal.classList.remove('open'); };

// OCR lazy load
async function loadTesseract() {
  if (tesseractLoaded) return;
  ocrStatus.style.display = 'block';
  ocrStatus.textContent = 'Indlæser OCR...';
  const s = document.createElement('script');
  s.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
  document.head.appendChild(s);
  await new Promise(r => s.onload = r);
  tesseractLoaded = true;
}

async function processImage(img) {
  try {
    await loadTesseract();
    ocrStatus.style.display = 'block';
    ocrStatus.textContent = 'Læser billede...';
    const result = await Tesseract.recognize(img, 'dan+eng', {
      logger: m => { if (m.status === 'recognizing text') ocrStatus.textContent = 'Læser... ' + Math.round(m.progress * 100) + '%'; }
    });
    if (result.data.text.trim()) {
      payload.value = result.data.text.trim();
      ocrStatus.textContent = '✅ Tekst fundet';
      setTimeout(() => ocrStatus.style.display = 'none', 2000);
    } else {
      ocrStatus.textContent = '⚠️ Ingen tekst fundet';
    }
  } catch (e) {
    ocrStatus.textContent = '❌ OCR fejl';
  }
}

$('uploadBtn').onclick = () => $('fileInput').click();
$('fileInput').onchange = e => {
  const file = e.target.files[0];
  if (file?.type.startsWith('image/')) {
    preview.src = URL.createObjectURL(file);
    preview.style.display = 'block';
    processImage(file);
  }
  e.target.value = '';
};

modal.onpaste = e => {
  for (const item of (e.clipboardData?.items || [])) {
    if (item.type.startsWith('image/')) {
      e.preventDefault();
      const file = item.getAsFile();
      preview.src = URL.createObjectURL(file);
      preview.style.display = 'block';
      processImage(file);
      return;
    }
  }
};

$('adminSubmitBtn').onclick = async () => {
  const text = payload.value.trim();
  if (!text) return;
  const btn = $('adminSubmitBtn');
  btn.disabled = true;
  btn.textContent = 'Sender...';
  status.style.display = 'none';
  try {
    const res = await fetch(API, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action: 'admin-import', payload: text, recurring: recurring.checked })
    });
    const raw = await res.text();
    if (raw.startsWith('<')) throw new Error('HTML');
    const data = JSON.parse(raw);
    status.style.display = 'block';
    status.textContent = data.text || (data.success ? '✅ Tilføjet' : '❌ Fejl');
    status.className = 'submit-status ' + (data.success ? 'success' : 'error');
    if (data.success) { payload.value = ''; preview.style.display = 'none'; recurring.checked = false; }
  } catch (e) {
    status.style.display = 'block';
    status.textContent = '❌ Teknisk fejl';
    status.className = 'submit-status error';
  }
  btn.disabled = false;
  btn.textContent = 'Tilføj Event';
};

addMsg('Søg fx: "salsa i dag", "bachata weekend" eller "kizomba fredag"', false);
</script>
</body>
</html>
