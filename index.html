// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DanceMap API ‚Äì Stable + Admin Import + Tidsfortolkning
// Sheet kolonner (FAST):
// Dato | Starttid | Sluttid | Dansetype | Sted | Adresse | By | Pris | Arrang√∏r | Link | Status | Recurring | SourceURL
// doGet: query only
// doPost: admin-import only
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const SHEET_ID = '1zaqt2KrR-dZrJoFx3-EP7eIe-ITka55oT9fvnIZaBMU';
const EVENTS_SHEET = 'Events';
const PAGE_SIZE = 5;

function doGet(e) {
  try {
    const query = String(e.parameter.query || '').trim();
    const page = parseInt(e.parameter.page || '0', 10);

    const result = handleQuery(query, page);
    return out(result);

  } catch (err) {
    return out({ success: false, text: 'Der opstod en teknisk fejl. Pr√∏v igen senere.', hasMore: false });
  }
}

function doPost(e) {
  try {
    const raw = (e && e.postData && e.postData.contents) ? e.postData.contents : '';
    const data = safeJson(raw);

    if (!data || !data.action) return out({ success: false, text: 'Manglende action parameter.', hasMore: false });
    if (data.action !== 'admin-import') return out({ success: false, text: 'Ukendt action: ' + String(data.action), hasMore: false });

    const payload = String(data.payload || '').trim();
    if (!payload) return out({ success: false, text: 'Tomt input.', hasMore: false });

    const parsed = parseAdmin(payload);
    if (!parsed.success) return out(parsed);

    const write = writeEvent(parsed.event);
    return out(write);

  } catch (err) {
    return out({ success: false, text: 'Der opstod en teknisk fejl. Pr√∏v igen senere.', hasMore: false });
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// QUERY HANDLER (med tidsfortolkning)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleQuery(query, page) {
  const q = String(query || '').toLowerCase().trim();
  
  if (!q || q === 'hej' || q === 'hi' || q === 'hello') {
    return { success: true, text: 'Jeg viser kun danseevents i K√∏benhavn. Pr√∏v fx "salsa i dag".', hasMore: false };
  }

  // Parse dansetype
  const danceTypes = ['salsa','bachata','kizomba','tango','swing','zouk','west coast swing','lindy hop','latin'];
  const foundDance = danceTypes.find(d => q.includes(d)) || null;

  // Parse datointerval
  const dateRange = parseDateRange(q);

  // Hvis hverken dansetype eller datointerval fundet
  if (!foundDance && !dateRange) {
    return { success: true, text: 'Jeg viser kun danseevents i K√∏benhavn. Pr√∏v fx "salsa i dag".', hasMore: false };
  }

  // Brug default datointerval hvis ikke angivet (14 dage frem)
  const range = dateRange || defaultDateRange();

  const sh = sheet();
  const rows = sh.getDataRange().getValues().slice(1);

  const matches = rows.filter(r => {
    // Status = active
    const status = String(r[10] || '').toLowerCase();
    if (status !== 'active') return false;

    // By = K√∏benhavn
    const by = String(r[6] || '').toLowerCase();
    if (!(by.includes('k√∏benhavn') || by.includes('koebenhavn'))) return false;

    // Dato inden for interval
    const dato = new Date(r[0]);
    if (isNaN(dato.getTime())) return false;
    dato.setHours(0, 0, 0, 0);
    if (dato < range.start || dato > range.end) return false;

    // Dansetype (hvis angivet)
    if (foundDance) {
      const dansetype = String(r[3] || '').toLowerCase();
      if (!dansetype.includes(foundDance)) return false;
    }

    return true;
  });

  // Sorter: dato ‚Üí starttid ‚Üí dansetype
  matches.sort(function(a, b) {
    const da = new Date(a[0]).getTime();
    const db = new Date(b[0]).getTime();
    if (da !== db) return da - db;

    const ta = String(a[1] || '');
    const tb = String(b[1] || '');
    if (ta !== tb) return ta.localeCompare(tb);

    return String(a[3] || '').localeCompare(String(b[3] || ''), 'da');
  });

  // Deduplikering (dato + sted + starttid)
  const seen = {};
  const unique = matches.filter(r => {
    const key = String(r[0]) + '_' + String(r[4]).toLowerCase() + '_' + String(r[1]);
    if (seen[key]) return false;
    seen[key] = true;
    return true;
  });

  const start = page * PAGE_SIZE;
  const slice = unique.slice(start, start + PAGE_SIZE);

  if (slice.length === 0 && page === 0) {
    return {
      success: true,
      text: 'Der er ingen danseevents, der matcher din foresp√∏rgsel.\nPr√∏v fx "salsa i weekenden" eller "bachata i dag".',
      hasMore: false
    };
  }

  return {
    success: true,
    text: slice.map(format).join('\n\n'),
    hasMore: start + PAGE_SIZE < unique.length
  };
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TIDSFORTOLKNING
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseDateRange(q) {
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  // "i dag"
  if (q.includes('i dag')) {
    return { start: today, end: today };
  }

  // "i morgen"
  if (q.includes('i morgen')) {
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    return { start: tomorrow, end: tomorrow };
  }

  // "weekend"
  if (q.includes('weekend')) {
    const saturday = nextWeekday(today, 6);
    const sunday = new Date(saturday);
    sunday.setDate(saturday.getDate() + 1);
    return { start: saturday, end: sunday };
  }

  // "n√¶ste uge"
  if (q.includes('n√¶ste uge') || q.includes('naeste uge')) {
    const nextMonday = nextWeekday(today, 1);
    const nextSunday = new Date(nextMonday);
    nextSunday.setDate(nextMonday.getDate() + 6);
    return { start: nextMonday, end: nextSunday };
  }

  // Ugedage
  const weekdays = {
    'mandag': 1,
    'tirsdag': 2,
    'onsdag': 3,
    'torsdag': 4,
    'fredag': 5,
    'l√∏rdag': 6,
    'loerdag': 6,
    'lordag': 6,
    's√∏ndag': 0,
    'soendag': 0,
    'sondag': 0
  };

  for (var day in weekdays) {
    if (q.includes(day)) {
      var target = nextWeekday(today, weekdays[day]);
      return { start: target, end: target };
    }
  }

  return null;
}

function nextWeekday(from, targetDay) {
  const result = new Date(from);
  const currentDay = result.getDay();
  var daysToAdd = targetDay - currentDay;
  if (daysToAdd <= 0) daysToAdd += 7;
  result.setDate(result.getDate() + daysToAdd);
  result.setHours(0, 0, 0, 0);
  return result;
}

function defaultDateRange() {
  const start = new Date();
  start.setHours(0, 0, 0, 0);
  const end = new Date(start);
  end.setDate(end.getDate() + 14);
  return { start: start, end: end };
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ADMIN PARSER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseAdmin(payload) {
  const txt = String(payload || '');

  const date = txt.match(/\b(20\d{2})-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])\b/);
  const time = txt.match(/\b([01]\d|2[0-3]):([0-5]\d)(?:\s*[-‚Äì]\s*([01]\d|2[0-3]):([0-5]\d))?\b/);
  if (!date || !time) return { success: false, text: 'Mangler dato (YYYY-MM-DD) eller tid (HH:MM).', hasMore: false };

  const starttid = time[1] + ':' + time[2];
  const sluttid = (time[3] && time[4]) ? (time[3] + ':' + time[4]) : '';

  const link = (txt.match(/https?:\/\/\S+/) || [''])[0];

  const types = ['Salsa','Bachata','Kizomba','Tango','Swing','Zouk','West Coast Swing','Lindy Hop','Latin'];
  var dansetype = '';
  for (var i = 0; i < types.length; i++) {
    if (new RegExp('\\b' + types[i].replace(/\s+/g,'\\s+') + '\\b', 'i').test(txt)) { dansetype = types[i]; break; }
  }
  if (!dansetype) dansetype = 'Salsa';

  const lines = txt.split('\n').map(function(s) { return s.trim(); }).filter(Boolean);
  var sted = '';
  for (var j = 0; j < lines.length; j++) {
    var l = lines[j];
    if (l === date[0]) continue;
    if (l.includes(starttid)) continue;
    if (link && l.includes(link)) continue;
    if (new RegExp('\\b' + dansetype.replace(/\s+/g,'\\s+') + '\\b', 'i').test(l)) continue;
    sted = l;
    break;
  }
  if (!sted) sted = 'Ukendt sted';

  var adresse = '';
  for (var k = 0; k < lines.length; k++) {
    var l2 = lines[k];
    if (/\d/.test(l2) && l2 !== date[0] && !l2.includes(starttid) && (!link || !l2.includes(link))) {
      adresse = l2;
      break;
    }
  }

  var pris = '';
  if (/\bgratis\b/i.test(txt)) pris = 'Gratis';
  var price = txt.match(/\b(\d{1,4})\s*(kr|dkk)\b/i);
  if (!pris && price) pris = price[1] + ' ' + price[2].toLowerCase();

  var sourceURL = link;

  return {
    success: true,
    text: '',
    hasMore: false,
    event: [
      date[0],
      starttid,
      sluttid,
      dansetype,
      sted,
      adresse,
      'K√∏benhavn',
      pris,
      '',
      link,
      'active',
      'none',
      sourceURL
    ]
  };
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// WRITE + DEDUP (dato + sted + starttid)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function writeEvent(eventRow) {
  const sh = sheet();
  const rows = sh.getDataRange().getValues().slice(1);

  const keyDato = String(eventRow[0]).trim();
  const keyStart = String(eventRow[1]).trim();
  const keySted = String(eventRow[4]).trim().toLowerCase();

  const dup = rows.some(function(r) {
    return String(r[0]).trim() === keyDato &&
           String(r[1]).trim() === keyStart &&
           String(r[4]).trim().toLowerCase() === keySted;
  });

  if (dup) return { success: false, text: 'Dublet ‚Äì event findes allerede.', hasMore: false };

  sh.appendRow(eventRow);
  return { success: true, text: '‚úÖ Event tilf√∏jet direkte til Events.', hasMore: false };
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// FORMAT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function format(r) {
  const dato = formatDato(r[0]);
  const tid = formatTid(r[1], r[2]);
  const festival = (String(r[11]) === 'festival') ? ' (Festival)' : '';

  var out = 'üóì ' + dato + festival + '\n' +
            'üïó ' + tid + '\n' +
            'üíÉ ' + String(r[3] || '') + '\n' +
            'üìç ' + String(r[4] || '') + (r[5] ? ', ' + String(r[5]) : '');

  if (r[7]) out += '\nüí∞ ' + String(r[7]);
  if (r[9]) out += '\nüîó ' + String(r[9]);

  return out;
}

function formatDato(d) {
  const dage = ['S√∏ndag','Mandag','Tirsdag','Onsdag','Torsdag','Fredag','L√∏rdag'];
  const mdr = ['januar','februar','marts','april','maj','juni','juli','august','september','oktober','november','december'];
  const date = new Date(d);
  if (isNaN(date.getTime())) return String(d);
  return dage[date.getDay()] + ' ' + date.getDate() + '. ' + mdr[date.getMonth()];
}

function formatTid(start, slut) {
  var s = String(start || '');
  if (slut) s += '‚Äì' + String(slut);
  return s;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// HELPERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sheet() {
  return SpreadsheetApp.openById(SHEET_ID).getSheetByName(EVENTS_SHEET);
}

function safeJson(s) {
  try { return JSON.parse(s); } catch (e) { return null; }
}

function out(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
