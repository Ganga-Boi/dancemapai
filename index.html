<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DanceMap</title>

<style>
:root{color-scheme:dark}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:#0b0f14;color:#e8eef7}
.wrap{max-width:480px;margin:0 auto;height:100vh;display:flex;flex-direction:column}
.header{padding:14px 16px;border-bottom:1px solid #1a2432;background:#0e141d;display:flex;gap:10px;align-items:center}
.header-avatar{width:40px;height:40px;border-radius:50%}
@media(min-width:600px){.header-avatar{width:44px;height:44px}}
.chat{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
.row{display:flex}
.row.user{justify-content:flex-end}
.row.bot{justify-content:flex-start}
.bubble{max-width:85%;padding:10px 14px;border-radius:16px;white-space:pre-wrap;font-size:14px}
.user .bubble{background:#1e3a5f}
.bot .bubble{background:#1a2432}
.typing .bubble{opacity:.6;font-style:italic}
.bar{display:flex;gap:10px;padding:12px;border-top:1px solid #1a2432;background:#0e141d}
.bar input{flex:1;padding:12px;border-radius:20px;border:1px solid #1a2432;background:#0b1017;color:#e8eef7}
.send-btn{width:44px;height:44px;border-radius:50%;border:none;background:#1e3a5f;color:#fff}
.more-btn{align-self:flex-start;padding:8px 14px;border-radius:12px;border:1px solid #2a3b54;background:#0e141d;color:#9fc5ff}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);align-items:flex-end;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:#0e141d;width:100%;max-width:480px;border-radius:20px 20px 0 0;padding:16px}
textarea{width:100%;min-height:160px;border-radius:10px;border:1px solid #1a2432;background:#0b1017;color:#e8eef7;padding:10px}
.submit-btn{width:100%;padding:14px;border-radius:12px;border:none;background:#1e3a5f;color:#fff}
.submit-status{text-align:center;margin-top:8px}
.success{color:#4ade80}
.error{color:#ff6b6b}
</style>
</head>

<body>
<div class="wrap">
  <div class="header">
    <img src="./dancemap-icon.svg" class="header-avatar">
    <div>
      <strong>DanceMap</strong>
      <div style="font-size:12px;opacity:.6">Kun danseevents i København</div>
    </div>
  </div>

  <div id="chat" class="chat"></div>

  <div class="bar">
    <input id="q" placeholder="Skriv fx: salsa i dag">
    <button id="send" class="send-btn">➤</button>
  </div>
</div>

<!-- ADMIN -->
<div id="adminModal" class="modal-overlay">
  <div class="modal">
    <h3>Admin – Paste / URL</h3>
    <textarea id="adminPayload"></textarea>
    <button id="adminSubmit" class="submit-btn">Tilføj til Events</button>
    <div id="adminStatus" class="submit-status"></div>
  </div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbxnZiO0bDkCrrwGJXwAvA5mWKPBoQoL-t1smx5m0A5j51gSbTOtF1MLT3qkdwbZkTX_/exec';

const chat=document.getElementById('chat');
const q=document.getElementById('q');
const send=document.getElementById('send');

let lastQuery='',page=0,hasMore=false,loading=false,typingEl=null,moreBtn=null;

function add(text,cls){
  const r=document.createElement('div');
  r.className='row '+cls;
  const b=document.createElement('div');
  b.className='bubble';
  b.textContent=text;
  r.appendChild(b);
  chat.appendChild(r);
  chat.scrollTop=chat.scrollHeight;
}

function typing(){
  if(typingEl)return;
  typingEl=document.createElement('div');
  typingEl.className='row bot typing';
  const b=document.createElement('div');
  b.className='bubble';
  b.textContent='DanceMap skriver …';
  typingEl.appendChild(b);
  chat.appendChild(typingEl);
}

function stopTyping(){
  if(typingEl){typingEl.remove();typingEl=null;}
}

async function callApi(query,p){
  const u=new URL(API_URL);
  u.searchParams.set('query',query);
  u.searchParams.set('page',p);
  u.searchParams.set('_ts',Date.now());
  const r=await fetch(u,{cache:'no-store'});
  const t=await r.text();
  if(!r.ok)throw'HTTP';
  if(t.trim().startsWith('<'))throw'HTML';
  return JSON.parse(t);
}

async function sendQuery(){
  const text=q.value.trim();
  if(!text||loading)return;
  q.value='';
  add(text,'user');
  lastQuery=text;page=0;hasMore=false;
  loading=true;typing();

  try{
    const d=await callApi(text,0);
    stopTyping();
    if(!d.success){add(d.text,'bot');return;}
    hasMore=!!d.hasMore;
    add(d.text,'bot');
    if(hasMore){
      moreBtn=document.createElement('button');
      moreBtn.className='more-btn';
      moreBtn.textContent='Vis flere';
      moreBtn.onclick=more;
      chat.appendChild(moreBtn);
    }
  }catch{
    stopTyping();
    add('Der opstod en teknisk fejl. Prøv igen senere.','bot');
  }finally{loading=false;}
}

async function more(){
  if(!hasMore||loading)return;
  loading=true;page++;typing();
  try{
    const d=await callApi(lastQuery,page);
    stopTyping();
    if(!d.success){add(d.text,'bot');hasMore=false;return;}
    add(d.text,'bot');
    hasMore=!!d.hasMore;
    if(!hasMore&&moreBtn)moreBtn.remove();
  }catch{
    stopTyping();
    add('Der opstod en teknisk fejl.','bot');
    hasMore=false;
  }finally{loading=false;}
}

send.onclick=sendQuery;
q.onkeydown=e=>{if(e.key==='Enter'){e.preventDefault();sendQuery();}};

// ADMIN
const isAdmin=new URLSearchParams(location.search).get('admin')==='1';
const adminModal=document.getElementById('adminModal');
const adminPayload=document.getElementById('adminPayload');
const adminSubmit=document.getElementById('adminSubmit');
const adminStatus=document.getElementById('adminStatus');

if(isAdmin){
  window.addEventListener('keydown',e=>{
    if(e.ctrlKey&&e.shiftKey&&e.key.toLowerCase()==='a'){
      e.preventDefault();
      adminModal.classList.toggle('open');
    }
  },true);
}

adminSubmit.onclick=async()=>{
  const p=adminPayload.value.trim();
  if(!p)return;
  adminStatus.textContent='Sender…';
  try{
    const r=await fetch(API_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'admin-import',payload:p})
    });
    const t=await r.text();
    if(t.trim().startsWith('<'))throw'HTML';
    const d=JSON.parse(t);
    adminStatus.textContent=d.text;
    adminStatus.className='submit-status '+(d.success?'success':'error');
    if(d.success)adminPayload.value='';
  }catch{
    adminStatus.textContent='Teknisk fejl';
    adminStatus.className='submit-status error';
  }
};

add('Jeg viser danseevents i København. Søg fx: "salsa i dag", "bachata i weekenden" eller "kizomba fredag".','bot');
</script>
</body>
</html>
