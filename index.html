<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>DanceMap</title>
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#6366f1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="DanceMap" />
  <link rel="apple-touch-icon" href="/icon-192.png" />
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-WYGJJJV2E6"></script>
  <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-WYGJJJV2E6');</script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}html,body{height:100%}
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:#0d1117;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px}
    .card{background:#161b22;border-radius:20px;width:100%;max-width:400px;box-shadow:0 8px 32px rgba(0,0,0,0.4);display:flex;flex-direction:column;max-height:90vh}
    .header{padding:20px;display:flex;align-items:center;gap:14px;border-bottom:1px solid #21262d;cursor:pointer}
    .logo{width:48px;height:48px;border-radius:14px;overflow:hidden}.logo img{width:100%;height:100%;object-fit:cover}
    .header-text h1{font-size:18px;font-weight:600;color:#e6edf3;margin-bottom:2px}.header-text .sub{font-size:13px;color:#7d8590}
    .header-text .week-count{font-size:12px;color:#6366f1;margin-top:4px}.header-text .version-display{font-size:10px;color:#484f58;margin-top:2px}
    .chat{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:16px;min-height:200px;max-height:60vh}
    .msg{display:flex;flex-direction:column}.msg.user{align-items:flex-end}.msg.bot{align-items:flex-start}
    .bubble{padding:12px 16px;border-radius:16px;font-size:15px;line-height:1.5;max-width:90%}
    .msg.user .bubble{background:#2d333b;color:#e6edf3;border-bottom-right-radius:4px}
    .msg.bot .bubble{background:#21262d;color:#c9d1d9;border-bottom-left-radius:4px}
    .events{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .event-card{background:#2d333b;border-radius:12px;padding:14px 16px}
    .event-row{display:flex;align-items:center;gap:10px;margin-bottom:6px;font-size:14px;color:#c9d1d9}
    .event-row:last-child{margin-bottom:0}.event-row .icon{width:20px;text-align:center;flex-shrink:0}
    .event-row.title{font-weight:600;color:#e6edf3;font-size:15px}
    .more-btn{margin-top:12px;padding:10px 16px;border-radius:10px;border:1px solid #30363d;background:transparent;color:#7d8590;font-size:14px;cursor:pointer}
    .more-btn:hover{background:#21262d;color:#c9d1d9}
    .input-area{padding:16px 20px;border-top:1px solid #21262d;display:flex;gap:12px}
    .input-area input{flex:1;padding:14px 18px;border-radius:12px;border:1px solid #30363d;background:#0d1117;font-size:15px;font-family:inherit;color:#e6edf3;outline:none}
    .input-area input:focus{border-color:#6366f1}.input-area input::placeholder{color:#7d8590}
    .send-btn{width:48px;height:48px;border-radius:12px;border:none;background:#6366f1;color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .send-btn:active{transform:scale(0.95)}.send-btn:disabled{opacity:0.5}.send-btn svg{width:20px;height:20px}
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:100;align-items:center;justify-content:center;padding:16px}
    .modal-overlay.open{display:flex}.modal{background:#161b22;border-radius:20px;width:100%;max-width:400px;padding:24px;max-height:90vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .modal-header h2{font-size:18px;font-weight:600;color:#e6edf3}.modal-close{background:none;border:none;color:#7d8590;font-size:28px;cursor:pointer}
    .upload-btn{width:100%;padding:16px;border-radius:12px;border:2px dashed #30363d;background:transparent;color:#7d8590;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:16px}
    .upload-btn:hover{border-color:#6366f1;color:#c9d1d9}
    .image-preview{max-width:100%;max-height:150px;border-radius:12px;margin-bottom:12px;display:none}
    .ocr-status{font-size:14px;color:#7d8590;text-align:center;padding:12px}
    .form-group{margin-bottom:16px}.form-group label{display:block;font-size:13px;margin-bottom:8px;color:#7d8590}
    .form-group textarea{width:100%;min-height:150px;padding:14px;border-radius:12px;border:1px solid #30363d;background:#0d1117;color:#e6edf3;font-size:14px;font-family:inherit;outline:none;resize:vertical}
    .form-group textarea:focus{border-color:#6366f1}
    .checkbox-group{display:flex;align-items:center;gap:12px;margin-bottom:20px;padding:14px;background:#0d1117;border-radius:10px}
    .checkbox-group input[type="checkbox"]{width:20px;height:20px;accent-color:#6366f1}
    .checkbox-group label{font-size:14px;color:#c9d1d9;cursor:pointer}
    .submit-btn{width:100%;padding:16px;border-radius:12px;border:none;background:#6366f1;color:white;font-size:15px;font-weight:500;cursor:pointer}
    .submit-btn:disabled{opacity:0.5}
    .submit-status{text-align:center;padding:12px;font-size:14px;margin-top:12px;border-radius:10px}
    .submit-status.success{color:#3fb950;background:rgba(63,185,80,0.1)}
    .submit-status.error{color:#f85149;background:rgba(248,81,73,0.1)}
    .back-btn{background:none;border:none;color:#7d8590;font-size:14px;cursor:pointer;margin-bottom:16px;padding:0}.back-btn:hover{color:#c9d1d9}
    .field-row{margin-bottom:14px}.field-row label{display:block;font-size:12px;margin-bottom:6px;color:#7d8590}
    .field-row input,.field-row select{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #30363d;background:#0d1117;color:#e6edf3;font-size:14px;font-family:inherit;outline:none}
    .field-row input:focus,.field-row select:focus{border-color:#6366f1}
    .field-row.two-col{display:flex;gap:12px}.field-row.two-col>div{flex:1}
    .field-warnings{margin-bottom:14px;padding:12px;background:rgba(248,81,73,0.1);border-radius:10px;font-size:13px;color:#f85149;display:none}
    .field-warnings.show{display:block}
    .admin-intro{font-size:13px;color:#7d8590;margin-bottom:16px;line-height:1.5}
    .preview-card{background:#21262d;border-radius:12px;padding:14px 16px;margin-bottom:16px}
    .preview-label{font-size:11px;color:#7d8590;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px}
    .preview-content{font-size:14px;color:#c9d1d9;line-height:1.6}
    .preview-content .line{display:flex;gap:8px;margin-bottom:4px}.preview-content .line:last-child{margin-bottom:0}
    .preview-content .icon{width:20px;text-align:center}
    .version-info{font-size:10px;color:#484f58;text-align:center;margin-top:8px}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}.loading-text{animation:pulse 1.5s ease-in-out infinite}
    .admin-tabs{display:flex;gap:8px;margin-bottom:16px}
    .admin-tab{flex:1;padding:10px;border:1px solid #30363d;background:transparent;color:#7d8590;border-radius:8px;cursor:pointer;font-size:14px}
    .admin-tab.active{background:#6366f1;color:white;border-color:#6366f1}
    .pending-list{display:flex;flex-direction:column;gap:12px;max-height:420px;overflow-y:auto;margin-bottom:16px}
    .pending-item{background:#21262d;border-radius:10px;padding:14px}
    .pending-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .pending-item-title{font-weight:600;color:#e6edf3}
    .pending-item-details{font-size:13px;color:#c9d1d9;line-height:1.5}
    .pending-item-row{display:flex;gap:8px;margin-bottom:4px}.pending-item-row span:first-child{width:20px}
    .pending-actions{display:flex;gap:10px;margin-top:10px}
    .pending-approve-btn{padding:10px 12px;background:#238636;color:white;border:none;border-radius:8px;cursor:pointer;font-size:13px}
    .pending-approve-btn:disabled{opacity:0.5}
    .pending-empty{text-align:center;color:#7d8590;padding:40px 20px}
  </style>
</head>
<body>

<div class="card">
  <div class="header">
    <div class="logo"><img src="/dancemap-icon.svg" alt="DanceMap" /></div>
    <div class="header-text">
      <h1>DanceMap</h1>
      <div class="sub">Dansevents i KÃ¸benhavn</div>
      <div class="week-count" id="weekCount"></div>
      <div class="version-display" id="versionDisplay"></div>
    </div>
  </div>
  <div id="chat" class="chat"></div>
  <div class="input-area">
    <input id="q" type="text" placeholder="Skriv fx: salsa eller bachata" autocomplete="off" enterkeyhint="search" />
    <button id="sendBtn" class="send-btn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    </button>
  </div>
</div>

<div class="modal-overlay" id="adminModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Admin</h2>
      <button class="modal-close" id="closeAdmin">&times;</button>
    </div>
    <div class="admin-tabs">
      <button class="admin-tab active" id="tabAdd">TilfÃ¸j Event</button>
      <button class="admin-tab" id="tabPending">Godkend Events</button>
    </div>
    <div id="adminAddView">
      <div id="adminWelcome" style="background:linear-gradient(135deg,#238636 0%,#2ea043 100%);border-radius:12px;padding:16px;margin-bottom:16px;display:none;">
        <div style="font-size:15px;color:white;font-weight:500;" id="welcomeText"></div>
        <div style="font-size:12px;color:rgba(255,255,255,0.8);margin-top:4px;">Sammen fÃ¥r vi DanceMap til at vokse! ğŸ’ƒ</div>
      </div>
      
      <!-- ALTID SYNLIG: Paste og upload knapper -->
      <div style="display:flex;gap:10px;margin-bottom:16px;">
        <button type="button" class="upload-btn" id="pasteBtn" style="flex:1;margin-bottom:0;background:rgba(99,102,241,0.1);border-color:#6366f1;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
          ğŸ“‹ IndsÃ¦t billede
        </button>
        <button type="button" class="upload-btn" id="uploadBtn" style="flex:0 0 auto;width:50px;margin-bottom:0;padding:16px 12px;" title="Upload fil">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        </button>
        <button type="button" class="upload-btn" id="clearAllBtn" style="flex:0 0 auto;width:50px;margin-bottom:0;padding:16px 12px;border-color:#da3633;" title="Ryd alt">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#da3633" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        </button>
      </div>
      <input type="file" id="fileInput" accept="image/*" style="display:none" />
      <img id="imagePreview" class="image-preview" />
      <div id="ocrStatus" class="ocr-status" style="display:none"></div>
      
      <div id="adminStep1">
        <p class="admin-intro">ğŸ“¸ IndsÃ¦t et billede, eller skriv event-tekst nedenfor.</p>
        <div class="form-group">
          <label>Paste tekst eller billede (Ctrl+V)</label>
          <textarea id="adminPayload" placeholder="Paste event-tekst her..."></textarea>
        </div>
        <button type="button" class="submit-btn" id="parseBtn">Parse tekst â†’</button>
      </div>
      <div id="adminStep2" style="display:none">
        <button type="button" class="back-btn" id="backBtn">â† Tilbage</button>
        <div class="field-row"><label>Dato *</label><input type="date" id="fieldDato" required /></div>
        <div class="field-row"><label>Event navn *</label><input type="text" id="fieldNavn" placeholder="Fx Salsa Social" /></div>
        <div class="field-row two-col">
          <div><label>Start *</label><input type="time" id="fieldStart" required /></div>
          <div><label>Slut *</label><input type="time" id="fieldSlut" /></div>
        </div>
        <div class="field-row"><label>Dansetype * (vÃ¦lg Ã©n eller flere)</label>
          <div id="danceTypeGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <label style="display:flex;align-items:center;gap:8px;padding:10px;background:#0d1117;border-radius:8px;cursor:pointer;font-size:13px;color:#c9d1d9;"><input type="checkbox" name="dansetype" value="Salsa" style="accent-color:#6366f1;"> Salsa</label>
            <label style="display:flex;align-items:center;gap:8px;padding:10px;background:#0d1117;border-radius:8px;cursor:pointer;font-size:13px;color:#c9d1d9;"><input type="checkbox" name="dansetype" value="Bachata" style="accent-color:#6366f1;"> Bachata</label>
            <label style="display:flex;align-items:center;gap:8px;padding:10px;background:#0d1117;border-radius:8px;cursor:pointer;font-size:13px;color:#c9d1d9;"><input type="checkbox" name="dansetype" value="Kizomba" style="accent-color:#6366f1;"> Kizomba</label>
            <label style="display:flex;align-items:center;gap:8px;padding:10px;background:#0d1117;border-radius:8px;cursor:pointer;font-size:13px;color:#c9d1d9;"><input type="checkbox" name="dansetype" value="Zouk" style="accent-color:#6366f1;"> Zouk</label>
            <label style="display:flex;align-items:center;gap:8px;padding:10px;background:#0d1117;border-radius:8px;cursor:pointer;font-size:13px;color:#c9d1d9;"><input type="checkbox" name="dansetype" value="Tango" style="accent-color:#6366f1;"> Tango</label>
            <label style="display:flex;align-items:center;gap:8px;padding:10px;background:#0d1117;border-radius:8px;cursor:pointer;font-size:13px;color:#c9d1d9;"><input type="checkbox" name="dansetype" value="Swing" style="accent-color:#6366f1;"> Swing</label>
          </div>
          <input type="hidden" id="fieldDans" />
        </div>
        <div class="field-row"><label>Sted *</label><input type="text" id="fieldSted" placeholder="Fx Kedelhallen" required /></div>
        <div class="field-row"><label>Adresse *</label><input type="text" id="fieldAdresse" placeholder="Fx Nyelandsvej 75A" /></div>
        <div class="field-row"><label>By *</label><input type="text" id="fieldBy" value="KÃ¸benhavn" /></div>
        <div class="field-row"><label>Pristype</label>
          <select id="fieldPrisType"><option value="angiv">Angiv priser</option><option value="gratis">Gratis</option><option value="mobilepay">MobilePay</option><option value="kontakt">Kontakt arrangÃ¸r</option></select>
        </div>
        <div id="prisFields">
          <div class="field-row two-col">
            <div><label>Online (kr)</label><input type="text" id="fieldPrisOnline" placeholder="50" /></div>
            <div><label>Drop-in (kr)</label><input type="text" id="fieldPrisDropin" placeholder="70" /></div>
          </div>
        </div>
        <div id="mobilepayFields" style="display:none;">
          <div class="field-row two-col">
            <div><label>Pris (kr) *</label><input type="text" id="fieldMobilepayPris" placeholder="50" /></div>
            <div><label>MobilePay nr/boks</label><input type="text" id="fieldMobilepay" placeholder="12345" /></div>
          </div>
          <div class="field-row">
            <label>Betalingsinfo (vises til brugere)</label>
            <input type="text" id="fieldMobilepayInfo" placeholder="Fx: Skriv dit navn i beskeden" />
          </div>
        </div>
        <input type="hidden" id="fieldPris" />
        <div id="fieldWarnings" class="field-warnings"></div>
        <div id="previewCard" class="preview-card">
          <div class="preview-label">ForhÃ¥ndsvisning</div>
          <div id="previewContent" class="preview-content"></div>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="recurringCheck" />
          <label for="recurringCheck">Gentager ugentligt</label>
        </div>
        <button type="button" class="submit-btn" id="adminSubmitBtn">TilfÃ¸j Event (pending)</button>
      </div>
      <div id="adminStatus" class="submit-status" style="display:none"></div>
      <div id="backendVersion" class="version-info"></div>
    </div>
    <div id="adminPendingView" style="display:none">
      <div id="pendingList" class="pending-list"></div>
      <div id="pendingEmpty" class="pending-empty">Ingen events afventer godkendelse</div>
      <button type="button" class="submit-btn" id="refreshPending">Opdater liste</button>
    </div>
  </div>
</div>

<script>
const FRONTEND_VERSION = 'v6.1.1-2025-01-13';
const FORM_VERSION = '6.1.1';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš ï¸ VIGTIGT: OPDATER DENNE URL EFTER NY DEPLOYMENT âš ï¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = 'https://script.google.com/macros/s/AKfycbyJdVscl-4f-ow7Ynj-LGsazpGFSR8VzVZWHruWdNE66HbVK6LJLOXKRmS6TFUUFC6i/exec';

(function(){try{const s=localStorage.getItem('dancemap_admin_form');if(s){const d=JSON.parse(s);if(d.formVersion!==FORM_VERSION)localStorage.removeItem('dancemap_admin_form');}}catch(e){localStorage.removeItem('dancemap_admin_form');}})();

const $=id=>document.getElementById(id);
const chat=$('chat'),input=$('q'),sendBtn=$('sendBtn');
const modal=$('adminModal'),payload=$('adminPayload'),status=$('adminStatus');
const recurring=$('recurringCheck'),preview=$('imagePreview'),ocrStatus=$('ocrStatus');
const step1=$('adminStep1'),step2=$('adminStep2'),warnings=$('fieldWarnings');

let lastQ='',page=0,hasMore=false,loading=false,moreBtn=null;

const fields={dato:$('fieldDato'),navn:$('fieldNavn'),start:$('fieldStart'),slut:$('fieldSlut'),dans:$('fieldDans'),sted:$('fieldSted'),adresse:$('fieldAdresse'),by:$('fieldBy'),pris:$('fieldPris'),prisType:$('fieldPrisType'),prisOnline:$('fieldPrisOnline'),prisDropin:$('fieldPrisDropin'),mobilepay:$('fieldMobilepay'),mobilepayPris:$('fieldMobilepayPris'),mobilepayInfo:$('fieldMobilepayInfo')};

// Dansetype checkboxes handler
function getSelectedDanceTypes(){
  const checked=document.querySelectorAll('input[name="dansetype"]:checked');
  return Array.from(checked).map(c=>c.value);
}
function setSelectedDanceTypes(types){
  document.querySelectorAll('input[name="dansetype"]').forEach(c=>c.checked=false);
  if(!types)return;
  const arr=Array.isArray(types)?types:types.split(/\s*[&,]\s*/);
  arr.forEach(t=>{
    const cb=document.querySelector(`input[name="dansetype"][value="${t.trim()}"]`);
    if(cb)cb.checked=true;
  });
}
function updateDansField(){
  const types=getSelectedDanceTypes();
  fields.dans.value=types.join(' & ');
}
document.querySelectorAll('input[name="dansetype"]').forEach(cb=>{
  cb.addEventListener('change',()=>{updateDansField();updatePreview();saveFormState();});
});

function esc(t){return String(t||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Date.now()+'_'+Math.random().toString(36).slice(2);
    window[cb]=data=>{delete window[cb];script.remove();resolve(data);};
    const script=document.createElement('script');
    script.src=url+(url.includes('?')?'&':'?')+'callback='+cb;
    script.onerror=()=>{delete window[cb];script.remove();reject(new Error('JSONP failed'));};
    document.body.appendChild(script);
  });
}

// VERSION CHECK - Auto-refresh ved mismatch
async function checkVersion(){
  try{
    const data=await jsonp(API+'?action=ping&_='+Date.now());
    const adminEl=$('backendVersion'),frontEl=$('versionDisplay');
    if(data.version){
      const match=data.version===FRONTEND_VERSION;
      if(adminEl){adminEl.textContent=match?'Version 6.1.1':'Backend: '+data.version;adminEl.style.color=match?'#3fb950':'#f85149';}
      if(frontEl){frontEl.textContent=match?'Version 6.1.1':'Opdaterer...';frontEl.style.color=match?'#484f58':'#f0883e';}
      
      // Auto-refresh hvis version mismatch
      if(!match){
        console.log('Version mismatch - refreshing...');
        // Ryd service worker cache
        if('caches' in window){
          const names=await caches.keys();
          await Promise.all(names.map(name=>caches.delete(name)));
        }
        // Refresh efter kort delay
        setTimeout(()=>location.reload(true),1500);
      }
    }
  }catch(e){
    const frontEl=$('versionDisplay');
    if(frontEl){frontEl.textContent='Version 6.1.1 (offline)';frontEl.style.color='#f85149';}
  }
}
checkVersion();

// PRIS
$('fieldPrisType').onchange=function(){
  $('prisFields').style.display=this.value==='angiv'?'block':'none';
  $('mobilepayFields').style.display=this.value==='mobilepay'?'block':'none';
  if(this.value!=='angiv'){fields.prisOnline.value='';fields.prisDropin.value='';}
  if(this.value!=='mobilepay'){fields.mobilepay.value='';fields.mobilepayPris.value='';}
  updatePrisField();updatePreview();
};

function updatePrisField(){
  const pt=fields.prisType.value;
  if(pt==='gratis')fields.pris.value='Gratis';
  else if(pt==='kontakt')fields.pris.value='Kontakt arrangÃ¸r';
  else if(pt==='mobilepay'){
    const pris=fields.mobilepayPris.value.trim();
    const mp=fields.mobilepay.value.trim();
    const info=fields.mobilepayInfo.value.trim();
    let val='';
    if(pris)val=pris+' kr';
    if(mp)val+=(val?' via ':'')+' MobilePay: '+mp;
    else if(pris)val+=' (MobilePay)';
    if(info)val+=(val?' â€“ ':'')+info;
    fields.pris.value=val||'MobilePay';
  }
  else{
    const o=fields.prisOnline.value.trim(),d=fields.prisDropin.value.trim();
    if(o&&d)fields.pris.value=o+' kr (online) / '+d+' kr (drop-in)';
    else if(o)fields.pris.value=o+' kr (online)';
    else if(d)fields.pris.value=d+' kr (drop-in)';
    else fields.pris.value='';
  }
}

// SEARCH med CACHING for hurtigere resultater
const SEARCH_CACHE_KEY = 'dancemap_search_cache';
const CACHE_MAX_AGE = 5 * 60 * 1000; // 5 minutter

function getSearchCache(query) {
  try {
    const cache = JSON.parse(localStorage.getItem(SEARCH_CACHE_KEY) || '{}');
    const entry = cache[query.toLowerCase()];
    if (entry && (Date.now() - entry.timestamp) < CACHE_MAX_AGE) {
      return entry.data;
    }
  } catch(e) {}
  return null;
}

function setSearchCache(query, data) {
  try {
    const cache = JSON.parse(localStorage.getItem(SEARCH_CACHE_KEY) || '{}');
    // Behold kun de 20 nyeste sÃ¸gninger
    const keys = Object.keys(cache);
    if (keys.length > 20) {
      const oldest = keys.sort((a,b) => cache[a].timestamp - cache[b].timestamp)[0];
      delete cache[oldest];
    }
    cache[query.toLowerCase()] = { data, timestamp: Date.now() };
    localStorage.setItem(SEARCH_CACHE_KEY, JSON.stringify(cache));
  } catch(e) {}
}

function parseEvents(text){return String(text||'').split('\n\n').filter(e=>e.trim()).map(event=>{const p={};event.split('\n').forEach(l=>{if(l.startsWith('ğŸ—“'))p.dato=l.replace('ğŸ—“','').trim();else if(l.startsWith('ğŸ“Œ'))p.navn=l.replace('ğŸ“Œ','').trim();else if(l.startsWith('ğŸ•—'))p.tid=l.replace('ğŸ•—','').trim();else if(l.startsWith('ğŸ’ƒ'))p.type=l.replace('ğŸ’ƒ','').trim();else if(l.startsWith('ğŸ“'))p.sted=l.replace('ğŸ“','').trim();else if(l.startsWith('ğŸ’°'))p.pris=l.replace('ğŸ’°','').trim();});return p;}).filter(e=>e.dato);}

function renderEvents(events){return events.map(e=>`<div class="event-card"><div class="event-row title"><span class="icon">ğŸ“…</span><span>${esc(e.dato)}</span></div>${e.navn?`<div class="event-row title"><span class="icon">ğŸ“Œ</span><span>${esc(e.navn)}</span></div>`:''} ${e.tid?`<div class="event-row"><span class="icon">ğŸ•</span><span>${esc(e.tid)}</span></div>`:''} ${e.sted?`<div class="event-row"><span class="icon">ğŸ“</span><span>${esc(e.sted)}</span></div>`:''} ${e.pris?`<div class="event-row"><span class="icon">ğŸ’°</span><span>${esc(e.pris)}</span></div>`:''}</div>`).join('');}

function addMsg(text,isUser,showMore=false){if(moreBtn){moreBtn.remove();moreBtn=null;}const loadingMsg=chat.querySelector('.loading-msg');if(loadingMsg)loadingMsg.remove();const msg=document.createElement('div');msg.className='msg '+(isUser?'user':'bot');if(isUser){msg.innerHTML=`<div class="bubble">${esc(text)}</div>`;}else{const events=parseEvents(text);msg.innerHTML=events.length>0?`<div class="bubble">Her er events:<div class="events">${renderEvents(events)}</div></div>`:`<div class="bubble">${esc(text)}</div>`;}chat.appendChild(msg);if(showMore){moreBtn=document.createElement('button');moreBtn.className='more-btn';moreBtn.textContent='Vis flere';moreBtn.onclick=loadMore;chat.appendChild(moreBtn);}chat.scrollTop=chat.scrollHeight;}

function showLoading(){const msg=document.createElement('div');msg.className='msg bot loading-msg';msg.innerHTML=`<div class="bubble loading-text">SÃ¸ger events...</div>`;chat.appendChild(msg);chat.scrollTop=chat.scrollHeight;}

async function search(q,p){return await jsonp(API+'?query='+encodeURIComponent(q)+'&page='+p+'&_='+Date.now());}

async function doSearch(){
  const q=input.value.trim();
  if(!q||loading)return;
  addMsg(q,true);
  input.value='';
  lastQ=q;page=0;hasMore=false;loading=true;
  sendBtn.disabled=true;
  
  // Check cache fÃ¸rst (instant resultat!)
  const cached = getSearchCache(q + '_0');
  if(cached){
    hasMore=!!cached.hasMore;
    addMsg(cached.text||'Ingen resultater.',false,hasMore);
    loading=false;sendBtn.disabled=false;
    // Opdater cache i baggrunden
    search(q,0).then(data=>{setSearchCache(q+'_0',data);}).catch(()=>{});
    return;
  }
  
  showLoading();
  try{
    const data=await search(q,0);
    hasMore=!!data.hasMore;
    setSearchCache(q+'_0',data);
    addMsg(data.text||'Ingen resultater.',false,hasMore);
  }catch(e){addMsg('Fejl. PrÃ¸v igen.',false);}
  finally{loading=false;sendBtn.disabled=false;}
}

async function loadMore(){
  if(loading||!hasMore)return;
  page++;loading=true;
  if(moreBtn)moreBtn.disabled=true;
  
  // Check cache
  const cached = getSearchCache(lastQ+'_'+page);
  if(cached){
    hasMore=!!cached.hasMore;
    addMsg(cached.text,false,hasMore);
    loading=false;if(moreBtn)moreBtn.disabled=false;
    search(lastQ,page).then(data=>{setSearchCache(lastQ+'_'+page,data);}).catch(()=>{});
    return;
  }
  
  showLoading();
  try{
    const data=await search(lastQ,page);
    hasMore=!!data.hasMore;
    setSearchCache(lastQ+'_'+page,data);
    addMsg(data.text,false,hasMore);
  }catch(e){addMsg('Fejl.',false);hasMore=false;}
  finally{loading=false;if(moreBtn)moreBtn.disabled=false;}
}

sendBtn.onclick=doSearch;
input.onkeydown=e=>{if(e.key==='Enter'){e.preventDefault();doSearch();}};

// HEADER CLICK: 1x = reset chat, 3x = admin
let clicks=0,clickTimer;
document.querySelector('.header').onclick=()=>{
  clicks++;
  clearTimeout(clickTimer);
  
  if(clicks===3){
    // 3x klik = Ã¥bn admin
    clicks=0;
    openAdmin();
  } else {
    clickTimer=setTimeout(()=>{
      if(clicks===1){
        // 1x klik = reset chat
        chat.innerHTML='';
        addMsg('Skriv fx: salsa eller bachata',false);
        input.value='';
        lastQ='';page=0;hasMore=false;
      }
      clicks=0;
    },400);
  }
};

function openAdmin(){modal.classList.add('open');status.style.display='none';preview.style.display='none';ocrStatus.style.display='none';warnings.classList.remove('show');restoreFormState();checkVersion();showWelcome();}

function saveFormState(){localStorage.setItem('dancemap_admin_form',JSON.stringify({formVersion:FORM_VERSION,payload:payload.value,dato:fields.dato.value,navn:fields.navn.value,start:fields.start.value,slut:fields.slut.value,dansTypes:getSelectedDanceTypes(),sted:fields.sted.value,adresse:fields.adresse.value,by:fields.by.value,prisType:fields.prisType.value,prisOnline:fields.prisOnline.value,prisDropin:fields.prisDropin.value,mobilepay:fields.mobilepay.value,mobilepayPris:fields.mobilepayPris.value,mobilepayInfo:fields.mobilepayInfo.value,recurring:recurring.checked,step:step2.style.display==='block'?2:1}));}

function restoreFormState(){try{const saved=localStorage.getItem('dancemap_admin_form');if(!saved){step1.style.display='block';step2.style.display='none';payload.value='';clearFields();return;}const s=JSON.parse(saved);payload.value=s.payload||'';fields.dato.value=s.dato||'';fields.navn.value=s.navn||'';fields.start.value=s.start||'';fields.slut.value=s.slut||'';if(s.dansTypes)setSelectedDanceTypes(s.dansTypes);else if(s.dans)setSelectedDanceTypes([s.dans]);updateDansField();fields.sted.value=s.sted||'';fields.adresse.value=s.adresse||'';fields.by.value=s.by||'KÃ¸benhavn';fields.prisType.value=s.prisType||'angiv';fields.prisOnline.value=s.prisOnline||'';fields.prisDropin.value=s.prisDropin||'';fields.mobilepay.value=s.mobilepay||'';fields.mobilepayPris.value=s.mobilepayPris||'';fields.mobilepayInfo.value=s.mobilepayInfo||'';recurring.checked=s.recurring||false;$('prisFields').style.display=s.prisType==='angiv'?'block':'none';$('mobilepayFields').style.display=s.prisType==='mobilepay'?'block':'none';if(s.step===2){step1.style.display='none';step2.style.display='block';updatePrisField();updatePreview();}else{step1.style.display='block';step2.style.display='none';}}catch(e){step1.style.display='block';step2.style.display='none';}}

function clearFormState(){localStorage.removeItem('dancemap_admin_form');}

function clearFields(){fields.dato.value='';fields.navn.value='';fields.start.value='';fields.slut.value='';document.querySelectorAll('input[name="dansetype"]').forEach(c=>c.checked=false);fields.dans.value='';fields.sted.value='';fields.adresse.value='';fields.by.value='KÃ¸benhavn';fields.pris.value='';fields.prisType.value='angiv';fields.prisOnline.value='';fields.prisDropin.value='';fields.mobilepay.value='';fields.mobilepayPris.value='';fields.mobilepayInfo.value='';$('prisFields').style.display='block';$('mobilepayFields').style.display='none';warnings.classList.remove('show');$('previewContent').innerHTML='';$('previewCard').style.borderColor='';}

$('closeAdmin').onclick=()=>{saveFormState();modal.classList.remove('open');};
$('backBtn').onclick=()=>{step1.style.display='block';step2.style.display='none';status.style.display='none';saveFormState();};
document.addEventListener('keydown',e=>{if(e.key==='Escape'&&modal.classList.contains('open')){saveFormState();modal.classList.remove('open');}});
payload.addEventListener('input',saveFormState);

// PARSE TEXT
const MONTHS={'januar':'01','februar':'02','marts':'03','april':'04','maj':'05','juni':'06','juli':'07','august':'08','september':'09','oktober':'10','november':'11','december':'12','jan':'01','feb':'02','mar':'03','apr':'04','jun':'06','jul':'07','aug':'08','sep':'09','okt':'10','nov':'11','dec':'12'};
const DANCE_ALIASES={'rueda de casino':'Salsa','rueda':'Salsa','cuban':'Salsa','cubansk':'Salsa','bachata':'Bachata','salsa':'Salsa','kizomba':'Kizomba','tango':'Tango','zouk':'Zouk','swing':'Swing','latin':'Latin'};
const VENUES=['kaffesalonen','kedelhallen','copenhagen salsa academy','csa','kulturhuset','dgi-byen'];
const VENUE_ADDRESSES={'kaffesalonen':{adresse:'Peblinge Dossering 7',by:'KÃ¸benhavn'},'kedelhallen':{adresse:'Nyelandsvej 75A',by:'Frederiksberg'},'copenhagen salsa academy':{adresse:'Kastanie AllÃ© 20',by:'VanlÃ¸se'},'csa':{adresse:'Kastanie AllÃ© 20',by:'VanlÃ¸se'},'kulturhuset':{adresse:'Islands Brygge 18',by:'KÃ¸benhavn'},'dgi-byen':{adresse:'Tietgensgade 65',by:'KÃ¸benhavn'}};

function parseTextToFields(txt){const t=txt.toLowerCase();const r={dato:'',navn:'',start:'',slut:'',dans:'Salsa',sted:'',adresse:'',by:'KÃ¸benhavn',pris:'',prisType:'angiv',prisOnline:'',prisDropin:''};const isoMatch=txt.match(/\b(20\d{2})-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])\b/);if(isoMatch)r.dato=isoMatch[0];else{const dm=txt.match(/\b(\d{1,2})\.?\s*(januar|februar|marts|april|maj|juni|juli|august|september|oktober|november|december|jan|feb|mar|apr|jun|jul|aug|sep|okt|nov|dec)\.?\s*(20\d{2})?\b/i);if(dm)r.dato=`${dm[3]||new Date().getFullYear()}-${MONTHS[dm[2].toLowerCase()]}-${dm[1].padStart(2,'0')}`;}const times=txt.match(/\b([01]?\d|2[0-3])[\.:,]([0-5]\d)\b/g);if(times?.length>0){r.start=times[0].replace(/[\.,]/g,':').replace(/^(\d):/,'0$1:');if(times.length>1)r.slut=times[times.length-1].replace(/[\.,]/g,':').replace(/^(\d):/,'0$1:');}for(const a of Object.keys(DANCE_ALIASES).sort((a,b)=>b.length-a.length)){if(t.includes(a)){r.dans=DANCE_ALIASES[a];break;}}for(const v of VENUES){if(t.includes(v)){r.sted=v.split(' ').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' ');if(VENUE_ADDRESSES[v]){r.adresse=VENUE_ADDRESSES[v].adresse;r.by=VENUE_ADDRESSES[v].by;}break;}}const lines=txt.split('\n').map(s=>s.trim()).filter(Boolean);if(lines[1])r.navn=lines[1];if(/\bgratis\b/i.test(txt)){r.prisType='gratis';r.pris='Gratis';}return r;}

function validateFields(){const e=[];if(!fields.dato.value)e.push('âŒ Dato mangler');if(!fields.navn.value)e.push('âŒ Navn mangler');if(!fields.start.value)e.push('âŒ Starttid mangler');if(!fields.slut.value)e.push('âŒ Sluttid mangler');if(getSelectedDanceTypes().length===0)e.push('âŒ VÃ¦lg mindst Ã©n dansetype');if(!fields.sted.value)e.push('âŒ Sted mangler');if(!fields.adresse.value)e.push('âŒ Adresse mangler');if(!fields.by.value)e.push('âŒ By mangler');if(fields.prisType.value==='angiv'&&!fields.prisOnline.value&&!fields.prisDropin.value)e.push('âŒ Angiv mindst Ã©n pris');if(fields.prisType.value==='mobilepay'&&!fields.mobilepayPris.value)e.push('âŒ Angiv MobilePay pris');return{errors:e};}

function updatePreview(){updateDansField();updatePrisField();const dage=['SÃ¸n','Man','Tir','Ons','Tor','Fre','LÃ¸r'];const mdr=['jan','feb','mar','apr','maj','jun','jul','aug','sep','okt','nov','dec'];let datoStr='â€”';if(fields.dato.value){const d=new Date(fields.dato.value);if(!isNaN(d.getTime())){datoStr=dage[d.getDay()]+' '+d.getDate()+'. '+mdr[d.getMonth()];if(recurring.checked)datoStr+=' ğŸ”';}}let tidStr=fields.start.value||'â€”';if(fields.slut.value)tidStr+='â€“'+fields.slut.value;let stedStr=fields.sted.value||'â€”';if(fields.adresse.value)stedStr+=', '+fields.adresse.value;if(fields.by.value)stedStr+=', '+fields.by.value;const dansStr=fields.dans.value||'â€”';const previewEl=$('previewContent');previewEl.innerHTML=`<div class="line"><span class="icon">ğŸ—“</span><span>${esc(datoStr)}</span></div><div class="line"><span class="icon">ğŸ“Œ</span><span>${esc(fields.navn.value||'â€”')}</span></div><div class="line"><span class="icon">ğŸ•—</span><span>${esc(tidStr)}</span></div><div class="line"><span class="icon">ğŸ’ƒ</span><span>${esc(dansStr)}</span></div><div class="line"><span class="icon">ğŸ“</span><span>${esc(stedStr)}</span></div><div class="line"><span class="icon">ğŸ’°</span><span>${esc(fields.pris.value||'â€”')}</span></div>`;const{errors}=validateFields();const pc=$('previewCard');pc.querySelector('.preview-label').textContent=errors.length===0?'âœ… Klar':'ForhÃ¥ndsvisning';pc.style.borderColor=errors.length===0?'#3fb950':'';}

Object.values(fields).forEach(f=>{if(f?.addEventListener){f.addEventListener('input',()=>{updatePrisField();updatePreview();saveFormState();});f.addEventListener('change',()=>{updatePrisField();updatePreview();saveFormState();});}});
recurring.addEventListener('change',()=>{updatePreview();saveFormState();});
// Also listen to mobilepay fields specifically
if(fields.mobilepay)fields.mobilepay.addEventListener('input',()=>{updatePrisField();updatePreview();saveFormState();});
if(fields.mobilepayPris)fields.mobilepayPris.addEventListener('input',()=>{updatePrisField();updatePreview();saveFormState();});
if(fields.mobilepayInfo)fields.mobilepayInfo.addEventListener('input',()=>{updatePrisField();updatePreview();saveFormState();});

$('parseBtn').onclick=()=>{const txt=payload.value.trim();if(!txt)return;const p=parseTextToFields(txt);fields.dato.value=p.dato;fields.navn.value=p.navn;fields.start.value=p.start;fields.slut.value=p.slut;setSelectedDanceTypes([p.dans]);updateDansField();fields.sted.value=p.sted;fields.adresse.value=p.adresse;fields.by.value=p.by;fields.prisType.value=p.prisType;fields.prisOnline.value=p.prisOnline;fields.prisDropin.value=p.prisDropin;$('prisFields').style.display=p.prisType==='angiv'?'block':'none';$('mobilepayFields').style.display=p.prisType==='mobilepay'?'block':'none';updatePrisField();const{errors}=validateFields();if(errors.length){warnings.innerHTML=errors.join('<br>');warnings.classList.add('show');}else{warnings.classList.remove('show');}updatePreview();step1.style.display='none';step2.style.display='block';saveFormState();};

// CLAUDE VISION (via Vercel proxy)
async function processImageWithClaude(file){
  ocrStatus.style.display='block';
  ocrStatus.innerHTML='ğŸ¤– <span class="loading-text">Claude analyserer billede...</span>';
  try{
    const base64=await fileToBase64(file);
    const mediaType=file.type||'image/png';
    const response=await fetch('/api/parse-image',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({image:base64,mediaType:mediaType})
    });
    const result=await response.json();
    if(!result.success){ocrStatus.innerHTML='âŒ '+(result.error||'Fejl');ocrStatus.style.color='#f85149';return;}
    const d=result.data;
    if(d.dato)fields.dato.value=d.dato;
    if(d.navn)fields.navn.value=d.navn;
    if(d.starttid)fields.start.value=d.starttid;
    if(d.sluttid)fields.slut.value=d.sluttid;
    if(d.dansetype){setSelectedDanceTypes(d.dansetype.split(/\s*[&,\/]\s*/));updateDansField();}
    if(d.sted)fields.sted.value=d.sted;
    if(d.adresse)fields.adresse.value=d.adresse;
    if(d.by)fields.by.value=d.by;
    if(d.pris){if(d.pris.toLowerCase()==='gratis'){fields.prisType.value='gratis';$('prisFields').style.display='none';}else{fields.prisType.value='angiv';$('prisFields').style.display='block';const prisMatch=d.pris.match(/(\d+)/g);if(prisMatch){if(prisMatch.length>=2){fields.prisOnline.value=prisMatch[0];fields.prisDropin.value=prisMatch[1];}else{fields.prisDropin.value=prisMatch[0];}}}}
    updatePrisField();updatePreview();
    const confidence=Math.round((result.confidence||0.8)*100);
    ocrStatus.innerHTML=`âœ… Parsed med ${confidence}% sikkerhed`;
    ocrStatus.style.color=confidence>80?'#3fb950':'#f0883e';
    step1.style.display='none';step2.style.display='block';
    const{errors}=validateFields();
    if(errors.length){warnings.innerHTML=errors.join('<br>');warnings.classList.add('show');}else{warnings.classList.remove('show');}
    saveFormState();
    await checkForDuplicates();
    setTimeout(()=>ocrStatus.style.display='none',3000);
  }catch(err){console.error('Claude Vision error:',err);ocrStatus.innerHTML='âŒ '+(err.message||'NetvÃ¦rksfejl');ocrStatus.style.color='#f85149';}
}

async function checkForDuplicates(){
  const params=new URLSearchParams();
  params.set('action','check-duplicate');
  params.set('dato',fields.dato.value);
  params.set('navn',fields.navn.value);
  params.set('starttid',fields.start.value);
  params.set('sted',fields.sted.value);
  params.set('dansetype',fields.dans.value);
  params.set('_',Date.now());
  try{
    const result=await jsonp(API+'?'+params.toString());
    if(result.success&&result.matches&&result.matches.length>0){
      const match=result.matches[0];
      if(result.isDuplicate){
        warnings.innerHTML=`âš ï¸ <strong>Mulig dublet fundet!</strong><br><br>ğŸ“… ${esc(match.dato)}<br>ğŸ“Œ ${esc(match.navn)}<br>ğŸ•— ${esc(match.starttid)}<br>ğŸ“ ${esc(match.sted)}<br><span style="color:#7d8590">(${match.reasons.join(', ')})</span><br><br><span style="color:#f85149">Status: ${match.status}</span>`;
        warnings.classList.add('show');
        $('previewCard').style.borderColor='#f85149';
        $('previewCard').querySelector('.preview-label').textContent='â›” Sandsynlig dublet';
      }else if(result.isLikelyDuplicate){
        warnings.innerHTML=`âš ï¸ <strong>Lignende event findes:</strong><br><br>ğŸ“… ${esc(match.dato)}<br>ğŸ“Œ ${esc(match.navn)}<br>ğŸ“ ${esc(match.sted)}<br><span style="color:#7d8590">(${match.reasons.join(', ')})</span><br><br><span style="color:#f0883e">Du kan stadig tilfÃ¸je eventet hvis det er forskelligt.</span>`;
        warnings.classList.add('show');
        $('previewCard').style.borderColor='#f0883e';
        $('previewCard').querySelector('.preview-label').textContent='âš ï¸ Tjek for dublet';
      }
    }
  }catch(err){console.log('Duplicate check failed:',err);}
}

function fileToBase64(file){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.onload=()=>resolve(reader.result);reader.onerror=reject;reader.readAsDataURL(file);});}

$('uploadBtn').onclick=()=>$('fileInput').click();

// RYD ALT KNAP
$('clearAllBtn').onclick=()=>{
  if(confirm('Ryd alle felter og start forfra?')){
    clearFields();
    clearFormState();
    payload.value='';
    preview.style.display='none';
    ocrStatus.style.display='none';
    step1.style.display='block';
    step2.style.display='none';
    status.style.display='none';
    warnings.classList.remove('show');
  }
};

// PASTE FRA UDKLIPSHOLDER KNAP
$('pasteBtn').onclick=async()=>{
  try{
    const items=await navigator.clipboard.read();
    for(const item of items){
      const imageType=item.types.find(t=>t.startsWith('image/'));
      if(imageType){
        const blob=await item.getType(imageType);
        const file=new File([blob],'pasted-image.png',{type:imageType});
        preview.src=URL.createObjectURL(file);
        preview.style.display='block';
        processImageWithClaude(file);
        return;
      }
    }
    ocrStatus.style.display='block';
    ocrStatus.innerHTML='ğŸ“‹ Ingen billede i udklipsholder';
    ocrStatus.style.color='#f0883e';
    setTimeout(()=>ocrStatus.style.display='none',2000);
  }catch(err){
    console.log('Clipboard access denied, trying paste event');
    ocrStatus.style.display='block';
    ocrStatus.innerHTML='ğŸ’¡ Brug Ctrl+V for at indsÃ¦tte';
    ocrStatus.style.color='#7d8590';
    setTimeout(()=>ocrStatus.style.display='none',2000);
  }
};

// ADMIN VELKOMMEN
function showWelcome(){
  const name=localStorage.getItem('dancemap_admin_name');
  if(name){
    $('adminWelcome').style.display='block';
    $('welcomeText').textContent='Velkommen '+name+'! ğŸ‰';
  }else{
    const entered=prompt('Hvad hedder du? (vises nÃ¥r du Ã¥bner admin)');
    if(entered&&entered.trim()){
      localStorage.setItem('dancemap_admin_name',entered.trim());
      $('adminWelcome').style.display='block';
      $('welcomeText').textContent='Velkommen '+entered.trim()+'! ğŸ‰';
    }
  }
}

$('fileInput').onchange=e=>{const f=e.target.files[0];if(f?.type.startsWith('image/')){preview.src=URL.createObjectURL(f);preview.style.display='block';processImageWithClaude(f);}e.target.value='';};
modal.onpaste=e=>{const items=e.clipboardData?.items||[];for(const item of items){if(item.type.startsWith('image/')){e.preventDefault();const f=item.getAsFile();preview.src=URL.createObjectURL(f);preview.style.display='block';processImageWithClaude(f);return;}}};


// ADMIN SUBMIT
let isSubmitting=false;
$('adminSubmitBtn').onclick=async()=>{
  if(isSubmitting)return;
  const{errors}=validateFields();
  if(errors.length){warnings.innerHTML=errors.join('<br>');warnings.classList.add('show');status.style.display='block';status.textContent='Udfyld alle felter';status.className='submit-status error';return;}
  warnings.classList.remove('show');
  const params=new URLSearchParams();
  params.set('action','admin-import');
  params.set('dato',fields.dato.value);
  params.set('navn',fields.navn.value);
  params.set('starttid',fields.start.value);
  params.set('sluttid',fields.slut.value);
  params.set('dansetype',fields.dans.value);
  params.set('sted',fields.sted.value);
  params.set('adresse',fields.adresse.value);
  params.set('by',fields.by.value);
  params.set('pris',fields.pris.value);
  params.set('recurring',recurring.checked);
  params.set('kilde',localStorage.getItem('dancemap_admin_name')||'Admin');
  params.set('_',Date.now());
  const btn=$('adminSubmitBtn');
  btn.disabled=true;btn.textContent='Sender...';
  isSubmitting=true;
  status.style.display='none';
  try{
    const data=await jsonp(API+'?'+params.toString());
    status.style.display='block';
    if(data.success){status.textContent='Event tilfÃ¸jet (pending)';status.className='submit-status success';$('previewCard').style.borderColor='#3fb950';clearFields();clearFormState();step1.style.display='block';step2.style.display='none';payload.value='';preview.style.display='none';recurring.checked=false;}
    else if(data.error==='DUPLICATE'){status.textContent='âš ï¸ Dublet fundet';status.className='submit-status error';$('previewCard').style.borderColor='#f85149';}
    else{status.textContent=data.text||'âŒ Fejl';status.className='submit-status error';}
  }catch(e){status.style.display='block';status.textContent='âŒ Teknisk fejl';status.className='submit-status error';}
  btn.disabled=false;btn.textContent='TilfÃ¸j Event (pending)';
  isSubmitting=false;
};

addMsg('Skriv fx: salsa eller bachata',false);

async function loadWeekCount(){try{const d=await jsonp(API+'?action=weekcount&_='+Date.now());if(d.success&&d.count>0)$('weekCount').textContent=d.count+' events denne uge';}catch(e){}}
loadWeekCount();

// ADMIN TABS
const tabAdd=$('tabAdd'),tabPending=$('tabPending');
const adminAddView=$('adminAddView'),adminPendingView=$('adminPendingView');
tabAdd.onclick=()=>{tabAdd.classList.add('active');tabPending.classList.remove('active');adminAddView.style.display='block';adminPendingView.style.display='none';};
tabPending.onclick=()=>{tabPending.classList.add('active');tabAdd.classList.remove('active');adminAddView.style.display='none';adminPendingView.style.display='block';loadPendingList();};

async function loadPendingList(){
  const list=$('pendingList'),empty=$('pendingEmpty');
  list.innerHTML='<div style="color:#7d8590;text-align:center;padding:20px;">Henter...</div>';
  empty.style.display='none';
  try{
    const data=await jsonp(API+'?action=list-pending&_='+Date.now());
    if(!data.success||!data.events?.length){list.innerHTML='';empty.style.display='block';return;}
    list.innerHTML=data.events.map(e=>`<div class="pending-item" data-row="${e.row}"><div class="pending-item-header"><span class="pending-item-title">${esc(e.navn)}</span></div><div class="pending-item-details"><div class="pending-item-row"><span>ğŸ—“</span><span>${esc(e.dato)}</span></div><div class="pending-item-row"><span>ğŸ•—</span><span>${esc(e.starttid)}â€“${esc(e.sluttid)}</span></div><div class="pending-item-row"><span>ğŸ’ƒ</span><span>${esc(e.dansetype)}</span></div><div class="pending-item-row"><span>ğŸ“</span><span>${esc(e.sted)}, ${esc(e.adresse)}, ${esc(e.by)}</span></div><div class="pending-item-row"><span>ğŸ’°</span><span>${esc(e.pris)}</span></div>${e.insertedAt?`<div class="pending-item-row" style="font-size:11px;color:#7d8590"><span>ğŸ“¥</span><span>TilfÃ¸jet: ${esc(e.insertedAt)}</span></div>`:''}</div><div class="pending-actions"><button class="pending-approve-btn" onclick="changeStatus(${e.row},'active')">Godkend âœ“</button><button style="padding:10px 12px;background:#da3633;color:white;border:none;border-radius:8px;cursor:pointer;font-size:13px;" onclick="deleteEvent(${e.row})">Afvis âœ•</button></div></div>`).join('');
    empty.style.display='none';
  }catch(e){list.innerHTML='<div style="color:#f85149;text-align:center;padding:20px;">Fejl</div>';}
}

async function changeStatus(row,nextStatus){
  const item=document.querySelector(`.pending-item[data-row="${row}"]`);
  const btn=item?.querySelector('.pending-approve-btn');
  if(btn){btn.disabled=true;btn.textContent='Opdaterer...';}
  try{
    const data=await jsonp(API+'?action=update-status&row='+row+'&status='+encodeURIComponent(nextStatus)+'&_='+Date.now());
    if(data?.success&&nextStatus==='active'){if(item){item.style.background='#238636';if(btn)btn.textContent='âœ“ Godkendt';setTimeout(()=>item.remove(),600);}loadWeekCount();}
    else{if(btn){btn.disabled=false;btn.textContent='Fejl';}}
  }catch(e){if(btn){btn.disabled=false;btn.textContent='Fejl';}}
}

async function deleteEvent(row){
  if(!confirm('Er du sikker pÃ¥ du vil afvise dette event?'))return;
  const item=document.querySelector(`.pending-item[data-row="${row}"]`);
  try{
    const data=await jsonp(API+'?action=delete-row&row='+row+'&_='+Date.now());
    if(data?.success){if(item){item.style.background='#da3633';item.style.opacity='0.5';setTimeout(()=>item.remove(),400);}}
  }catch(e){}
}

$('refreshPending').onclick=loadPendingList;

if('serviceWorker' in navigator)navigator.serviceWorker.register('/sw.js').catch(()=>{});
</script>
</body>
</html>
