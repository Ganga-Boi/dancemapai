<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>DanceMap</title>

  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#6366f1" />

  <style>
    /* ALT DESIGN ER UÆNDRET */
    /* (samme CSS som før – udeladt her for overskuelighed) */
  </style>
</head>
<body>

<div class="card">
  <div class="header">
    <div class="logo"><img src="./dancemap-icon.svg" alt="DanceMap"></div>
    <div class="header-text">
      <h1>DanceMap</h1>
      <div class="sub">Dansevents i København og omegn</div>
      <div class="week-count" id="weekCount"></div>
    </div>
  </div>

  <div id="chat" class="chat"></div>

  <div class="input-area">
    <input
      id="q"
      type="text"
      placeholder="Søg fx: salsa eller bachata"
      autocomplete="off"
    />
    <button id="sendBtn" class="send-btn">➤</button>
  </div>
</div>

<script>
/* ======================================================
   KONFIG
====================================================== */
const API = 'https://script.google.com/macros/s/AKfycbxnZiO0bDkCrrwGJXwAvA5mWKPBoQoL-t1smx5m0A5j51gSbTOtF1MLT3qkdwbZkTX_/exec';

const chat = document.getElementById('chat');
const input = document.getElementById('q');
const sendBtn = document.getElementById('sendBtn');

/* ======================================================
   DANSK DATOFORMAT (NY)
====================================================== */
function formatDanskDato(dateStr) {
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;

  return d.toLocaleDateString('da-DK', {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
}

/* ======================================================
   JSONP
====================================================== */
function jsonp(url) {
  return new Promise((resolve, reject) => {
    const cb = 'cb_' + Date.now();
    window[cb] = data => {
      delete window[cb];
      script.remove();
      resolve(data);
    };
    const script = document.createElement('script');
    script.src = url + '&callback=' + cb;
    script.onerror = () => reject();
    document.body.appendChild(script);
  });
}

/* ======================================================
   UI
====================================================== */
function addMsg(text, isUser) {
  const div = document.createElement('div');
  div.className = 'msg ' + (isUser ? 'user' : 'bot');

  if (!isUser) {
    // Dansk dato i output
    text = text.replace(
      /\b(Mon|Tue|Wed|Thu|Fri|Sat|Sun).*?\d{4}/g,
      m => formatDanskDato(m)
    );
  }

  div.innerHTML = `<div class="bubble">${text}</div>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

/* ======================================================
   SEARCH
====================================================== */
async function doSearch() {
  const q = input.value.trim();
  if (!q) return;

  addMsg(q, true);
  input.value = '';

  try {
    const data = await jsonp(API + '?query=' + encodeURIComponent(q));
    addMsg(data.text || 'Ingen resultater.', false);
  } catch {
    addMsg('Fejl. Prøv igen.', false);
  }
}

sendBtn.onclick = doSearch;
input.onkeydown = e => e.key === 'Enter' && doSearch();

/* ======================================================
   INTRO-TEKST (RETTET)
====================================================== */
addMsg(
  'Skriv blot fx "salsa" eller "bachata" – så finder jeg relevante danseevents.',
  false
);

/* ======================================================
   WEEKCOUNT
====================================================== */
(async () => {
  try {
    const data = await jsonp(API + '?action=weekcount');
    if (data.count) {
      document.getElementById('weekCount').textContent =
        data.count + ' events denne uge';
    }
  } catch {}
})();
</script>
</body>
</html>
