<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DanceMap AI</title>

    <style>
        body { margin: 0; background: linear-gradient(180deg, #022237, #011520); font-family: "Segoe UI", sans-serif; color: #fff; }
        .app { height: 100vh; display: flex; flex-direction: column; }
        .topbar { height: 64px; background: #011c2b; display: flex; align-items: center; padding: 0 16px; font-size: 20px; font-weight: 600; }
        .topbar img { width: 38px; height: 38px; margin-right: 10px; border-radius: 50%; }
        #chat { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }
        .message { display: flex; align-items: flex-start; margin-bottom: 20px; gap: 12px; }
        .message img { width: 40px; height: 40px; border-radius: 50%; }
        .bubble { background: rgba(255, 255, 255, 0.08); padding: 14px 18px; border-radius: 16px; max-width: 70%; line-height: 1.6; }
        .message.user { flex-direction: row-reverse; }
        .message.user .bubble { background: #2a5a7a; }
        .input-area { position: fixed; bottom: 0; left: 0; right: 0; background: #011c2b; padding: 16px; display: flex; gap: 10px; }
        #userInput { flex: 1; padding: 12px 16px; border-radius: 24px; border: 1px solid #2a5a7a; background: rgba(255,255,255,0.05); color: #fff; }
        #sendBtn { width: 48px; height: 48px; border-radius: 50%; background: #4a90e2; border: none; color: white; cursor: pointer; font-size: 20px; }
        .typing { display:none; align-items:center; gap:12px; }
        .typing.active { display:flex; }
    </style>
</head>

<body>
    <div class="app">
        <div class="topbar">
            <img src="dancemap-icon.png" />
            <span>DanceMap AI</span>
        </div>

        <div id="chat">
            <div class="message bot">
                <img src="dancemap-icon.png" />
                <div class="bubble">
Velkommen til DanceMap AI! üíÉ  
Find salsa, bachata, kizomba og danseevents i DK!
                </div>
            </div>
        </div>

        <div class="typing" id="typing">
            <img src="dancemap-icon.png" />
            <div class="bubble">...</div>
        </div>

        <button class="fab" onclick="startEventSubmission()">üìù</button>

        <div class="input-area">
            <input id="userInput" placeholder="Skriv en besked..." autocomplete="off" />
            <button id="sendBtn" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwLZ-irHmdb-Fqj71-bjByWeocCtx0aWOq3l-fOy3g1nb7hMgINivHm8qpdy8v_bsVM/exec";

let sessionId = "session_" + Date.now();

// SUBMISSION STATE
let submissionState = { active:false, step:0, data:{} };

function startEventSubmission() {
    submissionState = { active:true, step:1, data:{} };
    addMessage("üìù Lad os tilf√∏je et event!\nDato?", "bot");
}

document.getElementById("userInput").addEventListener("keypress", e => {
    if (e.key === "Enter") sendMessage();
});

async function sendMessage() {
    let msg = document.getElementById("userInput").value.trim();
    if (!msg) return;
    addMessage(msg, "user");
    document.getElementById("userInput").value = "";

    if (submissionState.active) {
        handleGuided(msg);
        return;
    }

    showTyping(true);
    const r = await fetch(`${SCRIPT_URL}?message=${encodeURIComponent(msg)}&sessionId=${sessionId}`);
    const json = await r.json();
    showTyping(false);
    addMessage(json.reply, "bot");
}

function handleGuided(msg) {
    let s = submissionState;

    if (s.step === 1) { s.data.dato = msg; s.step = 2; addMessage("Tidspunkt?", "bot"); return; }
    if (s.step === 2) { s.data.tid = msg; s.step = 3; addMessage("Type? (Salsa/Bachata/Kizomba)", "bot"); return; }
    if (s.step === 3) { s.data.type = msg; s.step = 4; addMessage("Sted?", "bot"); return; }
    if (s.step === 4) { s.data.sted = msg; s.step = 5; addMessage("By?", "bot"); return; }
    if (s.step === 5) {
        s.data.by = msg;
        s.step = 6;
        addMessage(`Er dette korrekt?\n\nüìÖ ${s.data.dato} kl. ${s.data.tid}\nüíÉ ${s.data.type}\nüìç ${s.data.sted}, ${s.data.by}`, "bot");
        return;
    }

    if (s.step === 6) {
        if (msg.toLowerCase().startsWith("j")) submitEvent();
        else { submissionState = { active:false, step:0, data:{} }; addMessage("Annulleret.", "bot"); }
    }
}

async function submitEvent() {
    let d = submissionState.data;
    let text = `${d.dato}, ${d.tid}, ${d.type}, ${d.sted}, ${d.by}`;

    addMessage(text, "user");
    showTyping(true);

    // üî• DEN VIGTIGE OPDATERING:
    const r = await fetch(
        `${SCRIPT_URL}?submission=guided&message=${encodeURIComponent(text)}&sessionId=${sessionId}`
    );

    const json = await r.json();
    showTyping(false);
    addMessage(json.reply, "bot");
    submissionState = { active:false, step:0, data:{} };
}

function addMessage(text, sender) {
    const chat = document.getElementById("chat");
    const div = document.createElement("div");
    div.className = "message " + sender;

    const img = document.createElement("img");
    img.src = sender === "user" ? "user-icon.svg" : "dancemap-icon.png";

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.innerHTML = text.replace(/\n/g, "<br>");

    div.appendChild(img);
    div.appendChild(bubble);
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function showTyping(on) {
    document.getElementById("typing").classList.toggle("active", on);
}
</script>

</body>
</html>
