<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DanceMap</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0f14; color:#e8eef7; }
    .wrap { max-width:480px; margin:0 auto; height:100vh; display:flex; flex-direction:column; }
    .header { padding:14px 16px; border-bottom:1px solid #1a2432; background:#0e141d; display:flex; align-items:center; gap:10px; }
    .header-avatar { width:40px; height:40px; border-radius:50%; cursor:pointer; }
    @media (min-width:600px){ .header-avatar{width:44px;height:44px;} }
    .header-text h1{margin:0;font-size:18px;font-weight:600}
    .header-text .sub{font-size:12px;opacity:.65}
    .chat{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
    .row{display:flex}
    .row.user{justify-content:flex-end}
    .row.bot{justify-content:flex-start}
    .bubble{max-width:85%;padding:10px 14px;border-radius:16px;white-space:pre-wrap;font-size:14px}
    .user .bubble{background:#1e3a5f;border-bottom-right-radius:4px}
    .bot .bubble{background:#1a2432;border-bottom-left-radius:4px}
    .typing .bubble{font-style:italic;opacity:.65}
    .more-btn{align-self:flex-start;padding:8px 14px;border-radius:12px;border:1px solid #2a3b54;background:#0e141d;color:#9fc5ff;cursor:pointer}
    .more-btn:hover{background:#142235}
    .more-btn:disabled{opacity:.5;cursor:not-allowed}
    .bar{display:flex;gap:10px;padding:12px 16px;border-top:1px solid #1a2432;background:#0e141d}
    .bar input{flex:1;padding:12px 14px;border-radius:20px;border:1px solid #1a2432;background:#0b1017;color:#e8eef7;font-size:14px;outline:none}
    .bar input:focus{border-color:#2a3b54}
    .bar input::placeholder{color:#5a6a7a}
    .send-btn{width:44px;height:44px;border-radius:50%;border:none;background:#1e3a5f;color:#e8eef7;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .send-btn:hover{background:#2a4a70}
    .send-btn:disabled{opacity:.5;cursor:not-allowed}
    .send-btn svg{width:20px;height:20px}
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:flex-end;justify-content:center}
    .modal-overlay.open{display:flex}
    .modal{width:100%;max-width:480px;background:#0e141d;border-top-left-radius:20px;border-top-right-radius:20px;padding:20px 16px 24px;animation:slideUp .18s ease-out;max-height:90vh;overflow-y:auto}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .modal-header h2{margin:0;font-size:18px;font-weight:600}
    .modal-close{background:none;border:none;color:#9fc5ff;font-size:24px;cursor:pointer;padding:0;line-height:1}
    .form-group{margin-bottom:12px}
    .form-group label{display:block;font-size:13px;margin-bottom:6px;opacity:.8}
    .form-group textarea{width:100%;min-height:150px;padding:10px 12px;border-radius:10px;border:1px solid #1a2432;background:#0b1017;color:#e8eef7;font-size:14px;outline:none;resize:vertical}
    .form-group textarea:focus{border-color:#2a3b54}
    .checkbox-group{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .checkbox-group input[type="checkbox"]{width:20px;height:20px;accent-color:#1e88e5}
    .checkbox-group label{font-size:14px;cursor:pointer}
    .submit-btn{width:100%;padding:14px;border-radius:12px;border:none;background:#1e3a5f;color:#e8eef7;font-size:15px;font-weight:500;cursor:pointer}
    .submit-btn:hover{background:#2a4a70}
    .submit-btn:disabled{opacity:.5;cursor:not-allowed}
    .submit-status{text-align:center;padding:10px;font-size:14px;margin-top:10px}
    .submit-status.success{color:#4ade80}
    .submit-status.error{color:#ff6b6b}
    .upload-row{display:flex;gap:10px;margin-bottom:12px}
    .upload-btn{flex:1;padding:12px;border-radius:10px;border:1px dashed #2a3b54;background:transparent;color:#9fc5ff;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
    .upload-btn:hover{background:#142235;border-color:#3a4b64}
    .upload-btn svg{width:18px;height:18px}
    .ocr-status{font-size:12px;color:#9fc5ff;text-align:center;padding:8px;opacity:.8}
    .image-preview{max-width:100%;max-height:120px;border-radius:8px;margin-bottom:10px;display:none}
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <img class="header-avatar" src="./dancemap-icon.svg" alt="DanceMap" />
    <div class="header-text">
      <h1>DanceMap</h1>
      <div class="sub">Danseevents i København og omegn</div>
    </div>
  </div>

  <div id="chat" class="chat" aria-live="polite"></div>

  <div class="bar">
    <input id="q" type="text" placeholder="Skriv fx: salsa i dag" autocomplete="off" />
    <button id="sendBtn" class="send-btn" type="button" aria-label="Send">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    </button>
  </div>
</div>

<!-- Admin Modal -->
<div class="modal-overlay" id="adminModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Admin: Tilføj Event</h2>
      <button class="modal-close" id="closeAdmin">&times;</button>
    </div>

    <div class="upload-row">
      <button type="button" class="upload-btn" id="uploadBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <circle cx="8.5" cy="8.5" r="1.5"></circle>
          <polyline points="21 15 16 10 5 21"></polyline>
        </svg>
        Upload billede
      </button>
      <input type="file" id="fileInput" accept="image/*" style="display:none" />
    </div>

    <img id="imagePreview" class="image-preview" />
    <div id="ocrStatus" class="ocr-status" style="display:none"></div>

    <div class="form-group">
      <label>Paste tekst eller billede (Ctrl+V)</label>
      <textarea id="adminPayload" placeholder="Paste tekst her…&#10;&#10;Eller upload/paste et skærmbillede&#10;&#10;Eksempel:&#10;Kedelhallen&#10;2025-01-20 20:30-02:00&#10;Salsa&#10;100 kr"></textarea>
    </div>

    <div class="checkbox-group">
      <input type="checkbox" id="recurringCheck" />
      <label for="recurringCheck">Gentager ugentligt</label>
    </div>

    <button type="button" class="submit-btn" id="adminSubmitBtn">Tilføj til Events</button>
    <div id="adminStatus" class="submit-status"></div>
  </div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbxnZiO0bDkCrrwGJXwAvA5mWKPBoQoL-t1smx5m0A5j51gSbTOtF1MLT3qkdwbZkTX_/exec';

const chatEl = document.getElementById('chat');
const qEl = document.getElementById('q');
const sendBtn = document.getElementById('sendBtn');
const adminModal = document.getElementById('adminModal');
const closeAdminBtn = document.getElementById('closeAdmin');
const adminPayloadEl = document.getElementById('adminPayload');
const adminSubmitBtn = document.getElementById('adminSubmitBtn');
const adminStatus = document.getElementById('adminStatus');
const uploadBtn = document.getElementById('uploadBtn');
const fileInput = document.getElementById('fileInput');
const imagePreview = document.getElementById('imagePreview');
const ocrStatus = document.getElementById('ocrStatus');
const recurringCheck = document.getElementById('recurringCheck');

let lastQuery = '';
let currentPage = 0;
let hasMore = false;
let isLoading = false;
let currentMoreBtn = null;
let typingRow = null;

function addUserMessage(text) {
  const row = document.createElement('div');
  row.className = 'row user';
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.textContent = text;
  row.appendChild(bubble);
  chatEl.appendChild(row);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function showTyping() {
  removeTyping();
  const row = document.createElement('div');
  row.className = 'row bot typing';
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.textContent = 'DanceMap skriver …';
  row.appendChild(bubble);
  chatEl.appendChild(row);
  typingRow = row;
  chatEl.scrollTop = chatEl.scrollHeight;
}

function removeTyping() {
  if (typingRow) {
    typingRow.remove();
    typingRow = null;
  }
}

function addBotMessage(text, showMore) {
  removeTyping();

  const row = document.createElement('div');
  row.className = 'row bot';
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.textContent = text;
  row.appendChild(bubble);
  chatEl.appendChild(row);

  if (currentMoreBtn) {
    currentMoreBtn.remove();
    currentMoreBtn = null;
  }

  if (showMore) {
    const btn = document.createElement('button');
    btn.className = 'more-btn';
    btn.textContent = 'Vis flere';
    btn.addEventListener('click', handleMore);
    chatEl.appendChild(btn);
    currentMoreBtn = btn;
  }

  chatEl.scrollTop = chatEl.scrollHeight;
}

function setLoading(on) {
  isLoading = on;
  sendBtn.disabled = on;
  if (currentMoreBtn) currentMoreBtn.disabled = on;
  adminSubmitBtn.disabled = on;
}

async function callApi(query, page) {
  const url = new URL(API_URL);
  url.searchParams.set('query', query);
  url.searchParams.set('page', String(page));
  url.searchParams.set('_ts', String(Date.now()));

  const res = await fetch(url.toString(), { method: 'GET', cache: 'no-store' });
  const raw = await res.text();

  if (!res.ok) throw new Error('HTTP_' + res.status);
  if (raw.trim().startsWith('<')) throw new Error('HTML_RESPONSE');

  return JSON.parse(raw);
}

async function handleSend() {
  const trimmed = (qEl.value || '').trim();
  if (!trimmed || isLoading) return;

  addUserMessage(trimmed);
  qEl.value = '';
  lastQuery = trimmed;
  currentPage = 0;
  hasMore = false;

  setLoading(true);
  showTyping();

  try {
    const data = await callApi(trimmed, 0);

    if (!data || typeof data.success !== 'boolean') {
      addBotMessage('Der opstod en teknisk fejl. Prøv igen senere.', false);
      return;
    }

    if (!data.success) {
      addBotMessage(data.text || 'Der opstod en teknisk fejl. Prøv igen senere.', false);
      return;
    }

    hasMore = !!data.hasMore;
    addBotMessage(data.text || 'Der er ingen danseevents, der matcher din forespørgsel.', hasMore);

  } catch (e) {
    addBotMessage('Der opstod en teknisk fejl. Prøv igen senere.', false);
  } finally {
    setLoading(false);
  }
}

async function handleMore() {
  if (isLoading || !hasMore) return;

  currentPage += 1;
  setLoading(true);
  showTyping();

  try {
    const data = await callApi(lastQuery, currentPage);

    if (!data || !data.success) {
      addBotMessage('Der opstod en teknisk fejl. Prøv igen senere.', false);
      hasMore = false;
      return;
    }

    hasMore = !!data.hasMore;
    addBotMessage(data.text, hasMore);

  } catch (e) {
    addBotMessage('Der opstod en teknisk fejl. Prøv igen senere.', false);
    hasMore = false;
  } finally {
    setLoading(false);
  }
}

sendBtn.addEventListener('click', handleSend);

qEl.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    handleSend();
  }
});

// ADMIN: Triple-click på logo
let logoClickCount = 0;
let logoClickTimer = null;
document.querySelector('.header-avatar').addEventListener('click', () => {
  logoClickCount++;
  if (logoClickCount === 3) {
    logoClickCount = 0;
    clearTimeout(logoClickTimer);
    adminModal.classList.add('open');
    adminStatus.textContent = '';
    adminStatus.className = 'submit-status';
    imagePreview.style.display = 'none';
    ocrStatus.style.display = 'none';
    recurringCheck.checked = false;
    setTimeout(() => adminPayloadEl.focus(), 0);
  } else {
    clearTimeout(logoClickTimer);
    logoClickTimer = setTimeout(() => { logoClickCount = 0; }, 500);
  }
});

closeAdminBtn.addEventListener('click', () => adminModal.classList.remove('open'));
adminModal.addEventListener('click', (e) => { if (e.target === adminModal) adminModal.classList.remove('open'); });

// OCR funktion
async function processImage(imageSource) {
  ocrStatus.style.display = 'block';
  ocrStatus.textContent = 'Læser billede...';

  try {
    const result = await Tesseract.recognize(imageSource, 'dan+eng', {
      logger: m => {
        if (m.status === 'recognizing text') {
          ocrStatus.textContent = `Læser billede... ${Math.round(m.progress * 100)}%`;
        }
      }
    });

    const text = result.data.text.trim();
    if (text) {
      adminPayloadEl.value = text;
      ocrStatus.textContent = '✅ Tekst fundet!';
      setTimeout(() => { ocrStatus.style.display = 'none'; }, 2000);
    } else {
      ocrStatus.textContent = '⚠️ Ingen tekst fundet i billedet';
    }
  } catch (err) {
    ocrStatus.textContent = '❌ Kunne ikke læse billedet';
  }
}

// Upload knap
uploadBtn.addEventListener('click', () => fileInput.click());

fileInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file && file.type.startsWith('image/')) {
    imagePreview.src = URL.createObjectURL(file);
    imagePreview.style.display = 'block';
    processImage(file);
  }
  fileInput.value = '';
});

// Paste billede (Ctrl+V) i modal
adminModal.addEventListener('paste', (e) => {
  const items = e.clipboardData?.items;
  if (!items) return;

  for (const item of items) {
    if (item.type.startsWith('image/')) {
      e.preventDefault();
      const file = item.getAsFile();
      imagePreview.src = URL.createObjectURL(file);
      imagePreview.style.display = 'block';
      processImage(file);
      return;
    }
  }
});

// Admin submit
adminSubmitBtn.addEventListener('click', async () => {
  if (isLoading) return;

  const payload = (adminPayloadEl.value || '').trim();
  if (!payload) return;

  adminSubmitBtn.disabled = true;
  adminStatus.textContent = 'Sender...';
  adminStatus.className = 'submit-status';

  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({
        action: 'admin-import',
        payload: payload,
        recurring: recurringCheck.checked
      })
    });

    const raw = await res.text();
    if (!res.ok) throw new Error('HTTP_' + res.status);
    if (raw.trim().startsWith('<')) throw new Error('HTML_RESPONSE');

    const data = JSON.parse(raw);

    if (data.success) {
      adminStatus.textContent = data.text || '✅ OK';
      adminStatus.className = 'submit-status success';
      adminPayloadEl.value = '';
      imagePreview.style.display = 'none';
      recurringCheck.checked = false;
    } else {
      adminStatus.textContent = data.text || 'Der opstod en fejl.';
      adminStatus.className = 'submit-status error';
    }
  } catch (err) {
    adminStatus.textContent = 'Der opstod en teknisk fejl.';
    adminStatus.className = 'submit-status error';
  } finally {
    adminSubmitBtn.disabled = false;
  }
});

// INIT
addBotMessage('Jeg viser danseevents i København og omegn. Søg fx: "salsa i dag", "bachata i weekenden" eller "kizomba fredag".', false);
</script>
</body>
</html>
