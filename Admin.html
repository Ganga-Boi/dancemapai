<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DanceMap Admin - Event Upload</title>
  <style>
    :root {
      --bg-primary: #0a0f1a;
      --bg-secondary: #1a2744;
      --bg-card: #243352;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --text-primary: #f1f5f9;
      --text-muted: #94a3b8;
      --success: #22c55e;
      --warning: #f59e0b;
      --error: #ef4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 20px;
    }

    /* Login screen */
    .login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
      text-align: center;
    }

    .login-screen h1 {
      margin-bottom: 20px;
      font-size: 2rem;
    }

    .login-screen p {
      color: var(--text-muted);
      margin-bottom: 30px;
    }

    .login-box {
      background: var(--bg-secondary);
      padding: 30px;
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
    }

    .login-box input {
      width: 100%;
      padding: 14px;
      border: 1px solid var(--bg-card);
      border-radius: 8px;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 1rem;
      margin-bottom: 15px;
    }

    .login-box button {
      width: 100%;
      padding: 14px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
    }

    .login-box button:hover {
      background: var(--accent-hover);
    }

    .login-error {
      color: var(--error);
      margin-top: 15px;
      display: none;
    }

    /* Main app - hidden by default */
    .app-container {
      display: none;
      max-width: 800px;
      margin: 0 auto;
    }

    .app-container.active {
      display: block;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
    }

    header h1 {
      font-size: 1.8rem;
      margin-bottom: 8px;
    }

    header p {
      color: var(--text-muted);
    }

    .logout-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 8px 16px;
      background: var(--bg-card);
      color: var(--text-muted);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .logout-btn:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .api-key-section {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .api-key-section label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .api-key-section input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--bg-card);
      border-radius: 8px;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 1rem;
    }

    .api-key-section .hint {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .upload-zone {
      background: var(--bg-secondary);
      border: 2px dashed var(--bg-card);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 20px;
    }

    .upload-zone:hover {
      border-color: var(--accent);
      background: var(--bg-card);
    }

    .upload-zone.dragover {
      border-color: var(--accent);
      background: var(--bg-card);
    }

    .upload-zone input {
      display: none;
    }

    .upload-zone .icon {
      font-size: 3rem;
      margin-bottom: 15px;
    }

    .upload-zone h3 {
      margin-bottom: 8px;
    }

    .upload-zone p {
      color: var(--text-muted);
    }

    .preview-section {
      display: none;
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .preview-section.active {
      display: block;
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .preview-header h3 {
      font-size: 1.1rem;
    }

    .preview-image {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .status {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status.loading {
      background: rgba(59, 130, 246, 0.2);
      color: var(--accent);
    }

    .status.success {
      background: rgba(34, 197, 94, 0.2);
      color: var(--success);
    }

    .status.error {
      background: rgba(239, 68, 68, 0.2);
      color: var(--error);
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid currentColor;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .result-section {
      display: none;
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .result-section.active {
      display: block;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: var(--text-muted);
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--bg-card);
      border-radius: 8px;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 1rem;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--bg-primary);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #16a34a;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .button-row {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .saved-events {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 20px;
    }

    .saved-events h3 {
      margin-bottom: 15px;
    }

    .event-item {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
    }

    .event-item .title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .event-item .meta {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .empty-state {
      text-align: center;
      color: var(--text-muted);
      padding: 20px;
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <h1>üîí DanceMap Admin</h1>
    <p>Indtast adgangskode for at forts√¶tte</p>
    <div class="login-box">
      <input type="password" id="adminPassword" placeholder="Adgangskode" onkeypress="if(event.key==='Enter')attemptLogin()" />
      <button onclick="attemptLogin()">Log ind</button>
      <p class="login-error" id="loginError">Forkert adgangskode</p>
    </div>
  </div>

  <!-- Main App (hidden until login) -->
  <div class="app-container" id="appContainer">
    <button class="logout-btn" onclick="logout()">Log ud</button>
    
    <header>
      <h1>üì∏ DanceMap Event Upload</h1>
      <p>Upload screenshot ‚Üí Claude l√¶ser ‚Üí Gem til DanceMap</p>
    </header>

    <!-- API Key Section -->
    <div class="api-key-section">
      <label for="apiKey">Anthropic API N√∏gle</label>
      <input type="password" id="apiKey" placeholder="sk-ant-..." />
      <p class="hint">Din n√∏gle gemmes kun lokalt i browseren og sendes direkte til Anthropic.</p>
    </div>

    <!-- Upload Zone -->
    <div class="upload-zone" id="uploadZone">
      <input type="file" id="fileInput" accept="image/*" />
      <div class="icon">üì∑</div>
      <h3>Drop screenshot her</h3>
      <p>eller klik for at v√¶lge fil</p>
    </div>

    <!-- Preview Section -->
    <div class="preview-section" id="previewSection">
      <div class="preview-header">
        <h3>üìé Uploaded billede</h3>
        <button class="btn btn-secondary" onclick="clearUpload()">Ny upload</button>
      </div>
      <img id="previewImage" class="preview-image" />
      <div id="statusBox" class="status loading">
        <div class="spinner"></div>
        <span>Claude analyserer billedet...</span>
      </div>
    </div>

    <!-- Result Section -->
    <div class="result-section" id="resultSection">
      <h3>‚úèÔ∏è Tjek og ret event-info</h3>
      <p style="color: var(--text-muted); margin-bottom: 20px;">Claude fandt disse oplysninger. Ret evt. fejl f√∏r du gemmer.</p>
      
      <div class="form-row">
        <div class="form-group">
          <label>Dato</label>
          <input type="date" id="eventDate" />
        </div>
        <div class="form-group">
          <label>Dansetype</label>
          <select id="eventDanceType">
            <option value="">-- V√¶lg --</option>
            <option value="Salsa">Salsa</option>
            <option value="Bachata">Bachata</option>
            <option value="Kizomba">Kizomba</option>
            <option value="Zouk">Zouk</option>
            <option value="Tango">Tango</option>
            <option value="Latin">Latin Mix</option>
            <option value="Workshop">Workshop</option>
            <option value="Social">Social / Party</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Starttid</label>
          <input type="time" id="eventStartTime" value="20:00" />
        </div>
        <div class="form-group">
          <label>Sluttid (valgfrit)</label>
          <input type="time" id="eventEndTime" />
        </div>
      </div>

      <div class="form-group">
        <label>Sted / Venue</label>
        <input type="text" id="eventVenue" placeholder="Kedelhallen" />
      </div>

      <div class="form-group">
        <label>Adresse (valgfrit)</label>
        <input type="text" id="eventAddress" placeholder="Refshalevej 167A" />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>By</label>
          <input type="text" id="eventCity" value="K√∏benhavn" />
        </div>
        <div class="form-group">
          <label>Pris</label>
          <input type="text" id="eventPrice" placeholder="100 kr" />
        </div>
      </div>

      <div class="form-group">
        <label>Arrang√∏r (valgfrit)</label>
        <input type="text" id="eventOrganizer" placeholder="SalsaLibre" />
      </div>

      <div class="form-group">
        <label>Link (valgfrit)</label>
        <input type="url" id="eventLink" placeholder="https://facebook.com/events/..." />
      </div>

      <div class="button-row">
        <button class="btn btn-success" id="saveBtn" onclick="saveEvent()">‚úì Gem Event</button>
        <button class="btn btn-secondary" onclick="clearUpload()">Annuller</button>
      </div>
    </div>

    <!-- Saved Events -->
    <div class="saved-events">
      <h3>üìã Seneste uploads (denne session)</h3>
      <div id="savedList">
        <div class="empty-state">Ingen events uploadet endnu</div>
      </div>
    </div>
  </div>

  <script>
    // =====================
    // CONFIGURATION
    // =====================
    
    // CHANGE THIS to your own secret key!
    const ADMIN_SECRET_KEY = 'DanceMap2025!';
    
    const API_URL = 'https://script.google.com/macros/s/AKfycby3UJHM83amA1WpVV3Tp4e4GxkEYxMEDTJpwTn1NACJ0nQFQ_D0wRJcDGcIWRs7LKvA/exec';
    
    let currentImageBase64 = null;
    let savedEvents = [];

    // =====================
    // AUTHENTICATION
    // =====================
    
    function checkAuth() {
      // Check URL parameter first
      const urlParams = new URLSearchParams(window.location.search);
      const urlKey = urlParams.get('key');
      
      if (urlKey === ADMIN_SECRET_KEY) {
        // Valid URL key - save to session and show app
        sessionStorage.setItem('dancemap_admin_auth', 'true');
        showApp();
        // Clean URL (remove key parameter)
        window.history.replaceState({}, document.title, window.location.pathname);
        return;
      }
      
      // Check session storage
      if (sessionStorage.getItem('dancemap_admin_auth') === 'true') {
        showApp();
        return;
      }
      
      // Not authenticated - show login
      showLogin();
    }
    
    function attemptLogin() {
      const password = document.getElementById('adminPassword').value;
      
      if (password === ADMIN_SECRET_KEY) {
        sessionStorage.setItem('dancemap_admin_auth', 'true');
        showApp();
      } else {
        document.getElementById('loginError').style.display = 'block';
        document.getElementById('adminPassword').value = '';
      }
    }
    
    function logout() {
      sessionStorage.removeItem('dancemap_admin_auth');
      showLogin();
    }
    
    function showLogin() {
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('appContainer').classList.remove('active');
    }
    
    function showApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('appContainer').classList.add('active');
      initApp();
    }
    
    // =====================
    // APP INITIALIZATION
    // =====================
    
    function initApp() {
      // Load API key from localStorage
      document.getElementById('apiKey').value = localStorage.getItem('anthropic_api_key') || '';

      // Save API key on change
      document.getElementById('apiKey').addEventListener('change', (e) => {
        localStorage.setItem('anthropic_api_key', e.target.value);
      });

      // Upload zone handlers
      const uploadZone = document.getElementById('uploadZone');
      const fileInput = document.getElementById('fileInput');

      uploadZone.addEventListener('click', () => fileInput.click());

      uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
      });

      uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
      });

      uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
          handleFile(file);
        }
      });

      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          handleFile(file);
        }
      });
    }

    // =====================
    // FILE HANDLING
    // =====================

    async function handleFile(file) {
      const reader = new FileReader();
      reader.onload = async (e) => {
        currentImageBase64 = e.target.result;
        
        document.getElementById('previewImage').src = currentImageBase64;
        document.getElementById('previewSection').classList.add('active');
        document.getElementById('resultSection').classList.remove('active');
        document.getElementById('uploadZone').style.display = 'none';
        
        updateStatus('loading', 'Claude analyserer billedet...');
        
        await analyzeWithClaude(currentImageBase64);
      };
      reader.readAsDataURL(file);
    }

    function updateStatus(type, message) {
      const statusBox = document.getElementById('statusBox');
      statusBox.className = `status ${type}`;
      
      if (type === 'loading') {
        statusBox.innerHTML = `<div class="spinner"></div><span>${message}</span>`;
      } else {
        statusBox.innerHTML = `<span>${message}</span>`;
      }
    }

    // =====================
    // CLAUDE VISION API
    // =====================

    async function analyzeWithClaude(imageBase64) {
      const apiKey = document.getElementById('apiKey').value;
      
      if (!apiKey) {
        updateStatus('error', '‚ùå Indtast din Anthropic API n√∏gle f√∏rst');
        return;
      }

      try {
        const base64Data = imageBase64.replace(/^data:image\/\w+;base64,/, '');
        const mediaType = imageBase64.match(/^data:(image\/\w+);/)?.[1] || 'image/jpeg';

        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 1024,
            messages: [{
              role: 'user',
              content: [
                {
                  type: 'image',
                  source: {
                    type: 'base64',
                    media_type: mediaType,
                    data: base64Data
                  }
                },
                {
                  type: 'text',
                  text: `Analyser dette billede af et danse-event (flyer, screenshot, opslag).

Udtr√¶k f√∏lgende information og svar KUN med JSON:

{
  "dato": "YYYY-MM-DD format hvis muligt, ellers den r√• tekst",
  "starttid": "HH:MM format, fx 20:00",
  "sluttid": "HH:MM format hvis angivet, ellers null",
  "dansetype": "Salsa/Bachata/Kizomba/Zouk/Tango/Latin/Workshop/Social",
  "pris": "Pris som tekst, fx '100 kr' eller 'Gratis'",
  "sted": "Sted/venue navn",
  "adresse": "Fuld adresse hvis angivet",
  "by": "By (standard: K√∏benhavn)",
  "arrangoer": "Arrang√∏r/organizer hvis angivet",
  "link": "URL hvis synlig",
  "confidence": "high/medium/low"
}

Hvis du ikke kan finde en v√¶rdi, brug null.
Svar KUN med JSON, ingen forklaring.`
                }
              ]
            }]
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error?.message || 'API fejl');
        }

        const data = await response.json();
        const content = data.content[0].text;
        
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (!jsonMatch) {
          throw new Error('Kunne ikke parse Claude response');
        }
        
        const eventData = JSON.parse(jsonMatch[0]);
        
        fillForm(eventData);
        
        const confidenceText = {
          'high': '‚úÖ H√∏j sikkerhed',
          'medium': '‚ö†Ô∏è Medium sikkerhed - tjek venligst',
          'low': '‚ùå Lav sikkerhed - ret venligst'
        };
        
        updateStatus('success', confidenceText[eventData.confidence] || '‚úÖ Data udtrukket');
        document.getElementById('resultSection').classList.add('active');

      } catch (error) {
        console.error('Claude API error:', error);
        updateStatus('error', `‚ùå Fejl: ${error.message}`);
      }
    }

    // =====================
    // FORM HANDLING
    // =====================

    function fillForm(data) {
      document.getElementById('eventVenue').value = data.sted || '';
      document.getElementById('eventAddress').value = data.adresse || '';
      document.getElementById('eventCity').value = data.by || 'K√∏benhavn';
      document.getElementById('eventPrice').value = data.pris || '';
      document.getElementById('eventOrganizer').value = data.arrangoer || '';
      document.getElementById('eventLink').value = data.link || '';
      
      if (data.dato) {
        if (/^\d{4}-\d{2}-\d{2}$/.test(data.dato)) {
          document.getElementById('eventDate').value = data.dato;
        }
      }
      
      if (data.starttid) {
        const timeMatch = data.starttid.match(/(\d{1,2}):?(\d{2})?/);
        if (timeMatch) {
          const hours = timeMatch[1].padStart(2, '0');
          const mins = timeMatch[2] || '00';
          document.getElementById('eventStartTime').value = `${hours}:${mins}`;
        }
      }
      
      if (data.sluttid) {
        const timeMatch = data.sluttid.match(/(\d{1,2}):?(\d{2})?/);
        if (timeMatch) {
          const hours = timeMatch[1].padStart(2, '0');
          const mins = timeMatch[2] || '00';
          document.getElementById('eventEndTime').value = `${hours}:${mins}`;
        }
      }
      
      if (data.dansetype) {
        const select = document.getElementById('eventDanceType');
        const options = Array.from(select.options);
        const match = options.find(opt => 
          opt.value.toLowerCase() === data.dansetype.toLowerCase()
        );
        if (match) {
          select.value = match.value;
        }
      }
    }

    async function saveEvent() {
      const btn = document.getElementById('saveBtn');
      btn.disabled = true;
      btn.textContent = 'Gemmer...';

      const eventData = {
        dato: document.getElementById('eventDate').value,
        starttid: document.getElementById('eventStartTime').value,
        sluttid: document.getElementById('eventEndTime').value,
        dansetype: document.getElementById('eventDanceType').value,
        pris: document.getElementById('eventPrice').value,
        sted: document.getElementById('eventVenue').value,
        adresse: document.getElementById('eventAddress').value,
        by: document.getElementById('eventCity').value,
        arrangoer: document.getElementById('eventOrganizer').value,
        link: document.getElementById('eventLink').value
      };

      try {
        const response = await fetch(API_URL + '?action=submitEvent', {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(eventData)
        });

        savedEvents.unshift(eventData);
        updateSavedList();
        
        clearUpload();
        
        alert('‚úÖ Event gemt! Det vil blive gennemg√•et og tilf√∏jet til DanceMap.');

      } catch (error) {
        console.error('Save error:', error);
        alert('‚ùå Fejl ved gemning: ' + error.message);
      }

      btn.disabled = false;
      btn.textContent = '‚úì Gem Event';
    }

    function clearUpload() {
      document.getElementById('previewSection').classList.remove('active');
      document.getElementById('resultSection').classList.remove('active');
      document.getElementById('uploadZone').style.display = 'block';
      document.getElementById('fileInput').value = '';
      currentImageBase64 = null;
      
      document.getElementById('eventDate').value = '';
      document.getElementById('eventStartTime').value = '20:00';
      document.getElementById('eventEndTime').value = '';
      document.getElementById('eventDanceType').value = '';
      document.getElementById('eventPrice').value = '';
      document.getElementById('eventVenue').value = '';
      document.getElementById('eventAddress').value = '';
      document.getElementById('eventCity').value = 'K√∏benhavn';
      document.getElementById('eventOrganizer').value = '';
      document.getElementById('eventLink').value = '';
    }

    function updateSavedList() {
      const list = document.getElementById('savedList');
      
      if (savedEvents.length === 0) {
        list.innerHTML = '<div class="empty-state">Ingen events uploadet endnu</div>';
        return;
      }

      list.innerHTML = savedEvents.map(event => `
        <div class="event-item">
          <div class="title">${event.dansetype || 'Dans'} @ ${event.sted || 'Ukendt'}</div>
          <div class="meta">
            ${event.dato || '?'} kl. ${event.starttid || '?'} ¬∑ 
            ${event.by || 'K√∏benhavn'}
          </div>
        </div>
      `).join('');
    }

    // =====================
    // INIT ON PAGE LOAD
    // =====================
    
    checkAuth();
  </script>
</body>
</html>
