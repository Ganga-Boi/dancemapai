<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DanceMap Admin - Event Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --bg-dark: #0f0f23;
            --bg-card: #1a1a2e;
            --bg-input: #252540;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b8;
            --text-muted: #6b6b80;
            --border: #2d2d44;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --gradient-start: #6366f1;
            --gradient-end: #a855f7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 40px;
        }

        .header {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header-nav {
            margin-top: 12px;
            display: flex;
            justify-content: center;
            gap: 12px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .nav-btn.active {
            background: white;
            color: var(--primary);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-muted);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 14px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            transition: all 0.2s;
        }

        .checkbox-label:hover {
            border-color: var(--primary);
        }

        .checkbox-label input[type="checkbox"] {
            width: 22px;
            height: 22px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        .checkbox-text {
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .btn {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border: none;
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-input);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
            box-shadow: none;
        }

        .btn-success {
            background: var(--success);
        }

        .btn-danger {
            background: var(--error);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .alert {
            padding: 14px 18px;
            border-radius: 10px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .alert-info {
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid var(--primary);
            color: var(--primary-light);
        }

        .hidden {
            display: none !important;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .tab-btn:hover {
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Event List */
        .event-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .event-item {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
        }

        .event-info {
            flex: 1;
        }

        .event-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .event-details {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .event-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .status-approved {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .status-rejected {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        .status-recurring {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary-light);
            margin-left: 8px;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        .upload-text {
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .upload-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Preview */
        .image-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .parsed-result {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .parsed-field {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .parsed-field:last-child {
            border-bottom: none;
        }

        .parsed-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .parsed-value {
            font-weight: 500;
        }

        /* Loading */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .footer a {
            color: var(--primary-light);
            text-decoration: none;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 16px;
            }

            .card {
                padding: 16px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .event-item {
                flex-direction: column;
            }

            .event-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>‚öôÔ∏è DanceMap Admin</h1>
        <div class="header-nav">
            <a href="index.html" class="nav-btn">‚Üê Tilbage til Chat</a>
            <button class="nav-btn" onclick="refreshPending()">üîÑ Opdater</button>
        </div>
    </header>

    <div class="container">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('submit')">üìù Tilf√∏j Event</button>
            <button class="tab-btn" onclick="switchTab('upload')">üì∑ Upload Flyer</button>
            <button class="tab-btn" onclick="switchTab('pending')">‚è≥ Ventende (<span id="pendingCount">0</span>)</button>
        </div>

        <!-- Alert Area -->
        <div id="alertArea"></div>

        <!-- Submit Tab -->
        <div id="submitTab" class="tab-content active">
            <div class="card">
                <h2 class="card-title">üìù Tilf√∏j Nyt Event</h2>
                <form id="eventForm" onsubmit="submitEvent(event)">
                    <input type="hidden" id="eventId" name="eventId" value="">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="dato">Dato *</label>
                            <input type="date" id="dato" name="dato" required>
                        </div>
                        <div class="form-group">
                            <label for="starttid">Starttid *</label>
                            <input type="time" id="starttid" name="starttid" value="20:00" required>
                        </div>
                        <div class="form-group">
                            <label for="sluttid">Sluttid</label>
                            <input type="time" id="sluttid" name="sluttid">
                        </div>
                        <div class="form-group">
                            <label for="dansetype">Dansetype *</label>
                            <select id="dansetype" name="dansetype" required>
                                <option value="">V√¶lg type...</option>
                                <option value="Salsa">Salsa</option>
                                <option value="Bachata">Bachata</option>
                                <option value="Kizomba">Kizomba</option>
                                <option value="Salsa & Bachata">Salsa & Bachata</option>
                                <option value="Latin Mix">Latin Mix</option>
                                <option value="Zouk">Zouk</option>
                                <option value="Tango">Tango</option>
                                <option value="Workshop">Workshop</option>
                                <option value="Social">Social / Fest</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label for="sted">Sted / Venue *</label>
                            <input type="text" id="sted" name="sted" placeholder="Fx: Kedelhallen, Old Irish Pub..." required>
                        </div>
                        <div class="form-group full-width">
                            <label for="adresse">Adresse</label>
                            <input type="text" id="adresse" name="adresse" placeholder="Fx: Nyelandsvej 75A, 2000 Frederiksberg">
                        </div>
                        <div class="form-group">
                            <label for="by">By</label>
                            <select id="by" name="by">
                                <option value="K√∏benhavn">K√∏benhavn</option>
                                <option value="Frederiksberg">Frederiksberg</option>
                                <option value="Amager">Amager</option>
                                <option value="√òsterbro">√òsterbro</option>
                                <option value="N√∏rrebro">N√∏rrebro</option>
                                <option value="Vesterbro">Vesterbro</option>
                                <option value="Valby">Valby</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pris">Pris</label>
                            <input type="text" id="pris" name="pris" placeholder="Fx: 100 kr, Gratis, Se event">
                        </div>
                        <div class="form-group full-width">
                            <label for="arrangoer">Arrang√∏r</label>
                            <input type="text" id="arrangoer" name="arrangoer" placeholder="Navn p√• arrang√∏r/venue">
                        </div>
                        <div class="form-group full-width">
                            <label for="link">Link til event</label>
                            <input type="url" id="link" name="link" placeholder="https://...">
                        </div>
                        <div class="form-group full-width">
                            <label class="checkbox-label">
                                <input type="checkbox" id="recurring" name="recurring">
                                <span class="checkbox-text">‚ôªÔ∏è Gentages hver uge (samme ugedag)</span>
                            </label>
                            <small style="color: var(--text-muted); margin-top: 4px; display: block;">
                                Aktiv√©r dette for faste ugentlige events (fx "Latin Fridays" hver fredag)
                            </small>
                        </div>
                    </div>
                    <div style="margin-top: 24px; display: flex; gap: 12px;">
                        <button type="submit" class="btn" id="submitBtn">
                            <span>üì§ Indsend Event</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">
                            üóëÔ∏è Ryd formular
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Upload Tab -->
        <div id="uploadTab" class="tab-content">
            <div class="card">
                <h2 class="card-title">üì∑ Upload Event Flyer</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Upload et billede af en event-flyer, og AI'en vil automatisk udtr√¶kke informationen.
                </p>
                
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üì∑</div>
                    <div class="upload-text">Klik eller tr√¶k en fil hertil</div>
                    <div class="upload-hint">Underst√∏tter JPG, PNG (max 10MB)</div>
                </div>
                <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                
                <div id="previewArea" class="hidden">
                    <img id="imagePreview" class="image-preview" alt="Preview">
                    <button class="btn" id="parseBtn" onclick="parseFlyer()">
                        ü§ñ Analyser med AI
                    </button>
                </div>
                
                <div id="parsedResult" class="parsed-result hidden">
                    <h3 style="margin-bottom: 16px;">üìã Udtr√¶k Resultat</h3>
                    <div id="parsedFields"></div>
                    <div style="margin-top: 20px; display: flex; gap: 12px;">
                        <button class="btn btn-success" onclick="useParsedData()">
                            ‚úÖ Brug disse data
                        </button>
                        <button class="btn btn-secondary" onclick="clearUpload()">
                            üîÑ Start forfra
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Tab -->
        <div id="pendingTab" class="tab-content">
            <div class="card">
                <h2 class="card-title">‚è≥ Ventende Events</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Events der afventer godkendelse. Godkend direkte i Google Sheet ved at √¶ndre Status til "Approved".
                </p>
                
                <div id="pendingList" class="event-list">
                    <div class="alert alert-info">
                        <span>üîÑ</span> Indl√¶ser ventende events...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <a href="index.html">‚Üê Tilbage til DanceMap Chat</a> ¬∑ Admin Panel v1.4.6
    </footer>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzhtfMvSHhBIPnrOvXVuMlvKVqDeJ-B0yiOCE5GHLwwPljpJkMnEQ_Cq2K73ApYkLk/exec";
        
        let currentParsedData = null;
        let uploadedFile = null;

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
            
            if (tabName === 'pending') {
                loadPendingEvents();
            }
        }

        // Show alert
        function showAlert(message, type = 'info') {
            const alertArea = document.getElementById('alertArea');
            alertArea.innerHTML = `
                <div class="alert alert-${type}">
                    <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                    ${message}
                </div>
            `;
            
            setTimeout(() => {
                alertArea.innerHTML = '';
            }, 5000);
        }

        // Submit event
        async function submitEvent(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading-spinner"></span> Sender...';
            
            const eventId = document.getElementById('eventId').value;
            const isUpdate = eventId !== '';
            
            const formData = {
                eventId: eventId || null,
                dato: document.getElementById('dato').value,
                starttid: document.getElementById('starttid').value,
                sluttid: document.getElementById('sluttid').value,
                dansetype: document.getElementById('dansetype').value,
                sted: document.getElementById('sted').value,
                adresse: document.getElementById('adresse').value,
                by: document.getElementById('by').value,
                pris: document.getElementById('pris').value,
                arrangoer: document.getElementById('arrangoer').value,
                link: document.getElementById('link').value,
                recurring: document.getElementById('recurring').checked,
                status: isUpdate ? 'approved' : 'pending'
            };
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const isRecurring = formData.recurring ? ' (gentages hver uge)' : '';
                if (isUpdate) {
                    showAlert('Event opdateret og godkendt! üéâ' + isRecurring, 'success');
                } else {
                    showAlert('Event indsendt til godkendelse! üéâ' + isRecurring, 'success');
                }
                clearForm();
                
                // Refresh pending list if we just approved an event
                if (isUpdate) {
                    loadPendingEvents();
                }
                
            } catch (error) {
                console.error('Error:', error);
                showAlert('Der opstod en fejl. Pr√∏v igen.', 'error');
            }
            
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span>üì§ Indsend Event</span>';
        }

        // Clear form - reset to tomorrow's date
        function clearForm() {
            document.getElementById('eventForm').reset();
            document.getElementById('eventId').value = '';
            document.getElementById('starttid').value = '20:00';
            
            // Set date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('dato').value = tomorrow.toISOString().split('T')[0];
            
            // Reset button text
            document.getElementById('submitBtn').innerHTML = '<span>üì§ Indsend Event</span>';
        }

        // File handling
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showAlert('V√¶lg venligst en billedfil', 'error');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showAlert('Filen er for stor (max 10MB)', 'error');
                return;
            }
            
            uploadedFile = file;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('previewArea').classList.remove('hidden');
                document.getElementById('uploadArea').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        // Parse flyer with AI (placeholder - would need Claude Vision API)
        async function parseFlyer() {
            const parseBtn = document.getElementById('parseBtn');
            parseBtn.disabled = true;
            parseBtn.innerHTML = '<span class="loading-spinner"></span> Analyserer...';
            
            // Simulate AI parsing - in production this would call Claude Vision API
            setTimeout(() => {
                currentParsedData = {
                    dato: '',
                    starttid: '20:00',
                    dansetype: 'Salsa & Bachata',
                    sted: '',
                    pris: ''
                };
                
                const fieldsHtml = Object.entries({
                    'Dato': currentParsedData.dato || '(Ikke fundet)',
                    'Starttid': currentParsedData.starttid,
                    'Dansetype': currentParsedData.dansetype,
                    'Sted': currentParsedData.sted || '(Ikke fundet)',
                    'Pris': currentParsedData.pris || '(Ikke fundet)'
                }).map(([label, value]) => `
                    <div class="parsed-field">
                        <span class="parsed-label">${label}</span>
                        <span class="parsed-value">${value}</span>
                    </div>
                `).join('');
                
                document.getElementById('parsedFields').innerHTML = fieldsHtml;
                document.getElementById('parsedResult').classList.remove('hidden');
                
                parseBtn.disabled = false;
                parseBtn.innerHTML = 'ü§ñ Analyser med AI';
                
                showAlert('Billede analyseret! Gennemg√• resultaterne.', 'info');
            }, 2000);
        }

        function useParsedData() {
            if (currentParsedData) {
                if (currentParsedData.dato) document.getElementById('dato').value = currentParsedData.dato;
                if (currentParsedData.starttid) document.getElementById('starttid').value = currentParsedData.starttid;
                if (currentParsedData.dansetype) {
                    const select = document.getElementById('dansetype');
                    for (let option of select.options) {
                        if (option.value.toLowerCase().includes(currentParsedData.dansetype.toLowerCase())) {
                            select.value = option.value;
                            break;
                        }
                    }
                }
                if (currentParsedData.sted) document.getElementById('sted').value = currentParsedData.sted;
                if (currentParsedData.pris) document.getElementById('pris').value = currentParsedData.pris;
                
                switchTab('submit');
                showAlert('Data indsat i formularen. Udfyld resten og indsend.', 'success');
            }
        }

        function clearUpload() {
            document.getElementById('fileInput').value = '';
            document.getElementById('previewArea').classList.add('hidden');
            document.getElementById('parsedResult').classList.add('hidden');
            document.getElementById('uploadArea').classList.remove('hidden');
            uploadedFile = null;
            currentParsedData = null;
        }

        // Load pending events
        async function loadPendingEvents() {
            const pendingList = document.getElementById('pendingList');
            pendingList.innerHTML = '<div class="alert alert-info"><span>üîÑ</span> Indl√¶ser...</div>';
            
            try {
                // Using JSONP for cross-origin
                const callbackName = 'pending_callback_' + Date.now();
                
                const promise = new Promise((resolve, reject) => {
                    window[callbackName] = (data) => {
                        delete window[callbackName];
                        resolve(data);
                    };
                    
                    setTimeout(() => {
                        delete window[callbackName];
                        reject(new Error('Timeout'));
                    }, 10000);
                });
                
                const script = document.createElement('script');
                script.src = `${SCRIPT_URL}?action=getPending&callback=${callbackName}`;
                document.body.appendChild(script);
                
                const data = await promise;
                script.remove();
                
                if (data.success && data.events) {
                    renderPendingEvents(data.events);
                } else {
                    pendingList.innerHTML = '<div class="alert alert-info"><span>üì≠</span> Ingen ventende events</div>';
                }
            } catch (error) {
                console.error('Error loading pending:', error);
                pendingList.innerHTML = `
                    <div class="alert alert-error">
                        <span>‚ö†Ô∏è</span> Kunne ikke indl√¶se events. 
                        <a href="https://docs.google.com/spreadsheets/d/1nECcg7qrlfvQabDaIhPheXeQ4FhIOjLT_k/edit" target="_blank" style="color: inherit; text-decoration: underline;">
                            √Öbn Google Sheet direkte
                        </a>
                    </div>
                `;
            }
        }

        function renderPendingEvents(events) {
            const pendingList = document.getElementById('pendingList');
            document.getElementById('pendingCount').textContent = events.length;
            
            if (events.length === 0) {
                pendingList.innerHTML = '<div class="alert alert-info"><span>üì≠</span> Ingen ventende events</div>';
                return;
            }
            
            pendingList.innerHTML = events.map((event, index) => {
                const isRecurring = event.Recurring === true || event.Recurring === "TRUE" || event.Recurring === "true";
                const recurringBadge = isRecurring ? '<span class="status-badge status-recurring">‚ôªÔ∏è Ugentlig</span>' : '';
                const eventDataJson = encodeURIComponent(JSON.stringify(event));
                return `
                <div class="event-item">
                    <div class="event-info">
                        <div class="event-title">${event.Dansetype || event.dansetype || 'Ukendt type'} @ ${event.Sted || event.sted || 'Ukendt sted'}</div>
                        <div class="event-details">
                            üìÖ ${event.Dato || event.dato || 'Ingen dato'} kl. ${event.Starttid || event.starttid || '?'}<br>
                            üìç ${event.By || event.by || 'K√∏benhavn'}<br>
                            üí∞ ${event.Pris || event.pris || 'Ikke angivet'}
                        </div>
                        <div style="margin-top: 8px;">
                            <span class="status-badge status-pending">Afventer</span>
                            ${recurringBadge}
                        </div>
                    </div>
                    <div class="event-actions">
                        <button class="btn btn-small btn-success" onclick="editPending('${eventDataJson}')">
                            ‚úèÔ∏è Rediger & Godkend
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        function refreshPending() {
            loadPendingEvents();
            showAlert('Liste opdateret', 'info');
        }

        // Edit pending event - fill form and switch to submit tab
        function editPending(encodedData) {
            try {
                const event = JSON.parse(decodeURIComponent(encodedData));
                
                // Fill form fields
                document.getElementById('eventId').value = event.EventId || event.eventId || '';
                
                // Handle date - might be in various formats
                let dateValue = event.Dato || event.dato || '';
                if (dateValue) {
                    // Try to extract just the date part if it includes time
                    const dateMatch = dateValue.toString().match(/(\d{4}-\d{2}-\d{2})/);
                    if (dateMatch) {
                        dateValue = dateMatch[1];
                    } else {
                        // Try to parse and format
                        const parsed = new Date(dateValue);
                        if (!isNaN(parsed)) {
                            dateValue = parsed.toISOString().split('T')[0];
                        }
                    }
                }
                document.getElementById('dato').value = dateValue;
                
                document.getElementById('starttid').value = event.Starttid || event.starttid || '20:00';
                document.getElementById('sluttid').value = event.Sluttid || event.sluttid || '';
                
                // Handle dansetype - try to match with select options
                const dansetype = event.Dansetype || event.dansetype || '';
                const dansetypeSelect = document.getElementById('dansetype');
                let matched = false;
                for (let option of dansetypeSelect.options) {
                    if (option.value && dansetype.toLowerCase().includes(option.value.toLowerCase())) {
                        dansetypeSelect.value = option.value;
                        matched = true;
                        break;
                    }
                }
                if (!matched) {
                    dansetypeSelect.value = '';
                }
                
                document.getElementById('sted').value = event.Sted || event.sted || '';
                document.getElementById('adresse').value = event.Adresse || event.adresse || '';
                
                // Handle by - match with select options
                const by = event.By || event.by || 'K√∏benhavn';
                const bySelect = document.getElementById('by');
                for (let option of bySelect.options) {
                    if (option.value.toLowerCase() === by.toLowerCase()) {
                        bySelect.value = option.value;
                        break;
                    }
                }
                
                document.getElementById('pris').value = event.Pris || event.pris || '';
                document.getElementById('arrangoer').value = event.Arrang√∏r || event.arrangoer || '';
                document.getElementById('link').value = event.Link || event.link || '';
                
                const isRecurring = event.Recurring === true || event.Recurring === "TRUE" || event.Recurring === "true";
                document.getElementById('recurring').checked = isRecurring;
                
                // Change button text
                document.getElementById('submitBtn').innerHTML = '<span>‚úÖ Opdater & Godkend</span>';
                
                // Switch to submit tab
                switchTab('submit');
                
                showAlert('Event indl√¶st - rediger og klik "Opdater & Godkend"', 'info');
                
            } catch (error) {
                console.error('Error parsing event data:', error);
                showAlert('Kunne ikke indl√¶se event data', 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('dato').value = tomorrow.toISOString().split('T')[0];
        });
    </script>
</body>
</html>
