<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DanceMap Admin - Indsend Events</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #667eea; --primary-dark: #5a67d8; --secondary: #ed64a6;
            --bg-dark: #0f0f23; --bg-card: #1a1a2e; --bg-input: #16213e;
            --text-primary: #ffffff; --text-secondary: #a0aec0; --text-muted: #718096;
            --border: #2d3748; --success: #48bb78; --warning: #ed8936; --error: #fc8181;
            --radius: 16px; --radius-sm: 12px;
        }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, var(--bg-dark), #1a1a2e, #16213e); color: var(--text-primary); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 2rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; }
        .header p { color: var(--text-secondary); }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { padding: 12px 24px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-secondary); cursor: pointer; font-size: 0.95rem; font-weight: 500; transition: all 0.2s; }
        .tab-btn:hover { border-color: var(--primary); color: var(--text-primary); }
        .tab-btn.active { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-color: transparent; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: var(--bg-card); border-radius: var(--radius); padding: 24px; margin-bottom: 20px; border: 1px solid var(--border); }
        .quick-paste-section { background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 16px; margin-bottom: 20px; }
        .quick-paste-title { font-size: 1rem; font-weight: 600; margin-bottom: 8px; color: var(--primary); }
        .quick-paste-section textarea { width: 100%; min-height: 120px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 12px; color: var(--text-primary); font-family: inherit; font-size: 0.9rem; resize: vertical; margin-top: 8px; }
        .quick-paste-section textarea:focus { outline: none; border-color: var(--primary); }
        .quick-paste-section textarea::placeholder { color: var(--text-muted); }
        .divider { display: flex; align-items: center; margin: 24px 0; color: var(--text-muted); font-size: 0.85rem; }
        .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
        .divider span { padding: 0 16px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { font-size: 0.9rem; color: var(--text-secondary); font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { padding: 12px 14px; background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-primary); font-size: 0.95rem; font-family: inherit; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); }
        .required { color: var(--error); }
        .btn { padding: 14px 28px; border-radius: var(--radius-sm); font-size: 1rem; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-success { background: var(--success); color: white; }
        .btn-small { padding: 8px 16px; font-size: 0.85rem; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-group { display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap; }
        .alert { padding: 14px 18px; border-radius: var(--radius-sm); margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
        .alert-success { background: rgba(72, 187, 120, 0.15); border: 1px solid var(--success); color: var(--success); }
        .alert-error { background: rgba(252, 129, 129, 0.15); border: 1px solid var(--error); color: var(--error); }
        .alert-info { background: rgba(102, 126, 234, 0.15); border: 1px solid var(--primary); color: var(--primary); }
        .event-item { background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 16px; margin-bottom: 12px; }
        .event-title { font-weight: 600; margin-bottom: 6px; }
        .event-details { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6; }
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .status-pending { background: rgba(237, 137, 54, 0.2); color: var(--warning); }
        .status-recurring { background: rgba(102, 126, 234, 0.2); color: var(--primary); }
        .loading-spinner { width: 20px; height: 20px; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé≠ DanceMap Admin</h1>
            <p>Administrer danse-events i K√∏benhavn</p>
        </div>
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('submit')">üìù Tilf√∏j Event</button>
            <button class="tab-btn" onclick="switchTab('pending')">‚è≥ Ventende (<span id="pendingCount">0</span>)</button>
        </div>
        <div id="alertContainer"></div>

        <div id="submitTab" class="tab-content active">
            <div class="card">
                <form id="eventForm" onsubmit="submitEvent(event)">
                    <input type="hidden" id="eventId" name="eventId" value="">
                    
                    <div class="quick-paste-section">
                        <div class="quick-paste-title">‚ö° Quick Paste - bare inds√¶t!</div>
                        <p style="color: var(--text-secondary); font-size: 0.85rem;">Kopier tekst fra Facebook/email og inds√¶t her:</p>
                        <textarea id="quickPasteInput" placeholder="Inds√¶t event-tekst her..." onpaste="setTimeout(parseQuickPaste, 100)"></textarea>
                    </div>
                    
                    <div class="divider"><span>eller udfyld manuelt</span></div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Dato <span class="required">*</span></label>
                            <input type="date" id="dato" name="dato" required>
                        </div>
                        <div class="form-group">
                            <label>Starttid <span class="required">*</span></label>
                            <input type="time" id="starttid" name="starttid" value="20:00" required>
                        </div>
                        <div class="form-group">
                            <label>Sluttid</label>
                            <input type="time" id="sluttid" name="sluttid">
                        </div>
                        <div class="form-group">
                            <label>Dansetype <span class="required">*</span></label>
                            <select id="dansetype" name="dansetype" required>
                                <option value="">V√¶lg type...</option>
                                <option value="Salsa">Salsa</option>
                                <option value="Bachata">Bachata</option>
                                <option value="Kizomba">Kizomba</option>
                                <option value="Salsa & Bachata">Salsa & Bachata</option>
                                <option value="Latin Mix">Latin Mix</option>
                                <option value="Zouk">Zouk</option>
                                <option value="Tango">Tango</option>
                                <option value="Workshop">Workshop</option>
                                <option value="Social">Social / Party</option>
                                <option value="Andet">Andet</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Sted / Venue <span class="required">*</span></label>
                            <input type="text" id="sted" name="sted" placeholder="Fx: Kedelhallen" required>
                        </div>
                        <div class="form-group">
                            <label>Adresse</label>
                            <input type="text" id="adresse" name="adresse" placeholder="Fx: Nyelandsvej 75A">
                        </div>
                        <div class="form-group">
                            <label>By</label>
                            <select id="by" name="by">
                                <option value="K√∏benhavn">K√∏benhavn</option>
                                <option value="Frederiksberg">Frederiksberg</option>
                                <option value="Vanl√∏se">Vanl√∏se</option>
                                <option value="Amager">Amager</option>
                                <option value="N√∏rrebro">N√∏rrebro</option>
                                <option value="Vesterbro">Vesterbro</option>
                                <option value="√òsterbro">√òsterbro</option>
                                <option value="Valby">Valby</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Pris</label>
                            <input type="text" id="pris" name="pris" placeholder="Fx: 100 kr">
                        </div>
                        <div class="form-group">
                            <label>Arrang√∏r</label>
                            <input type="text" id="arrangoer" name="arrangoer" placeholder="Navn p√• arrang√∏r">
                        </div>
                        <div class="form-group full-width">
                            <label>Link til event</label>
                            <input type="url" id="link" name="link" placeholder="https://...">
                        </div>
                        <div class="form-group full-width">
                            <label>Gentagelse</label>
                            <select id="recurring" name="recurring">
                                <option value="">Ingen gentagelse</option>
                                <option value="weekly">‚ôªÔ∏è Hver uge</option>
                                <option value="biweekly">üîÑ Hver anden uge</option>
                                <option value="weekend">üéâ Hver weekend</option>
                                <option value="monthly">üìÖ Hver m√•ned</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary" id="submitBtn">üì§ Indsend Event</button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">üóëÔ∏è Ryd</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="pendingTab" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0;">Ventende Events</h3>
                    <button class="btn btn-secondary btn-small" onclick="loadPendingEvents()">üîÑ Opdater</button>
                </div>
                <div id="pendingList"><div class="alert alert-info">üí° Klik p√• fanen for at indl√¶se</div></div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby3UJHM83amA1WpVV3Tp4e4GxkEYxMEDTJpwTn1NACJ0nQFQ_D0wRJcDGcIWRs7LKvA/exec";

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
            if (tabName === 'pending') loadPendingEvents();
        }

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `<span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : 'üí°'}</span> ${message}`;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        async function submitEvent(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading-spinner"></span> Sender...';
            
            const eventId = document.getElementById('eventId').value;
            const isUpdate = eventId !== '';
            
            const formData = {
                action: 'submitEvent',
                eventId: eventId || '',
                dato: document.getElementById('dato').value,
                starttid: document.getElementById('starttid').value,
                sluttid: document.getElementById('sluttid').value,
                dansetype: document.getElementById('dansetype').value,
                sted: document.getElementById('sted').value,
                adresse: document.getElementById('adresse').value,
                by: document.getElementById('by').value,
                pris: document.getElementById('pris').value,
                arrangoer: document.getElementById('arrangoer').value,
                link: document.getElementById('link').value,
                recurring: document.getElementById('recurring').value || '',
                status: isUpdate ? 'approved' : 'pending'
            };
            
            try {
                const callbackName = 'submit_' + Date.now();
                const promise = new Promise((resolve, reject) => {
                    window[callbackName] = (data) => { delete window[callbackName]; resolve(data); };
                    setTimeout(() => { delete window[callbackName]; reject(new Error('Timeout')); }, 15000);
                });
                
                const params = new URLSearchParams();
                for (const [k, v] of Object.entries(formData)) params.append(k, v);
                params.append('callback', callbackName);
                
                const script = document.createElement('script');
                script.src = `${SCRIPT_URL}?${params.toString()}`;
                document.body.appendChild(script);
                
                const data = await promise;
                script.remove();
                
                if (data.success) {
                    showAlert(isUpdate ? 'Event godkendt! üéâ' : 'Event indsendt! üéâ', 'success');
                    clearForm();
                    loadPendingEvents();
                } else {
                    showAlert('Fejl: ' + (data.error || 'Ukendt fejl'), 'error');
                }
            } catch (error) {
                showAlert('Netv√¶rksfejl - pr√∏v igen', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = isUpdate ? '‚úÖ Opdater & Godkend' : 'üì§ Indsend Event';
            }
        }

        function clearForm() {
            document.getElementById('eventForm').reset();
            document.getElementById('eventId').value = '';
            document.getElementById('starttid').value = '20:00';
            document.getElementById('quickPasteInput').value = '';
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('dato').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('submitBtn').innerHTML = 'üì§ Indsend Event';
        }

        async function loadPendingEvents() {
            const list = document.getElementById('pendingList');
            list.innerHTML = '<div class="alert alert-info">üîÑ Indl√¶ser...</div>';
            
            try {
                const callbackName = 'pending_' + Date.now();
                const promise = new Promise((resolve, reject) => {
                    window[callbackName] = (data) => { delete window[callbackName]; resolve(data); };
                    setTimeout(() => { delete window[callbackName]; reject(new Error('Timeout')); }, 10000);
                });
                
                const script = document.createElement('script');
                script.src = `${SCRIPT_URL}?action=getPending&callback=${callbackName}`;
                document.body.appendChild(script);
                
                const data = await promise;
                script.remove();
                
                if (data.success && data.events && data.events.length > 0) {
                    document.getElementById('pendingCount').textContent = data.events.length;
                    list.innerHTML = data.events.map(e => `
                        <div class="event-item">
                            <div class="event-title">${e.Dansetype || 'Event'} @ ${e.Sted || '?'}</div>
                            <div class="event-details">üìÖ ${e.Dato || '?'} kl. ${e.Starttid || '?'} | üìç ${e.By || 'K√∏benhavn'} | üí∞ ${e.Pris || '?'}</div>
                            <div style="margin-top: 8px;"><span class="status-badge status-pending">Afventer</span></div>
                            <button class="btn btn-success btn-small" style="margin-top: 10px;" onclick='editPending(${JSON.stringify(e).replace(/'/g, "\\'")})'>‚úèÔ∏è Rediger & Godkend</button>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<div class="alert alert-info">üì≠ Ingen ventende events</div>';
                    document.getElementById('pendingCount').textContent = '0';
                }
            } catch (error) {
                list.innerHTML = '<div class="alert alert-error">‚ö†Ô∏è Kunne ikke indl√¶se</div>';
            }
        }

        function editPending(e) {
            document.getElementById('eventId').value = e.EventId || '';
            document.getElementById('dato').value = (e.Dato || '').substring(0, 10);
            document.getElementById('starttid').value = e.Starttid || '20:00';
            document.getElementById('sluttid').value = e.Sluttid || '';
            document.getElementById('dansetype').value = e.Dansetype || '';
            document.getElementById('sted').value = e.Sted || '';
            document.getElementById('adresse').value = e.Adresse || '';
            document.getElementById('by').value = e.By || 'K√∏benhavn';
            document.getElementById('pris').value = e.Pris || '';
            document.getElementById('arrangoer').value = e.Arrang√∏r || '';
            document.getElementById('link').value = e.Link || '';
            document.getElementById('recurring').value = e.Recurring || '';
            document.getElementById('submitBtn').innerHTML = '‚úÖ Opdater & Godkend';
            switchTab('submit');
            showAlert('Event indl√¶st - rediger og godkend', 'info');
        }

        // === QUICK PASTE PARSER ===
        function parseQuickPaste() {
            const text = document.getElementById('quickPasteInput').value.trim();
            if (!text) return;

            const lower = text.toLowerCase();
            const parsed = {};

            // === DATO ===
            const months = {jan:'01',feb:'02',mar:'03',apr:'04',maj:'05',may:'05',jun:'06',jul:'07',aug:'08',sep:'09',okt:'10',oct:'10',nov:'11',dec:'12'};
            const dateMatch = text.match(/(\d{1,2})\.?\s*(jan(?:uar)?|feb(?:ruar)?|mar(?:ts)?|apr(?:il)?|maj|may|jun[ie]?|jul[iy]?|aug(?:ust)?|sep(?:t(?:ember)?)?|okt(?:ober)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?)\s*(\d{4})?/i);
            if (dateMatch) {
                const day = dateMatch[1].padStart(2, '0');
                const monthKey = dateMatch[2].substring(0, 3).toLowerCase();
                const month = months[monthKey];
                const year = dateMatch[3] || new Date().getFullYear();
                if (month) parsed.dato = `${year}-${month}-${day}`;
            }

            // === TID - Look for header time pattern first (kl. 19.45-00.15) ===
            const headerTime = text.match(/kl\.?\s*(\d{1,2})[:\.](\d{2})\s*[-‚Äì]\s*(\d{1,2})[:\.](\d{2})/i);
            if (headerTime) {
                parsed.starttid = `${headerTime[1].padStart(2, '0')}:${headerTime[2]}`;
                parsed.sluttid = `${headerTime[3].padStart(2, '0')}:${headerTime[4]}`;
            } else {
                // Look for "Doors open" or first event time
                const doorsMatch = text.match(/(?:doors?\s*open|d√∏rene?\s*√•bner?)[:\s]*(?:kl\.?\s*)?(\d{1,2})[:\.](\d{2})/i);
                if (doorsMatch) {
                    parsed.starttid = `${doorsMatch[1].padStart(2, '0')}:${doorsMatch[2]}`;
                } else {
                    // Find first reasonable evening time (17:00-23:59)
                    const eveningTimes = text.match(/(?:kl\.?\s*)?(\d{1,2})[:\.](\d{2})/g) || [];
                    for (const t of eveningTimes) {
                        const m = t.match(/(\d{1,2})[:\.](\d{2})/);
                        if (m) {
                            const hour = parseInt(m[1]);
                            if (hour >= 17 && hour <= 23) {
                                parsed.starttid = `${m[1].padStart(2, '0')}:${m[2]}`;
                                break;
                            }
                        }
                    }
                }
                
                // Look for end time
                const endMatch = text.match(/(\d{1,2})[:\.](\d{2})\s*[-‚Äì]?\s*(?:slut|tak|end|close|navidad|farvel)/i);
                if (endMatch) {
                    parsed.sluttid = `${endMatch[1].padStart(2, '0')}:${endMatch[2]}`;
                }
            }

            // === DANSETYPE ===
            if (lower.includes('salsa') && lower.includes('bachata')) parsed.dansetype = 'Salsa & Bachata';
            else if (lower.includes('salsa') || lower.includes('rueda') || lower.includes('timba')) parsed.dansetype = 'Salsa';
            else if (lower.includes('bachata')) parsed.dansetype = 'Bachata';
            else if (lower.includes('kizomba')) parsed.dansetype = 'Kizomba';
            else if (lower.includes('zouk')) parsed.dansetype = 'Zouk';
            else if (lower.includes('tango')) parsed.dansetype = 'Tango';
            else if (lower.includes('workshop') || lower.includes('bootcamp') || lower.includes('crash course')) parsed.dansetype = 'Workshop';
            else if (lower.includes('latin')) parsed.dansetype = 'Latin Mix';
            else if (lower.includes('social') || lower.includes('fest') || lower.includes('party')) parsed.dansetype = 'Social';

            // === PRIS - Find all prices and show range ===
            const prices = [];
            const priceRegex = /(\d+)\s*(?:kr\.?|dkk)/gi;
            let pm;
            while ((pm = priceRegex.exec(text)) !== null) {
                const p = parseInt(pm[1]);
                if (p > 0 && p < 2000) prices.push(p);
            }
            if (lower.includes('gratis') || lower.includes('free')) {
                parsed.pris = 'Gratis';
            } else if (prices.length > 0) {
                const min = Math.min(...prices);
                const max = Math.max(...prices);
                parsed.pris = min === max ? `${min} kr` : `${min}-${max} kr`;
            }

            // === STED & ADRESSE ===
            const venues = [
                {name:'Kedelhallen',addr:'Nyelandsvej 75A',city:'Frederiksberg'},
                {name:'Old Irish Pub',addr:'Vesterbrogade 2D',city:'K√∏benhavn'},
                {name:'The Old Irish',addr:'Vesterbrogade 2D',city:'K√∏benhavn'},
                {name:'Copenhagen Salsa Academy',addr:'Kastanie All√© 20',city:'Vanl√∏se'},
                {name:'CSA',addr:'Kastanie All√© 20',city:'Vanl√∏se'},
                {name:'Cubansk Danseskole',addr:'Blegdamsvej 1B',city:'K√∏benhavn'},
                {name:'Vega',addr:'Enghavevej 40',city:'K√∏benhavn'},
                {name:'4Water',addr:'Havnegade 41',city:'K√∏benhavn'}
            ];
            for (const v of venues) {
                if (lower.includes(v.name.toLowerCase())) {
                    parsed.sted = v.name;
                    parsed.adresse = v.addr;
                    parsed.by = v.city;
                    break;
                }
            }
            if (!parsed.adresse) {
                const addrMatch = text.match(/([A-Za-z√¶√∏√•√Ü√ò√Ö]+(?:vej|gade|all√©|torv|plads)\s+\d+[A-Za-z]?)/i);
                if (addrMatch) parsed.adresse = addrMatch[1];
            }
            if (!parsed.by) {
                const cities = ['Frederiksberg','Vanl√∏se','N√∏rrebro','Vesterbro','√òsterbro','Amager','Valby','K√∏benhavn'];
                for (const c of cities) {
                    if (lower.includes(c.toLowerCase())) { parsed.by = c; break; }
                }
            }

            // === ARRANG√òR ===
            const arrMatch = text.match(/begivenhed af\s+([^\n]+?)(?:\s+og\s+[^\n]+)?$/im);
            if (arrMatch) parsed.arrangoer = arrMatch[1].trim();

            // === LINK ===
            const linkMatch = text.match(/(https?:\/\/[^\s]+)/i);
            if (linkMatch) {
                parsed.link = linkMatch[1];
                if (!parsed.dato) {
                    const urlDate = linkMatch[1].match(/(202[4-9])(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])/);
                    if (urlDate) parsed.dato = `${urlDate[1]}-${urlDate[2]}-${urlDate[3]}`;
                }
            }

            // === FILL FORM ===
            let count = 0;
            if (parsed.dato) { document.getElementById('dato').value = parsed.dato; count++; }
            if (parsed.starttid) { document.getElementById('starttid').value = parsed.starttid; count++; }
            if (parsed.sluttid) { document.getElementById('sluttid').value = parsed.sluttid; count++; }
            if (parsed.dansetype) { document.getElementById('dansetype').value = parsed.dansetype; count++; }
            if (parsed.sted) { document.getElementById('sted').value = parsed.sted; count++; }
            if (parsed.adresse) { document.getElementById('adresse').value = parsed.adresse; count++; }
            if (parsed.by) { document.getElementById('by').value = parsed.by; count++; }
            if (parsed.pris) { document.getElementById('pris').value = parsed.pris; count++; }
            if (parsed.arrangoer) { document.getElementById('arrangoer').value = parsed.arrangoer; count++; }
            if (parsed.link) { document.getElementById('link').value = parsed.link; count++; }

            console.log('Parsed:', parsed);
            if (count > 0) {
                showAlert(`‚úÖ ${count} felter udfyldt automatisk!`, 'success');
                document.getElementById('quickPasteInput').value = '';
            } else {
                showAlert('Kunne ikke finde data i teksten', 'error');
            }
        }

        // Test connection
        window.testConnection = async function() {
            const callbackName = 'test_' + Date.now();
            const promise = new Promise((resolve, reject) => {
                window[callbackName] = (data) => { delete window[callbackName]; resolve(data); };
                setTimeout(() => { delete window[callbackName]; reject(new Error('Timeout')); }, 10000);
            });
            const script = document.createElement('script');
            script.src = `${SCRIPT_URL}?action=test&callback=${callbackName}`;
            document.body.appendChild(script);
            try {
                const data = await promise;
                script.remove();
                console.log('Test result:', data);
                alert(data.success ? '‚úÖ Forbindelse OK!' : '‚ùå Fejl: ' + data.error);
            } catch (e) {
                script.remove();
                alert('‚ùå Timeout - har du deployet Kode.gs?');
            }
        };

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('dato').value = tomorrow.toISOString().split('T')[0];
        });
    </script>
</body>
</html>
