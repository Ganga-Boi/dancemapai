<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DanceMap Admin - Event Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --bg-dark: #0f0f23;
            --bg-card: #1a1a2e;
            --bg-input: #252540;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b8;
            --text-muted: #6b6b80;
            --border: #2d2d44;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --gradient-start: #6366f1;
            --gradient-end: #a855f7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 40px;
        }

        .header {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header-nav {
            margin-top: 12px;
            display: flex;
            justify-content: center;
            gap: 12px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .nav-btn.active {
            background: white;
            color: var(--primary);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-muted);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 14px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            transition: all 0.2s;
        }

        .checkbox-label:hover {
            border-color: var(--primary);
        }

        .checkbox-label input[type="checkbox"] {
            width: 22px;
            height: 22px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        .checkbox-text {
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .quick-paste-section {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .quick-paste-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary-light);
        }

        .quick-paste-section textarea {
            width: 100%;
            min-height: 120px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
        }

        .quick-paste-section textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .quick-paste-section textarea::placeholder {
            color: var(--text-muted);
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 24px 0;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .divider span {
            padding: 0 16px;
        }

        .btn {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border: none;
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-input);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
            box-shadow: none;
        }

        .btn-success {
            background: var(--success);
        }

        .btn-danger {
            background: var(--error);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .alert {
            padding: 14px 18px;
            border-radius: 10px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .alert-info {
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid var(--primary);
            color: var(--primary-light);
        }

        .hidden {
            display: none !important;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .tab-btn:hover {
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Event List */
        .event-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .event-item {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
        }

        .event-info {
            flex: 1;
        }

        .event-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .event-details {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .event-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .status-approved {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .status-rejected {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        .status-recurring {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary-light);
            margin-left: 8px;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        .upload-text {
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .upload-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Preview */
        .image-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .parsed-result {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .parsed-field {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .parsed-field:last-child {
            border-bottom: none;
        }

        .parsed-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .parsed-value {
            font-weight: 500;
        }

        /* Loading */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .footer a {
            color: var(--primary-light);
            text-decoration: none;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 16px;
            }

            .card {
                padding: 16px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .event-item {
                flex-direction: column;
            }

            .event-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>‚öôÔ∏è DanceMap Admin</h1>
        <div class="header-nav">
            <a href="index.html" class="nav-btn">‚Üê Tilbage til Chat</a>
            <button class="nav-btn" onclick="refreshPending()">üîÑ Opdater</button>
        </div>
    </header>

    <div class="container">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('submit')">üìù Tilf√∏j Event</button>
            <button class="tab-btn" onclick="switchTab('upload')">üì∑ Upload Flyer</button>
            <button class="tab-btn" onclick="switchTab('pending')">‚è≥ Ventende (<span id="pendingCount">0</span>)</button>
        </div>

        <!-- Alert Area -->
        <div id="alertArea"></div>

        <!-- Submit Tab -->
        <div id="submitTab" class="tab-content active">
            <div class="card">
                <h2 class="card-title">üìù Tilf√∏j Nyt Event</h2>
                <form id="eventForm" onsubmit="submitEvent(event)">
                    <input type="hidden" id="eventId" name="eventId" value="">
                    
                    <!-- Quick Paste Section -->
                    <div class="quick-paste-section">
                        <h3 class="quick-paste-title">‚ö° Quick Paste</h3>
                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 12px;">
                            Kopier tekst fra Facebook, email eller flyer og inds√¶t her:
                        </p>
                        <textarea id="quickPasteInput" placeholder="Inds√¶t event-tekst her...

Eksempel:
Salsa Social @ Kedelhallen
Fredag d. 20. december kl. 21:00
Pris: 100 kr
Adresse: Nyelandsvej 75A, 2000 Frederiksberg"></textarea>
                        <button type="button" class="btn btn-secondary" onclick="parseQuickPaste()" style="margin-top: 10px;">
                            üîç Udtr√¶k data
                        </button>
                    </div>
                    
                    <div class="divider">
                        <span>eller udfyld manuelt</span>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="dato">Dato *</label>
                            <input type="date" id="dato" name="dato" required>
                        </div>
                        <div class="form-group">
                            <label for="starttid">Starttid *</label>
                            <input type="time" id="starttid" name="starttid" value="20:00" required>
                        </div>
                        <div class="form-group">
                            <label for="sluttid">Sluttid</label>
                            <input type="time" id="sluttid" name="sluttid">
                        </div>
                        <div class="form-group">
                            <label for="dansetype">Dansetype *</label>
                            <select id="dansetype" name="dansetype" required>
                                <option value="">V√¶lg type...</option>
                                <option value="Salsa">Salsa</option>
                                <option value="Bachata">Bachata</option>
                                <option value="Kizomba">Kizomba</option>
                                <option value="Salsa & Bachata">Salsa & Bachata</option>
                                <option value="Latin Mix">Latin Mix</option>
                                <option value="Zouk">Zouk</option>
                                <option value="Tango">Tango</option>
                                <option value="Workshop">Workshop</option>
                                <option value="Social">Social / Fest</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label for="sted">Sted / Venue *</label>
                            <input type="text" id="sted" name="sted" placeholder="Fx: Kedelhallen, Old Irish Pub..." required>
                        </div>
                        <div class="form-group full-width">
                            <label for="adresse">Adresse</label>
                            <input type="text" id="adresse" name="adresse" placeholder="Fx: Nyelandsvej 75A, 2000 Frederiksberg">
                        </div>
                        <div class="form-group">
                            <label for="by">By</label>
                            <select id="by" name="by">
                                <option value="K√∏benhavn">K√∏benhavn</option>
                                <option value="Frederiksberg">Frederiksberg</option>
                                <option value="Amager">Amager</option>
                                <option value="√òsterbro">√òsterbro</option>
                                <option value="N√∏rrebro">N√∏rrebro</option>
                                <option value="Vesterbro">Vesterbro</option>
                                <option value="Valby">Valby</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pris">Pris</label>
                            <input type="text" id="pris" name="pris" placeholder="Fx: 100 kr, Gratis, Se event">
                        </div>
                        <div class="form-group full-width">
                            <label for="arrangoer">Arrang√∏r</label>
                            <input type="text" id="arrangoer" name="arrangoer" placeholder="Navn p√• arrang√∏r/venue">
                        </div>
                        <div class="form-group full-width">
                            <label for="link">Link til event</label>
                            <input type="url" id="link" name="link" placeholder="https://...">
                        </div>
                        <div class="form-group full-width">
                            <label for="recurring">Gentagelse</label>
                            <select id="recurring" name="recurring">
                                <option value="">Ingen gentagelse (enkelt event)</option>
                                <option value="weekly">‚ôªÔ∏è Hver uge (samme ugedag)</option>
                                <option value="biweekly">üîÑ Hver anden uge</option>
                                <option value="weekend">üéâ Hver weekend (l√∏r + s√∏n)</option>
                                <option value="monthly">üìÖ Hver m√•ned (samme dato)</option>
                            </select>
                            <small style="color: var(--text-muted); margin-top: 4px; display: block;">
                                V√¶lg gentagelsesm√∏nster for faste events
                            </small>
                        </div>
                    </div>
                    <div style="margin-top: 24px; display: flex; gap: 12px;">
                        <button type="submit" class="btn" id="submitBtn">
                            <span>üì§ Indsend Event</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">
                            üóëÔ∏è Ryd formular
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Upload Tab -->
        <div id="uploadTab" class="tab-content">
            <div class="card">
                <h2 class="card-title">üì∑ Upload Event Flyer</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Upload et billede af en event-flyer, og AI'en vil automatisk udtr√¶kke informationen.
                </p>
                
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üì∑</div>
                    <div class="upload-text">Klik eller tr√¶k en fil hertil</div>
                    <div class="upload-hint">Underst√∏tter JPG, PNG (max 10MB)</div>
                </div>
                <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                
                <div id="previewArea" class="hidden">
                    <img id="imagePreview" class="image-preview" alt="Preview">
                    <button class="btn" id="parseBtn" onclick="parseFlyer()">
                        ü§ñ Analyser med AI
                    </button>
                </div>
                
                <div id="parsedResult" class="parsed-result hidden">
                    <h3 style="margin-bottom: 16px;">üìã Udtr√¶k Resultat</h3>
                    <div id="parsedFields"></div>
                    <div style="margin-top: 20px; display: flex; gap: 12px;">
                        <button class="btn btn-success" onclick="useParsedData()">
                            ‚úÖ Brug disse data
                        </button>
                        <button class="btn btn-secondary" onclick="clearUpload()">
                            üîÑ Start forfra
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Tab -->
        <div id="pendingTab" class="tab-content">
            <div class="card">
                <h2 class="card-title">‚è≥ Ventende Events</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Events der afventer godkendelse. Godkend direkte i Google Sheet ved at √¶ndre Status til "Approved".
                </p>
                
                <div id="pendingList" class="event-list">
                    <div class="alert alert-info">
                        <span>üîÑ</span> Indl√¶ser ventende events...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <a href="index.html">‚Üê Tilbage til DanceMap Chat</a> ¬∑ Admin Panel v1.4.6
    </footer>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzhtfMvSHhBIPnrOvXVuMlvKVqDeJ-B0yiOCE5GHLwwPljpJkMnEQ_Cq2K73ApYkLk/exec";
        
        let currentParsedData = null;
        let uploadedFile = null;

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
            
            if (tabName === 'pending') {
                loadPendingEvents();
            }
        }

        // Show alert
        function showAlert(message, type = 'info') {
            const alertArea = document.getElementById('alertArea');
            alertArea.innerHTML = `
                <div class="alert alert-${type}">
                    <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                    ${message}
                </div>
            `;
            
            setTimeout(() => {
                alertArea.innerHTML = '';
            }, 5000);
        }

        // Submit event
        async function submitEvent(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading-spinner"></span> Sender...';
            
            const eventId = document.getElementById('eventId').value;
            const isUpdate = eventId !== '';
            
            const formData = {
                action: 'submitEvent',
                eventId: eventId || '',
                dato: document.getElementById('dato').value,
                starttid: document.getElementById('starttid').value,
                sluttid: document.getElementById('sluttid').value,
                dansetype: document.getElementById('dansetype').value,
                sted: document.getElementById('sted').value,
                adresse: document.getElementById('adresse').value,
                by: document.getElementById('by').value,
                pris: document.getElementById('pris').value,
                arrangoer: document.getElementById('arrangoer').value,
                link: document.getElementById('link').value,
                recurring: document.getElementById('recurring').value || '',
                status: isUpdate ? 'approved' : 'pending'
            };
            
            try {
                // Using JSONP for cross-origin (same pattern as loadPendingEvents)
                const callbackName = 'submit_callback_' + Date.now();
                
                const promise = new Promise((resolve, reject) => {
                    window[callbackName] = (data) => {
                        delete window[callbackName];
                        resolve(data);
                    };
                    
                    setTimeout(() => {
                        delete window[callbackName];
                        reject(new Error('Timeout'));
                    }, 15000);
                });
                
                // Build URL with all parameters
                const params = new URLSearchParams();
                for (const [key, value] of Object.entries(formData)) {
                    params.append(key, value);
                }
                params.append('callback', callbackName);
                
                const script = document.createElement('script');
                script.src = `${SCRIPT_URL}?${params.toString()}`;
                document.body.appendChild(script);
                
                const data = await promise;
                script.remove();
                
                if (data.success) {
                    const recurringLabels = {
                        'weekly': ' (gentages hver uge)',
                        'biweekly': ' (gentages hver anden uge)',
                        'weekend': ' (gentages hver weekend)',
                        'monthly': ' (gentages hver m√•ned)'
                    };
                    const recurringMsg = recurringLabels[formData.recurring] || '';
                    if (isUpdate) {
                        showAlert('Event opdateret og godkendt! üéâ' + recurringMsg, 'success');
                    } else {
                        showAlert('Event indsendt til godkendelse! üéâ' + recurringMsg, 'success');
                    }
                    clearForm();
                    
                    // Refresh pending list if we just approved an event
                    if (isUpdate) {
                        loadPendingEvents();
                    }
                } else {
                    showAlert('Fejl: ' + (data.error || 'Kunne ikke gemme event'), 'error');
                }
                
            } catch (error) {
                console.error('Submit error:', error);
                showAlert('Netv√¶rksfejl - pr√∏v igen', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = isUpdate 
                    ? '<span>‚úÖ Opdater & Godkend</span>' 
                    : '<span>üì§ Indsend Event</span>';
            }
        }

        // Clear form - reset to tomorrow's date
        function clearForm() {
            document.getElementById('eventForm').reset();
            document.getElementById('eventId').value = '';
            document.getElementById('starttid').value = '20:00';
            document.getElementById('recurring').value = '';
            
            // Set date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('dato').value = tomorrow.toISOString().split('T')[0];
            
            // Reset button text
            document.getElementById('submitBtn').innerHTML = '<span>üì§ Indsend Event</span>';
        }

        // File handling
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showAlert('V√¶lg venligst en billedfil', 'error');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showAlert('Filen er for stor (max 10MB)', 'error');
                return;
            }
            
            uploadedFile = file;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('previewArea').classList.remove('hidden');
                document.getElementById('uploadArea').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        // Parse flyer with AI (placeholder - would need Claude Vision API)
        async function parseFlyer() {
            const parseBtn = document.getElementById('parseBtn');
            parseBtn.disabled = true;
            parseBtn.innerHTML = '<span class="loading-spinner"></span> Analyserer...';
            
            // Simulate AI parsing - in production this would call Claude Vision API
            setTimeout(() => {
                currentParsedData = {
                    dato: '',
                    starttid: '20:00',
                    dansetype: 'Salsa & Bachata',
                    sted: '',
                    pris: ''
                };
                
                const fieldsHtml = Object.entries({
                    'Dato': currentParsedData.dato || '(Ikke fundet)',
                    'Starttid': currentParsedData.starttid,
                    'Dansetype': currentParsedData.dansetype,
                    'Sted': currentParsedData.sted || '(Ikke fundet)',
                    'Pris': currentParsedData.pris || '(Ikke fundet)'
                }).map(([label, value]) => `
                    <div class="parsed-field">
                        <span class="parsed-label">${label}</span>
                        <span class="parsed-value">${value}</span>
                    </div>
                `).join('');
                
                document.getElementById('parsedFields').innerHTML = fieldsHtml;
                document.getElementById('parsedResult').classList.remove('hidden');
                
                parseBtn.disabled = false;
                parseBtn.innerHTML = 'ü§ñ Analyser med AI';
                
                showAlert('Billede analyseret! Gennemg√• resultaterne.', 'info');
            }, 2000);
        }

        function useParsedData() {
            if (currentParsedData) {
                if (currentParsedData.dato) document.getElementById('dato').value = currentParsedData.dato;
                if (currentParsedData.starttid) document.getElementById('starttid').value = currentParsedData.starttid;
                if (currentParsedData.dansetype) {
                    const select = document.getElementById('dansetype');
                    for (let option of select.options) {
                        if (option.value.toLowerCase().includes(currentParsedData.dansetype.toLowerCase())) {
                            select.value = option.value;
                            break;
                        }
                    }
                }
                if (currentParsedData.sted) document.getElementById('sted').value = currentParsedData.sted;
                if (currentParsedData.pris) document.getElementById('pris').value = currentParsedData.pris;
                
                switchTab('submit');
                showAlert('Data indsat i formularen. Udfyld resten og indsend.', 'success');
            }
        }

        function clearUpload() {
            document.getElementById('fileInput').value = '';
            document.getElementById('previewArea').classList.add('hidden');
            document.getElementById('parsedResult').classList.add('hidden');
            document.getElementById('uploadArea').classList.remove('hidden');
            uploadedFile = null;
            currentParsedData = null;
        }

        // Load pending events
        async function loadPendingEvents() {
            const pendingList = document.getElementById('pendingList');
            pendingList.innerHTML = '<div class="alert alert-info"><span>üîÑ</span> Indl√¶ser...</div>';
            
            try {
                // Using JSONP for cross-origin
                const callbackName = 'pending_callback_' + Date.now();
                
                const promise = new Promise((resolve, reject) => {
                    window[callbackName] = (data) => {
                        delete window[callbackName];
                        resolve(data);
                    };
                    
                    setTimeout(() => {
                        delete window[callbackName];
                        reject(new Error('Timeout'));
                    }, 10000);
                });
                
                const script = document.createElement('script');
                script.src = `${SCRIPT_URL}?action=getPending&callback=${callbackName}`;
                document.body.appendChild(script);
                
                const data = await promise;
                script.remove();
                
                if (data.success && data.events) {
                    renderPendingEvents(data.events);
                } else {
                    pendingList.innerHTML = '<div class="alert alert-info"><span>üì≠</span> Ingen ventende events</div>';
                }
            } catch (error) {
                console.error('Error loading pending:', error);
                pendingList.innerHTML = `
                    <div class="alert alert-error">
                        <span>‚ö†Ô∏è</span> Kunne ikke indl√¶se events. 
                        <a href="https://docs.google.com/spreadsheets/d/1nECcg7qrlfvQabDaIhPheXeQ4FhIOjLT_k/edit" target="_blank" style="color: inherit; text-decoration: underline;">
                            √Öbn Google Sheet direkte
                        </a>
                    </div>
                `;
            }
        }

        function renderPendingEvents(events) {
            const pendingList = document.getElementById('pendingList');
            document.getElementById('pendingCount').textContent = events.length;
            
            if (events.length === 0) {
                pendingList.innerHTML = '<div class="alert alert-info"><span>üì≠</span> Ingen ventende events</div>';
                return;
            }
            
            pendingList.innerHTML = events.map((event, index) => {
                const recurringValue = event.Recurring || '';
                const recurringLabels = {
                    'weekly': '‚ôªÔ∏è Ugentlig',
                    'biweekly': 'üîÑ Hver 2. uge',
                    'weekend': 'üéâ Weekend',
                    'monthly': 'üìÖ M√•nedlig',
                    'true': '‚ôªÔ∏è Ugentlig',
                    'TRUE': '‚ôªÔ∏è Ugentlig'
                };
                const recurringBadge = recurringLabels[recurringValue] 
                    ? `<span class="status-badge status-recurring">${recurringLabels[recurringValue]}</span>` 
                    : '';
                const eventDataJson = encodeURIComponent(JSON.stringify(event));
                return `
                <div class="event-item">
                    <div class="event-info">
                        <div class="event-title">${event.Dansetype || event.dansetype || 'Ukendt type'} @ ${event.Sted || event.sted || 'Ukendt sted'}</div>
                        <div class="event-details">
                            üìÖ ${event.Dato || event.dato || 'Ingen dato'} kl. ${event.Starttid || event.starttid || '?'}<br>
                            üìç ${event.By || event.by || 'K√∏benhavn'}<br>
                            üí∞ ${event.Pris || event.pris || 'Ikke angivet'}
                        </div>
                        <div style="margin-top: 8px;">
                            <span class="status-badge status-pending">Afventer</span>
                            ${recurringBadge}
                        </div>
                    </div>
                    <div class="event-actions">
                        <button class="btn btn-small btn-success" onclick="editPending('${eventDataJson}')">
                            ‚úèÔ∏è Rediger & Godkend
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        function refreshPending() {
            loadPendingEvents();
            showAlert('Liste opdateret', 'info');
        }

        // Edit pending event - fill form and switch to submit tab
        function editPending(encodedData) {
            try {
                const event = JSON.parse(decodeURIComponent(encodedData));
                
                // Fill form fields
                document.getElementById('eventId').value = event.EventId || event.eventId || '';
                
                // Handle date - might be in various formats
                let dateValue = event.Dato || event.dato || '';
                if (dateValue) {
                    // Try to extract just the date part if it includes time
                    const dateMatch = dateValue.toString().match(/(\d{4}-\d{2}-\d{2})/);
                    if (dateMatch) {
                        dateValue = dateMatch[1];
                    } else {
                        // Try to parse and format
                        const parsed = new Date(dateValue);
                        if (!isNaN(parsed)) {
                            dateValue = parsed.toISOString().split('T')[0];
                        }
                    }
                }
                document.getElementById('dato').value = dateValue;
                
                document.getElementById('starttid').value = event.Starttid || event.starttid || '20:00';
                document.getElementById('sluttid').value = event.Sluttid || event.sluttid || '';
                
                // Handle dansetype - try to match with select options
                const dansetype = event.Dansetype || event.dansetype || '';
                const dansetypeSelect = document.getElementById('dansetype');
                let matched = false;
                for (let option of dansetypeSelect.options) {
                    if (option.value && dansetype.toLowerCase().includes(option.value.toLowerCase())) {
                        dansetypeSelect.value = option.value;
                        matched = true;
                        break;
                    }
                }
                if (!matched) {
                    dansetypeSelect.value = '';
                }
                
                document.getElementById('sted').value = event.Sted || event.sted || '';
                document.getElementById('adresse').value = event.Adresse || event.adresse || '';
                
                // Handle by - match with select options
                const by = event.By || event.by || 'K√∏benhavn';
                const bySelect = document.getElementById('by');
                for (let option of bySelect.options) {
                    if (option.value.toLowerCase() === by.toLowerCase()) {
                        bySelect.value = option.value;
                        break;
                    }
                }
                
                document.getElementById('pris').value = event.Pris || event.pris || '';
                document.getElementById('arrangoer').value = event.Arrang√∏r || event.arrangoer || '';
                document.getElementById('link').value = event.Link || event.link || '';
                
                const isRecurring = event.Recurring || '';
                // Handle legacy boolean values
                let recurringValue = isRecurring;
                if (isRecurring === true || isRecurring === 'TRUE' || isRecurring === 'true') {
                    recurringValue = 'weekly';
                }
                document.getElementById('recurring').value = recurringValue;
                
                // Change button text
                document.getElementById('submitBtn').innerHTML = '<span>‚úÖ Opdater & Godkend</span>';
                
                // Switch to submit tab
                switchTab('submit');
                
                showAlert('Event indl√¶st - rediger og klik "Opdater & Godkend"', 'info');
                
            } catch (error) {
                console.error('Error parsing event data:', error);
                showAlert('Kunne ikke indl√¶se event data', 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('dato').value = tomorrow.toISOString().split('T')[0];
        });

        // Quick Paste Parser
        function parseQuickPaste() {
            const text = document.getElementById('quickPasteInput').value.trim();
            if (!text) {
                showAlert('Inds√¶t noget tekst f√∏rst', 'error');
                return;
            }

            const lower = text.toLowerCase();
            const parsed = {
                dato: null,
                starttid: null,
                sluttid: null,
                dansetype: null,
                sted: null,
                adresse: null,
                by: null,
                pris: null,
                arrangoer: null,
                link: null
            };

            // === DATO PARSING ===
            // "20. december", "d. 20 december", "20/12", "2024-12-20"
            const datePatterns = [
                /(\d{1,2})\.?\s*(jan|feb|mar|apr|maj|jun|jul|aug|sep|okt|nov|dec|januar|februar|marts|april|maj|juni|juli|august|september|oktober|november|december)\s*(\d{4})?/i,
                /(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.]?(\d{2,4})?/,
                /(\d{4})-(\d{2})-(\d{2})/
            ];

            const monthMap = {
                'jan': '01', 'januar': '01', 'feb': '02', 'februar': '02',
                'mar': '03', 'marts': '03', 'apr': '04', 'april': '04',
                'maj': '05', 'jun': '06', 'juni': '06', 'jul': '07', 'juli': '07',
                'aug': '08', 'august': '08', 'sep': '09', 'september': '09',
                'okt': '10', 'oktober': '10', 'nov': '11', 'november': '11',
                'dec': '12', 'december': '12'
            };

            for (const pattern of datePatterns) {
                const match = text.match(pattern);
                if (match) {
                    if (match[0].includes('-') && match[0].length === 10) {
                        // ISO format
                        parsed.dato = match[0];
                    } else if (monthMap[match[2]?.toLowerCase()]) {
                        // "20. december 2024"
                        const day = match[1].padStart(2, '0');
                        const month = monthMap[match[2].toLowerCase()];
                        const year = match[3] || new Date().getFullYear();
                        parsed.dato = `${year}-${month}-${day}`;
                    } else if (match[1] && match[2]) {
                        // "20/12" or "20-12-2024"
                        const day = match[1].padStart(2, '0');
                        const month = match[2].padStart(2, '0');
                        let year = match[3] || new Date().getFullYear();
                        if (year.toString().length === 2) year = '20' + year;
                        parsed.dato = `${year}-${month}-${day}`;
                    }
                    break;
                }
            }

            // === TID PARSING ===
            // "kl. 21:00", "21.00", "kl 21", "21:00-23:00", "19:30 ‚Äì Doors open", "21:00‚Äì01:00"
            const timeMatch = text.match(/kl\.?\s*(\d{1,2})[:\.]?(\d{2})?\s*(?:[-‚Äì]\s*(\d{1,2})[:\.]?(\d{2})?)?/i);
            if (timeMatch) {
                const startHour = timeMatch[1].padStart(2, '0');
                const startMin = timeMatch[2] || '00';
                parsed.starttid = `${startHour}:${startMin}`;
                
                if (timeMatch[3]) {
                    const endHour = timeMatch[3].padStart(2, '0');
                    const endMin = timeMatch[4] || '00';
                    parsed.sluttid = `${endHour}:${endMin}`;
                }
            } else {
                // Try "19:30 ‚Äì Doors" or "21:00‚Äì01:00" pattern
                const programTimeMatch = text.match(/(\d{1,2}):(\d{2})\s*[-‚Äì]/);
                if (programTimeMatch) {
                    parsed.starttid = `${programTimeMatch[1].padStart(2, '0')}:${programTimeMatch[2]}`;
                }
                // Look for end time like "‚Äì01:00" or "-23:00"
                const endTimeMatch = text.match(/[-‚Äì]\s*(\d{1,2}):(\d{2})\s*[-‚Äì]?\s*(?:social|dancing|party|fest)/i);
                if (endTimeMatch) {
                    parsed.sluttid = `${endTimeMatch[1].padStart(2, '0')}:${endTimeMatch[2]}`;
                }
            }
            
            // Fallback: bare "21:00"
            if (!parsed.starttid) {
                const simpleTime = text.match(/(\d{1,2}):(\d{2})/);
                if (simpleTime) {
                    parsed.starttid = `${simpleTime[1].padStart(2, '0')}:${simpleTime[2]}`;
                }
            }

            // === ARRANG√òR PARSING ===
            // "Begivenhed af X", "Event by X", "Hosted by X"
            const arrangorMatch = text.match(/(?:begivenhed af|event by|hosted by|arrang√∏r[:\s]*|organizer[:\s]*)\s*([^\n,]+)/i);
            if (arrangorMatch) {
                parsed.arrangoer = arrangorMatch[1].trim();
            }

            // === DANSETYPE PARSING ===
            const danceTypes = [
                { keywords: ['salsa', 'rueda'], value: 'Salsa' },
                { keywords: ['bachata', 'sensual'], value: 'Bachata' },
                { keywords: ['kizomba', 'kiz', 'semba'], value: 'Kizomba' },
                { keywords: ['zouk'], value: 'Zouk' },
                { keywords: ['tango'], value: 'Tango' },
                { keywords: ['latin mix', 'latin party'], value: 'Latin Mix' },
                { keywords: ['workshop', 'kursus', 'class'], value: 'Workshop' },
                { keywords: ['social', 'fest', 'party'], value: 'Social' }
            ];

            const foundTypes = [];
            for (const type of danceTypes) {
                if (type.keywords.some(kw => lower.includes(kw))) {
                    foundTypes.push(type.value);
                }
            }

            if (foundTypes.includes('Salsa') && foundTypes.includes('Bachata')) {
                parsed.dansetype = 'Salsa & Bachata';
            } else if (foundTypes.length > 0) {
                parsed.dansetype = foundTypes[0];
            }

            // === PRIS PARSING ===
            // Patterns: "60 kr", "60 DKK", "Entry: 60 DKK", "Pris: 100", "gratis"
            if (lower.includes('gratis') || lower.includes('free') || lower.includes('fri entr')) {
                parsed.pris = 'Gratis';
            } else {
                const pricePatterns = [
                    /entry[:\s]*(\d+)\s*(?:kr|dkk)/i,      // "Entry: 60 DKK"
                    /(\d+)\s*dkk/i,                         // "60 DKK"
                    /(\d+)\s*kr\.?/i,                       // "60 kr"
                    /pris[:\s]*(\d+)/i,                     // "Pris: 100"
                    /price[:\s]*(\d+)/i                     // "Price: 100"
                ];
                for (const pattern of pricePatterns) {
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        parsed.pris = match[1] + ' kr';
                        break;
                    }
                }
            }

            // === STED/VENUE PARSING ===
            const knownVenues = [
                { name: 'Kedelhallen', address: 'Nyelandsvej 75A', city: 'Frederiksberg' },
                { name: 'Old Irish Pub', address: 'Vesterbrogade 2D', city: 'K√∏benhavn' },
                { name: 'The Old Irish', address: 'Vesterbrogade 2D', city: 'K√∏benhavn' },
                { name: 'Bachata House', address: '', city: 'K√∏benhavn' },
                { name: 'Copenhagen Salsa Academy', address: '', city: 'K√∏benhavn' },
                { name: 'CSA', address: '', city: 'K√∏benhavn' },
                { name: 'Dansens Hus', address: '', city: 'K√∏benhavn' },
                { name: 'Vega', address: 'Enghavevej 40', city: 'K√∏benhavn' },
                { name: 'Cubansk Danseskole', address: 'Blegdamsvej 104', city: 'K√∏benhavn' },
                { name: 'Havana Social', address: '', city: 'K√∏benhavn' }
            ];

            for (const venue of knownVenues) {
                if (lower.includes(venue.name.toLowerCase())) {
                    parsed.sted = venue.name;
                    if (venue.address) parsed.adresse = venue.address;
                    if (venue.city) parsed.by = venue.city;
                    break;
                }
            }

            // === ADRESSE PARSING (hvis ikke fundet via venue) ===
            if (!parsed.adresse) {
                const addressMatch = text.match(/([A-Za-z√¶√∏√•√Ü√ò√Ö]+(?:vej|gade|torv|plads|all√©|str√¶de|boulevard)\s+\d+[A-Za-z]?)/i);
                if (addressMatch) {
                    parsed.adresse = addressMatch[1];
                }
            }

            // === POSTNUMMER & BY ===
            const zipMatch = text.match(/(\d{4})\s+(K√∏benhavn|Frederiksberg|Amager|Valby|√òsterbro|N√∏rrebro|Vesterbro)/i);
            if (zipMatch) {
                if (!parsed.adresse) {
                    parsed.adresse = (parsed.adresse || '') + ', ' + zipMatch[0];
                }
                parsed.by = zipMatch[2];
            }

            // === LINK PARSING ===
            const linkMatch = text.match(/(https?:\/\/[^\s\n]+)/i);
            if (linkMatch) {
                parsed.link = linkMatch[1];
                
                // Try to extract date from URL (common in booking systems like bookwhen, eventbrite)
                // Pattern: 20251227 (YYYYMMDD format), -2025-12-27, or similar
                if (!parsed.dato) {
                    const url = linkMatch[1];
                    
                    // Try YYYYMMDD format (with optional time suffix)
                    const yyyymmdd = url.match(/(202[4-9])(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])/);
                    if (yyyymmdd) {
                        parsed.dato = `${yyyymmdd[1]}-${yyyymmdd[2]}-${yyyymmdd[3]}`;
                        console.log('Found date in URL (YYYYMMDD):', parsed.dato);
                    }
                    
                    // Try YYYY-MM-DD format
                    if (!parsed.dato) {
                        const isoDate = url.match(/(202[4-9])-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])/);
                        if (isoDate) {
                            parsed.dato = `${isoDate[1]}-${isoDate[2]}-${isoDate[3]}`;
                            console.log('Found date in URL (ISO):', parsed.dato);
                        }
                    }
                }
            }
            
            // Debug: Log what was parsed
            console.log('Parsed data:', parsed);

            // === UDFYLD FORMULAR ===
            let filledCount = 0;

            if (parsed.dato) {
                document.getElementById('dato').value = parsed.dato;
                filledCount++;
            }
            if (parsed.starttid) {
                document.getElementById('starttid').value = parsed.starttid;
                filledCount++;
            }
            if (parsed.sluttid) {
                document.getElementById('sluttid').value = parsed.sluttid;
                filledCount++;
            }
            if (parsed.dansetype) {
                const select = document.getElementById('dansetype');
                for (let option of select.options) {
                    if (option.value === parsed.dansetype || option.value.includes(parsed.dansetype)) {
                        select.value = option.value;
                        filledCount++;
                        break;
                    }
                }
            }
            if (parsed.sted) {
                document.getElementById('sted').value = parsed.sted;
                filledCount++;
            }
            if (parsed.adresse) {
                document.getElementById('adresse').value = parsed.adresse.replace(/^,\s*/, '');
                filledCount++;
            }
            if (parsed.by) {
                const bySelect = document.getElementById('by');
                for (let option of bySelect.options) {
                    if (option.value.toLowerCase() === parsed.by.toLowerCase()) {
                        bySelect.value = option.value;
                        filledCount++;
                        break;
                    }
                }
            }
            if (parsed.pris) {
                document.getElementById('pris').value = parsed.pris;
                filledCount++;
            }
            if (parsed.arrangoer) {
                document.getElementById('arrangoer').value = parsed.arrangoer;
                filledCount++;
            }
            if (parsed.link) {
                document.getElementById('link').value = parsed.link;
                filledCount++;
            }

            // Feedback
            if (filledCount > 0) {
                showAlert(`‚úÖ ${filledCount} felter udfyldt automatisk! Tjek og udfyld resten.`, 'success');
                document.getElementById('quickPasteInput').value = '';
            } else {
                showAlert('Kunne ikke finde data i teksten. Pr√∏v et andet format.', 'error');
            }
        }
    </script>
</body>
</html>
