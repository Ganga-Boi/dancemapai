<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DanceMap Admin - Indsend Events</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --secondary: #ed64a6;
            --bg-dark: #0f0f23;
            --bg-card: #1a1a2e;
            --bg-input: #16213e;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --text-muted: #718096;
            --border: #2d3748;
            --success: #48bb78;
            --warning: #ed8936;
            --error: #fc8181;
            --radius: 16px;
            --radius-sm: 12px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1a2e 50%, #16213e 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .header p {
            color: var(--text-secondary);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            border-color: var(--primary);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-color: transparent;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .quick-paste-section {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 16px;
            margin-bottom: 20px;
        }

        .quick-paste-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary);
        }

        .quick-paste-section textarea {
            width: 100%;
            min-height: 120px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
            margin-top: 8px;
        }

        .quick-paste-section textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .quick-paste-section textarea::placeholder {
            color: var(--text-muted);
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 24px 0;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .divider span {
            padding: 0 16px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group input::placeholder {
            color: var(--text-muted);
        }

        .required {
            color: var(--error);
        }

        .btn {
            padding: 14px 28px;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .alert {
            padding: 14px 18px;
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: rgba(72, 187, 120, 0.15);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .alert-error {
            background: rgba(252, 129, 129, 0.15);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .alert-info {
            background: rgba(102, 126, 234, 0.15);
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .event-item {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
        }

        .event-info {
            flex: 1;
        }

        .event-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .event-details {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .event-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-pending {
            background: rgba(237, 137, 54, 0.2);
            color: var(--warning);
        }

        .status-recurring {
            background: rgba(102, 126, 234, 0.2);
            color: var(--primary);
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 600px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .event-item {
                flex-direction: column;
            }
            
            .event-actions {
                width: 100%;
            }
            
            .event-actions .btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé≠ DanceMap Admin</h1>
            <p>Administrer danse-events i K√∏benhavn</p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('submit')">üìù Tilf√∏j Event</button>
            <button class="tab-btn" onclick="switchTab('pending')">‚è≥ Ventende (<span id="pendingCount">0</span>)</button>
        </div>

        <div id="alertContainer"></div>

        <!-- SUBMIT TAB -->
        <div id="submitTab" class="tab-content active">
            <div class="card">
                <form id="eventForm" onsubmit="submitEvent(event)">
                    <input type="hidden" id="eventId" name="eventId" value="">
                    
                    <!-- Quick Paste Section -->
                    <div class="quick-paste-section">
                        <div class="quick-paste-title">‚ö° Quick Paste - bare inds√¶t!</div>
                        <p style="color: var(--text-secondary); font-size: 0.85rem;">
                            Kopier tekst fra Facebook/email og inds√¶t her - felterne udfyldes automatisk:
                        </p>
                        <textarea id="quickPasteInput" placeholder="Inds√¶t event-tekst her - felterne udfyldes automatisk!

Eksempel:
Salsa Social @ Kedelhallen
Fredag d. 20. december kl. 21:00
Pris: 100 kr
https://facebook.com/events/123" onpaste="setTimeout(parseQuickPaste, 100)"></textarea>
                    </div>
                    
                    <div class="divider">
                        <span>eller udfyld manuelt</span>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Dato <span class="required">*</span></label>
                            <input type="date" id="dato" name="dato" required>
                        </div>

                        <div class="form-group">
                            <label>Starttid <span class="required">*</span></label>
                            <input type="time" id="starttid" name="starttid" value="20:00" required>
                        </div>

                        <div class="form-group">
                            <label>Sluttid</label>
                            <input type="time" id="sluttid" name="sluttid">
                        </div>

                        <div class="form-group">
                            <label>Dansetype <span class="required">*</span></label>
                            <select id="dansetype" name="dansetype" required>
                                <option value="">V√¶lg type...</option>
                                <option value="Salsa">Salsa</option>
                                <option value="Bachata">Bachata</option>
                                <option value="Kizomba">Kizomba</option>
                                <option value="Salsa & Bachata">Salsa & Bachata</option>
                                <option value="Latin Mix">Latin Mix</option>
                                <option value="Zouk">Zouk</option>
                                <option value="Tango">Tango</option>
                                <option value="Workshop">Workshop</option>
                                <option value="Social">Social / Party</option>
                                <option value="Andet">Andet</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Sted / Venue <span class="required">*</span></label>
                            <input type="text" id="sted" name="sted" placeholder="Fx: Kedelhallen" required>
                        </div>

                        <div class="form-group">
                            <label>Adresse</label>
                            <input type="text" id="adresse" name="adresse" placeholder="Fx: Nyelandsvej 75A">
                        </div>

                        <div class="form-group">
                            <label>By</label>
                            <select id="by" name="by">
                                <option value="K√∏benhavn">K√∏benhavn</option>
                                <option value="Frederiksberg">Frederiksberg</option>
                                <option value="Amager">Amager</option>
                                <option value="N√∏rrebro">N√∏rrebro</option>
                                <option value="Vesterbro">Vesterbro</option>
                                <option value="√òsterbro">√òsterbro</option>
                                <option value="Valby">Valby</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Pris</label>
                            <input type="text" id="pris" name="pris" placeholder="Fx: 100 kr, Gratis, Se event">
                        </div>

                        <div class="form-group">
                            <label>Arrang√∏r</label>
                            <input type="text" id="arrangoer" name="arrangoer" placeholder="Navn p√• arrang√∏r/venue">
                        </div>

                        <div class="form-group full-width">
                            <label>Link til event</label>
                            <input type="url" id="link" name="link" placeholder="https://...">
                        </div>

                        <div class="form-group full-width">
                            <label for="recurring">Gentagelse</label>
                            <select id="recurring" name="recurring">
                                <option value="">Ingen gentagelse (enkelt event)</option>
                                <option value="weekly">‚ôªÔ∏è Hver uge (samme ugedag)</option>
                                <option value="biweekly">üîÑ Hver anden uge</option>
                                <option value="weekend">üéâ Hver weekend (l√∏r + s√∏n)</option>
                                <option value="monthly">üìÖ Hver m√•ned (samme dato)</option>
                            </select>
                            <small style="color: var(--text-muted); margin-top: 4px;">
                                V√¶lg gentagelsesm√∏nster for faste events
                            </small>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <span>üì§ Indsend Event</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">
                            üóëÔ∏è Ryd formular
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- PENDING TAB -->
        <div id="pendingTab" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 class="card-title" style="margin: 0;">Ventende Events</h3>
                    <button class="btn btn-secondary btn-small" onclick="loadPendingEvents()">üîÑ Opdater</button>
                </div>
                <div id="pendingList">
                    <div class="alert alert-info">
                        <span>üí°</span> Klik p√• "Ventende" fanen for at indl√¶se events
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzhtfMvSHhBIPnrOvXVuMlvKVqDeJ-B0yiOCE5GHLwwPljpJkMnEQ_Cq2K73ApYkLk/exec";

        // Test connection - call from console: testConnection()
        async function testConnection() {
            console.log('üß™ Testing connection to:', SCRIPT_URL);
            
            const callbackName = 'test_callback_' + Date.now();
            
            const promise = new Promise((resolve, reject) => {
                window[callbackName] = (data) => {
                    delete window[callbackName];
                    resolve(data);
                };
                setTimeout(() => {
                    delete window[callbackName];
                    reject(new Error('Timeout after 10s'));
                }, 10000);
            });
            
            const script = document.createElement('script');
            script.src = `${SCRIPT_URL}?action=test&callback=${callbackName}`;
            console.log('üîó Test URL:', script.src);
            script.onerror = (e) => console.error('‚ùå Script error:', e);
            document.body.appendChild(script);
            
            try {
                const data = await promise;
                script.remove();
                console.log('‚úÖ Connection test result:', data);
                
                if (data.success) {
                    alert(`‚úÖ Forbindelse OK!\n\nSpreadsheet: ${data.spreadsheetName}\nSheets: ${data.sheets.join(', ')}\nPending: ${data.pendingSheet} (${data.pendingRows} r√¶kker)`);
                } else {
                    alert(`‚ùå Fejl: ${data.error}`);
                }
                return data;
            } catch (error) {
                script.remove();
                console.error('‚ùå Test failed:', error);
                alert(`‚ùå Forbindelse fejlede: ${error.message}\n\nHar du deployet den nye Kode.gs?`);
                return { success: false, error: error.message };
            }
        }
        
        window.testConnection = testConnection;

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
            
            if (tabName === 'pending') {
                loadPendingEvents();
            }
        }

        // Show alert
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `<span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : 'üí°'}</span> ${message}`;
            container.appendChild(alert);
            
            setTimeout(() => alert.remove(), 5000);
        }

        // Submit event
        async function submitEvent(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading-spinner"></span> Sender...';
            
            const eventId = document.getElementById('eventId').value;
            const isUpdate = eventId !== '';
            
            const formData = {
                action: 'submitEvent',
                eventId: eventId || '',
                dato: document.getElementById('dato').value,
                starttid: document.getElementById('starttid').value,
                sluttid: document.getElementById('sluttid').value,
                dansetype: document.getElementById('dansetype').value,
                sted: document.getElementById('sted').value,
                adresse: document.getElementById('adresse').value,
                by: document.getElementById('by').value,
                pris: document.getElementById('pris').value,
                arrangoer: document.getElementById('arrangoer').value,
                link: document.getElementById('link').value,
                recurring: document.getElementById('recurring').value || '',
                status: isUpdate ? 'approved' : 'pending'
            };
            
            try {
                console.log('üì§ Submitting event:', formData);
                
                const callbackName = 'submit_callback_' + Date.now();
                
                const promise = new Promise((resolve, reject) => {
                    window[callbackName] = (data) => {
                        delete window[callbackName];
                        resolve(data);
                    };
                    setTimeout(() => {
                        delete window[callbackName];
                        reject(new Error('Timeout'));
                    }, 15000);
                });
                
                const params = new URLSearchParams();
                for (const [key, value] of Object.entries(formData)) {
                    params.append(key, value);
                }
                params.append('callback', callbackName);
                
                const script = document.createElement('script');
                script.src = `${SCRIPT_URL}?${params.toString()}`;
                console.log('üîó Request URL:', script.src);
                script.onerror = (e) => console.error('‚ùå Script error:', e);
                document.body.appendChild(script);
                
                const data = await promise;
                script.remove();
                
                console.log('üì¨ Server response:', data);
                
                if (data.success) {
                    const recurringLabels = {
                        'weekly': ' (gentages hver uge)',
                        'biweekly': ' (gentages hver anden uge)',
                        'weekend': ' (gentages hver weekend)',
                        'monthly': ' (gentages hver m√•ned)'
                    };
                    const recurringMsg = recurringLabels[formData.recurring] || '';
                    if (isUpdate) {
                        showAlert('Event opdateret og godkendt! üéâ' + recurringMsg, 'success');
                    } else {
                        showAlert(`Event indsendt! üéâ ID: ${data.eventId}` + recurringMsg, 'success');
                    }
                    clearForm();
                    loadPendingEvents();
                } else {
                    console.error('‚ùå Server error:', data);
                    showAlert('Fejl: ' + (data.error || JSON.stringify(data)), 'error');
                }
                
            } catch (error) {
                console.error('Submit error:', error);
                showAlert('Netv√¶rksfejl - pr√∏v igen', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = isUpdate 
                    ? '<span>‚úÖ Opdater & Godkend</span>' 
                    : '<span>üì§ Indsend Event</span>';
            }
        }

        // Clear form
        function clearForm() {
            document.getElementById('eventForm').reset();
            document.getElementById('eventId').value = '';
            document.getElementById('starttid').value = '20:00';
            document.getElementById('recurring').value = '';
            document.getElementById('quickPasteInput').value = '';
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('dato').value = tomorrow.toISOString().split('T')[0];
            
            document.getElementById('submitBtn').innerHTML = '<span>üì§ Indsend Event</span>';
        }

        // Load pending events
        async function loadPendingEvents() {
            const pendingList = document.getElementById('pendingList');
            pendingList.innerHTML = '<div class="alert alert-info"><span>üîÑ</span> Indl√¶ser...</div>';
            
            try {
                const callbackName = 'pending_callback_' + Date.now();
                
                const promise = new Promise((resolve, reject) => {
                    window[callbackName] = (data) => {
                        delete window[callbackName];
                        resolve(data);
                    };
                    setTimeout(() => {
                        delete window[callbackName];
                        reject(new Error('Timeout'));
                    }, 10000);
                });
                
                const script = document.createElement('script');
                script.src = `${SCRIPT_URL}?action=getPending&callback=${callbackName}`;
                document.body.appendChild(script);
                
                const data = await promise;
                script.remove();
                
                if (data.success && data.events) {
                    renderPendingEvents(data.events);
                } else {
                    pendingList.innerHTML = '<div class="alert alert-info"><span>üì≠</span> Ingen ventende events</div>';
                }
            } catch (error) {
                console.error('Error loading pending:', error);
                pendingList.innerHTML = '<div class="alert alert-error"><span>‚ö†Ô∏è</span> Kunne ikke indl√¶se events</div>';
            }
        }

        // Render pending events
        function renderPendingEvents(events) {
            const pendingList = document.getElementById('pendingList');
            document.getElementById('pendingCount').textContent = events.length;
            
            if (events.length === 0) {
                pendingList.innerHTML = '<div class="alert alert-info"><span>üì≠</span> Ingen ventende events</div>';
                return;
            }
            
            pendingList.innerHTML = events.map((event) => {
                const recurringValue = event.Recurring || '';
                const recurringLabels = {
                    'weekly': '‚ôªÔ∏è Ugentlig',
                    'biweekly': 'üîÑ Hver 2. uge',
                    'weekend': 'üéâ Weekend',
                    'monthly': 'üìÖ M√•nedlig',
                    'true': '‚ôªÔ∏è Ugentlig',
                    'TRUE': '‚ôªÔ∏è Ugentlig'
                };
                const recurringBadge = recurringLabels[recurringValue] 
                    ? `<span class="status-badge status-recurring">${recurringLabels[recurringValue]}</span>` 
                    : '';
                const eventDataJson = encodeURIComponent(JSON.stringify(event));
                return `
                <div class="event-item">
                    <div class="event-info">
                        <div class="event-title">${event.Dansetype || 'Ukendt type'} @ ${event.Sted || 'Ukendt sted'}</div>
                        <div class="event-details">
                            üìÖ ${event.Dato || 'Ingen dato'} kl. ${event.Starttid || '?'}<br>
                            üìç ${event.By || 'K√∏benhavn'}<br>
                            üí∞ ${event.Pris || 'Ikke angivet'}
                        </div>
                        <div style="margin-top: 8px;">
                            <span class="status-badge status-pending">Afventer</span>
                            ${recurringBadge}
                        </div>
                    </div>
                    <div class="event-actions">
                        <button class="btn btn-small btn-success" onclick="editPending('${eventDataJson}')">
                            ‚úèÔ∏è Rediger & Godkend
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        // Edit pending event
        function editPending(encodedData) {
            try {
                const event = JSON.parse(decodeURIComponent(encodedData));
                
                document.getElementById('eventId').value = event.EventId || event.eventId || '';
                
                let dateValue = event.Dato || event.dato || '';
                if (dateValue) {
                    const dateMatch = dateValue.toString().match(/(\d{4}-\d{2}-\d{2})/);
                    if (dateMatch) {
                        dateValue = dateMatch[1];
                    }
                }
                document.getElementById('dato').value = dateValue;
                
                document.getElementById('starttid').value = event.Starttid || event.starttid || '20:00';
                document.getElementById('sluttid').value = event.Sluttid || event.sluttid || '';
                
                const dansetype = event.Dansetype || event.dansetype || '';
                const dansetypeSelect = document.getElementById('dansetype');
                for (let option of dansetypeSelect.options) {
                    if (option.value && dansetype.toLowerCase().includes(option.value.toLowerCase())) {
                        dansetypeSelect.value = option.value;
                        break;
                    }
                }
                
                document.getElementById('sted').value = event.Sted || event.sted || '';
                document.getElementById('adresse').value = event.Adresse || event.adresse || '';
                
                const by = event.By || event.by || 'K√∏benhavn';
                const bySelect = document.getElementById('by');
                for (let option of bySelect.options) {
                    if (option.value.toLowerCase() === by.toLowerCase()) {
                        bySelect.value = option.value;
                        break;
                    }
                }
                
                document.getElementById('pris').value = event.Pris || event.pris || '';
                document.getElementById('arrangoer').value = event.Arrang√∏r || event.arrangoer || '';
                document.getElementById('link').value = event.Link || event.link || '';
                
                let recurringValue = event.Recurring || '';
                if (recurringValue === true || recurringValue === 'TRUE' || recurringValue === 'true') {
                    recurringValue = 'weekly';
                }
                document.getElementById('recurring').value = recurringValue;
                
                document.getElementById('submitBtn').innerHTML = '<span>‚úÖ Opdater & Godkend</span>';
                
                switchTab('submit');
                showAlert('Event indl√¶st - rediger og klik "Opdater & Godkend"', 'info');
                
            } catch (error) {
                console.error('Error parsing event data:', error);
                showAlert('Kunne ikke indl√¶se event data', 'error');
            }
        }

        // Quick Paste Parser
        function parseQuickPaste() {
            const text = document.getElementById('quickPasteInput').value.trim();
            if (!text) {
                showAlert('Inds√¶t noget tekst f√∏rst', 'error');
                return;
            }

            const lower = text.toLowerCase();
            const parsed = {
                dato: null,
                starttid: null,
                sluttid: null,
                dansetype: null,
                sted: null,
                adresse: null,
                by: null,
                pris: null,
                arrangoer: null,
                link: null
            };

            // === ARRANG√òR PARSING ===
            // "Begivenhed af X", "Event by X", "Hosted by X"
            const arrangorPatterns = [
                /begivenhed af\s+([^\n]+)/i,
                /event by\s+([^\n]+)/i,
                /hosted by\s+([^\n]+)/i,
                /arrang√∏r[:\s]+([^\n]+)/i,
                /organizer[:\s]+([^\n]+)/i
            ];
            for (const pattern of arrangorPatterns) {
                const match = text.match(pattern);
                if (match) {
                    parsed.arrangoer = match[1].trim();
                    break;
                }
            }

            // === DATO PARSING ===
            const monthMap = {
                'jan': '01', 'januar': '01', 'january': '01',
                'feb': '02', 'februar': '02', 'february': '02',
                'mar': '03', 'marts': '03', 'march': '03',
                'apr': '04', 'april': '04',
                'maj': '05', 'may': '05',
                'jun': '06', 'juni': '06', 'june': '06',
                'jul': '07', 'juli': '07', 'july': '07',
                'aug': '08', 'august': '08',
                'sep': '09', 'sept': '09', 'september': '09',
                'okt': '10', 'oct': '10', 'oktober': '10', 'october': '10',
                'nov': '11', 'november': '11',
                'dec': '12', 'december': '12'
            };

            // "20. december 2024", "d. 20 december", "December 27"
            const datePatterns = [
                /(\d{1,2})\.?\s*(jan|feb|mar|apr|maj|may|jun|jul|aug|sep|sept|okt|oct|nov|dec|januar|februar|marts|march|april|juni|june|juli|july|august|september|oktober|october|november|december)\s*(\d{4})?/i,
                /(jan|feb|mar|apr|maj|may|jun|jul|aug|sep|sept|okt|oct|nov|dec|januar|februar|marts|march|april|juni|june|juli|july|august|september|oktober|october|november|december)\s*(\d{1,2})(?:st|nd|rd|th)?,?\s*(\d{4})?/i
            ];
            
            for (const pattern of datePatterns) {
                const match = text.match(pattern);
                if (match) {
                    let day, month, year;
                    if (match[1].match(/\d/)) {
                        // Format: 20. december
                        day = match[1].padStart(2, '0');
                        month = monthMap[match[2].toLowerCase()];
                        year = match[3] || new Date().getFullYear();
                    } else {
                        // Format: December 27
                        month = monthMap[match[1].toLowerCase()];
                        day = match[2].padStart(2, '0');
                        year = match[3] || new Date().getFullYear();
                    }
                    if (month) {
                        parsed.dato = `${year}-${month}-${day}`;
                        break;
                    }
                }
            }

            // "20/12" or "20-12-2024"
            if (!parsed.dato) {
                const numericDate = text.match(/(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.]?(\d{2,4})?/);
                if (numericDate) {
                    const day = numericDate[1].padStart(2, '0');
                    const month = numericDate[2].padStart(2, '0');
                    let year = numericDate[3] || new Date().getFullYear();
                    if (year.toString().length === 2) year = '20' + year;
                    parsed.dato = `${year}-${month}-${day}`;
                }
            }

            // === TID PARSING (improved) ===
            // Look for program times like "20:30 ‚Äì Doors" or "21:45‚Äì02:00"
            const allTimes = [];
            const timeRegex = /(\d{1,2})[:\.](\d{2})\s*(?:[-‚Äì‚Äî]\s*(\d{1,2})[:\.](\d{2}))?/g;
            let timeMatch;
            while ((timeMatch = timeRegex.exec(text)) !== null) {
                allTimes.push({
                    start: `${timeMatch[1].padStart(2, '0')}:${timeMatch[2]}`,
                    end: timeMatch[3] ? `${timeMatch[3].padStart(2, '0')}:${timeMatch[4]}` : null
                });
            }
            
            // Find earliest start time (likely doors/start)
            if (allTimes.length > 0) {
                // Sort by time to find earliest
                const sortedStarts = allTimes.map(t => t.start).sort();
                parsed.starttid = sortedStarts[0];
                
                // Find the last end time (likely closing)
                const endTimes = allTimes.filter(t => t.end).map(t => t.end);
                if (endTimes.length > 0) {
                    // Handle times like 02:00 (after midnight)
                    parsed.sluttid = endTimes[endTimes.length - 1];
                }
            }

            // === VARIGHED ‚Üí SLUTTID ===
            // "Varighed: 5 t. 30 min." or "Duration: 5 hours"
            if (!parsed.sluttid && parsed.starttid) {
                const varighedMatch = text.match(/varighed[:\s]*(\d+)\s*(?:t\.?|timer?|hours?)\s*(?:(\d+)\s*(?:min\.?|minutter?|minutes?)?)?/i);
                if (varighedMatch) {
                    const hours = parseInt(varighedMatch[1]);
                    const minutes = parseInt(varighedMatch[2] || 0);
                    const [startH, startM] = parsed.starttid.split(':').map(Number);
                    let endH = startH + hours;
                    let endM = startM + minutes;
                    if (endM >= 60) { endH++; endM -= 60; }
                    if (endH >= 24) endH -= 24;
                    parsed.sluttid = `${endH.toString().padStart(2, '0')}:${endM.toString().padStart(2, '0')}`;
                }
            }

            // === DANSETYPE PARSING ===
            const danceTypes = [
                { keywords: ['salsa', 'rueda', 'timba', 'son cubano'], value: 'Salsa' },
                { keywords: ['bachata', 'sensual', 'dominican bachata'], value: 'Bachata' },
                { keywords: ['kizomba', 'kiz', 'semba'], value: 'Kizomba' },
                { keywords: ['zouk'], value: 'Zouk' },
                { keywords: ['tango'], value: 'Tango' },
                { keywords: ['latin mix', 'latin party', 'latin fridays', 'latin social'], value: 'Latin Mix' },
                { keywords: ['workshop', 'kursus', 'class', 'intro class'], value: 'Workshop' },
                { keywords: ['social', 'fest', 'party', 'social dancing'], value: 'Social' }
            ];

            const foundTypes = [];
            for (const type of danceTypes) {
                if (type.keywords.some(kw => lower.includes(kw))) {
                    foundTypes.push(type.value);
                }
            }

            if (foundTypes.includes('Salsa') && foundTypes.includes('Bachata')) {
                parsed.dansetype = 'Salsa & Bachata';
            } else if (foundTypes.length > 0) {
                // Prioritize specific dance types over generic "Social"
                const priority = ['Salsa', 'Bachata', 'Kizomba', 'Zouk', 'Tango', 'Latin Mix', 'Workshop', 'Social'];
                for (const p of priority) {
                    if (foundTypes.includes(p)) {
                        parsed.dansetype = p;
                        break;
                    }
                }
            }

            // === PRIS PARSING (improved) ===
            if (lower.includes('gratis') || lower.includes('free entry') || lower.includes('fri entr√©')) {
                parsed.pris = 'Gratis';
            } else {
                const pricePatterns = [
                    /(?:entrance fee|entry|entr√©|pris)[:\s]*(?:dkk\s*)?(\d+)/i,
                    /dkk\s*(\d+)(?:\s*per\s*person)?/i,
                    /(\d+)\s*(?:dkk|kr\.?)\s*(?:per\s*person)?/i,
                    /(\d+)\s*kr\.?/i
                ];
                for (const pattern of pricePatterns) {
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        parsed.pris = match[1] + ' kr';
                        break;
                    }
                }
                
                // Check for student price too
                const studentMatch = text.match(/(\d+)\s*(?:dkk|kr\.?)?\s*(?:with|med)\s*(?:a\s*)?(?:valid\s*)?student/i);
                if (studentMatch && parsed.pris) {
                    parsed.pris += ` (studerende: ${studentMatch[1]} kr)`;
                }
            }

            // === STED/VENUE PARSING ===
            const knownVenues = [
                { name: 'Kedelhallen', address: 'Nyelandsvej 75A', city: 'Frederiksberg' },
                { name: 'Old Irish Pub', address: 'Vesterbrogade 2D', city: 'K√∏benhavn' },
                { name: 'The Old Irish', address: 'Vesterbrogade 2D', city: 'K√∏benhavn' },
                { name: 'Bachata House', address: '', city: 'K√∏benhavn' },
                { name: 'Copenhagen Salsa Academy', address: '', city: 'K√∏benhavn' },
                { name: 'CSA', address: '', city: 'K√∏benhavn' },
                { name: 'Dansens Hus', address: '', city: 'K√∏benhavn' },
                { name: 'Vega', address: 'Enghavevej 40', city: 'K√∏benhavn' },
                { name: 'Cubansk Danseskole', address: 'Blegdamsvej 104', city: 'K√∏benhavn' },
                { name: 'Krudtt√∏nden', address: 'Serridslevvej 2', city: 'K√∏benhavn' },
                { name: 'Pumpehuset', address: 'Studiestr√¶de 52', city: 'K√∏benhavn' },
                { name: '4Water', address: 'Havnegade 41', city: 'K√∏benhavn' }
            ];

            for (const venue of knownVenues) {
                if (lower.includes(venue.name.toLowerCase())) {
                    parsed.sted = venue.name;
                    if (venue.address) parsed.adresse = venue.address;
                    if (venue.city) parsed.by = venue.city;
                    break;
                }
            }

            // === ADRESSE PARSING (improved) ===
            if (!parsed.adresse) {
                // Match "Nyelandsvej 75A" or "Vesterbrogade 2D, 2000 Frederiksberg"
                const addressMatch = text.match(/([A-Za-z√¶√∏√•√Ü√ò√Ö]+(?:vej|gade|torv|plads|all√©|str√¶de|boulevard|parken)\s+\d+[A-Za-z]?)/i);
                if (addressMatch) {
                    parsed.adresse = addressMatch[1];
                }
            }

            // === BY/CITY PARSING ===
            if (!parsed.by) {
                const cities = ['K√∏benhavn', 'Frederiksberg', 'Amager', 'N√∏rrebro', 'Vesterbro', '√òsterbro', 'Valby'];
                for (const city of cities) {
                    if (lower.includes(city.toLowerCase())) {
                        parsed.by = city;
                        break;
                    }
                }
            }

            // === LINK PARSING ===
            const linkMatch = text.match(/(https?:\/\/[^\s\n]+)/i);
            if (linkMatch) {
                parsed.link = linkMatch[1];
                
                // Try to extract date from URL (bookwhen format: 20251227)
                if (!parsed.dato) {
                    const urlDateMatch = linkMatch[1].match(/(202[4-9])(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])/);
                    if (urlDateMatch) {
                        parsed.dato = `${urlDateMatch[1]}-${urlDateMatch[2]}-${urlDateMatch[3]}`;
                    }
                }
            }

            // === UDFYLD FORMULAR ===
            let filledCount = 0;
            let filledFields = [];

            if (parsed.dato) {
                document.getElementById('dato').value = parsed.dato;
                filledCount++;
                filledFields.push('dato');
            }
            if (parsed.starttid) {
                document.getElementById('starttid').value = parsed.starttid;
                filledCount++;
                filledFields.push('starttid');
            }
            if (parsed.sluttid) {
                document.getElementById('sluttid').value = parsed.sluttid;
                filledCount++;
                filledFields.push('sluttid');
            }
            if (parsed.dansetype) {
                const select = document.getElementById('dansetype');
                for (let option of select.options) {
                    if (option.value === parsed.dansetype || option.value.includes(parsed.dansetype)) {
                        select.value = option.value;
                        filledCount++;
                        filledFields.push('dansetype');
                        break;
                    }
                }
            }
            if (parsed.sted) {
                document.getElementById('sted').value = parsed.sted;
                filledCount++;
                filledFields.push('sted');
            }
            if (parsed.adresse) {
                document.getElementById('adresse').value = parsed.adresse;
                filledCount++;
                filledFields.push('adresse');
            }
            if (parsed.by) {
                const bySelect = document.getElementById('by');
                for (let option of bySelect.options) {
                    if (option.value.toLowerCase() === parsed.by.toLowerCase()) {
                        bySelect.value = option.value;
                        filledCount++;
                        filledFields.push('by');
                        break;
                    }
                }
            }
            if (parsed.pris) {
                document.getElementById('pris').value = parsed.pris;
                filledCount++;
                filledFields.push('pris');
            }
            if (parsed.arrangoer) {
                document.getElementById('arrangoer').value = parsed.arrangoer;
                filledCount++;
                filledFields.push('arrang√∏r');
            }
            if (parsed.link) {
                document.getElementById('link').value = parsed.link;
                filledCount++;
                filledFields.push('link');
            }

            // Feedback
            console.log('Parsed data:', parsed);
            console.log('Filled fields:', filledFields);
            
            if (filledCount > 0) {
                showAlert(`‚úÖ ${filledCount} felter udfyldt: ${filledFields.join(', ')}`, 'success');
                document.getElementById('quickPasteInput').value = '';
            } else {
                showAlert('Kunne ikke finde data i teksten. Pr√∏v et andet format.', 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('dato').value = tomorrow.toISOString().split('T')[0];
        });
    </script>
</body>
</html>
